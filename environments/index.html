<!DOCTYPE html>
<html>
    <head>
	  <meta charset="utf-8">
	  <meta http-equiv="x-ua-compatible" content="ie=edge">
	  <meta name="viewport" content="width=device-width, initial-scale=1">

	  <title>Environments</title>
	  
	  <link rel="shortcut icon" type="image/x-icon" href="/imandra-docs/favicon.ico">
	  <link rel="stylesheet" href="/imandra-docs/css/main.css">
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather+Sans:300,300i,400,400i%7CMerriweather:300,300i,400,400i%7CRoboto+Slab:300,300i,400,400i">

	  <link rel="canonical" href="https://docs.imandra.ai//imandra-docs/environments/">
	  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.1/jquery.min.js"></script>
	  <script type="text/javascript" src = "/imandra-docs/jekyll-resources/assets/scripts/jquery.scrollme.min.js"></script>
	  <script type="text/javascript" src = "/imandra-docs/jekyll-resources/assets/scripts/jquery.sticky.min.js"></script>
	  <script type="text/javascript">
	  	 
		$(document).ready(function(){
			$("#StickMenu").sticky({topSpacing:52});
		});

	  </script>

</head> 


    <body>
	      <div class="TopRowContainer">
	<div class="TopRow">
		<div class="TopNavLogoContainer">
			<a class="TopNavLogoLink" href="https://docs.imandra.ai/">
				<img class="TopNavLogo" src = "/imandra-docs/jekyll-resources/assets/img/imandra_doc_logo_main.svg">
			</a>
		</div>
		<nav class="TopNavContainer">
			<ul class="TopNavList">
				
				 
				
				 
				
				
				
				
				<li class="TopNavListItem"><a class="TopNavLink" href="/imandra-docs/configuration/">Configuration</a></li>
				
				
				 
				
				
				
				
				<li class="TopNavListItem"><a class="TopNavLink" href="/imandra-docs/examples/">Examples</a></li>
				
				
				 
				
				
				
				
				<li class="TopNavListItem"><a class="TopNavLink" href="/imandra-docs/hacking/">Hacking</a></li>
				
				
				 
				
				
				
				
				<li class="TopNavListItem"><a class="TopNavLink" href="/imandra-docs/regionDecomposition/">Region Decomposition</a></li>
				
				
				 
				
				
				
				
				<li class="TopNavListItem"><a class="TopNavLink TopNavLink__Active" href="/imandra-docs/extra/">Further functionality</a></li>
				
				
				
			</ul>
		</nav>
	</div>
</div>

<header class="TemplateHeader">
	<div class="TemplateHeaderImageContainer">
	<a href ="/imandra-docs">
		<img class="SiteSpecificImage" src="/imandra-docs/assets/img/site_specific_image_v_2.svg">
	</a>
	</div>
</header>


	      <main class="MainContentColumn">
		        <article class="ArticleContainer">
			          <!-- Sidebar -->
<div class="SideMenuContainer">
    <div id="StickMenu" class="SideMenu">
        
        
        
        <a href="/imandra-docs/theBasics/">In more detail</a>
        
        <a href="/imandra-docs/pitfalls/">Avoiding Common Mistakes</a>
        
        <a href="/imandra-docs/environments/">Environments</a>
        
        <a href="/imandra-docs/dashingVGs/">Dashing VGs</a>
        
        
    </div>
</div>
<!--MainContent-->
<div class="MainContent">
    <h2>Environments</h2>
    <p>A state of an Imandra session is called an <em>environment</em>. An environment contains type and function definitions, configuration options, verification goals that have been proved, and all other contextual data that govern the evaluation of Imandra commands and directives.</p>

<p>Intuitively, an environment is given by a history of <em>events</em>. This history describes how the initial <em>Ground Zero</em> environment was extended to arise at the current environment. Users typically work in the <em>live</em> environment, performing computations and extending the environment with new definitions and modifications of the Imandra configuration state. However, more fine-grained control over environments is available, including an environment stack, checkpointing and programmatic serialisation and restoration. 
[block:api-header]
{
  “title”: “The Environment Stack”
}
[/block]
The most basic environment management is performed through the <em>environment stack.</em></p>

<p>By default, the environment stack is empty.</p>

<p>Environments can be <em>pushed</em> and <em>popped</em> on and off the stack through the <code class="highlighter-rouge">:push</code> and <code class="highlighter-rouge">:pop</code> directives.</p>

<p>At any time, a description of the environment stack (currently, just its size) can be displayed through the <code class="highlighter-rouge">:stack</code> directive.</p>

<p>Let’s see an example:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            .__      /\ .__                           .___            
     _____  |__|    / / |__| _____ _____    ____    __| _/___________   
     \__  \ |  |   / /  |  |/     \__   \  /    \  / __ |\_  __ \__  \  
      / __ \|  |  / /   |  |  Y Y  \/ __ \|   |  \/ /_/ | |  | \// __ \_
     (____  /__| / /    |__|__|_|  (____  /___|  /\____ | |__|  (____  /
          \/     \/              \/     \/     \/      \/            \/ 
----------------------------------------------------------------------------
 Imandra Commander 0.8a94 - (c)Copyright Aesthetic Integration Ltd, 2014-17
----------------------------------------------------------------------------

# :stack
Environment stack is empty.
# :h
All events in session:
  0.&lt;&lt;Ground Zero&gt;&gt;
# :push
# :stack
Environment stack contains 1 element.
# let f x = x + 1;;
val f : int -&gt; int = &lt;fun&gt;
# :h
All events in session:
  0.&lt;&lt;Ground Zero&gt;&gt;
  1.     Fun: f

# f 10;;
- : int = 11
# instance _ x = f x = 100;;

Instance:
  { x = 99; }

# :pop
# :h
All events in session:
  0.&lt;&lt;Ground Zero&gt;&gt;
# f 10;;
Error: Unbound value f

</code></pre></div></div>

<h4 id="programmatic-stack-manipulation">Programmatic Stack Manipulation</h4>

<p>An API for the environment stack is exposed through the <code class="highlighter-rouge">Reflect.Stack</code> module. This functionality is fully available in <code class="highlighter-rouge">:program</code> mode and can be applied (though not used in definitions) in <code class="highlighter-rouge">:logic</code> mode.</p>

<p>The key functions are:</p>
<ul>
  <li><code class="highlighter-rouge">Reflect.Stack.size : unit -&gt; int</code>,</li>
  <li><code class="highlighter-rouge">Reflect.Stack.push : unit -&gt; unit</code>, and</li>
  <li><code class="highlighter-rouge">Reflect.Stack.pop : unit -&gt; unit</code>.</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Reflect.Stack.push ();;
- : unit = ()
# let f x = x + 1;;
val f : int -&gt; int = &lt;fun&gt;
# theorem _ x = f x &gt; x;;
thm _ = &lt;proved&gt;
# Reflect.Stack.size ();;
- : int = 1
# Reflect.Stack.pop ();;
- : unit = ()
# let f x = x + 2;;
val f : int -&gt; int = &lt;fun&gt;
# theorem _ x = f x &gt; x + 1;;
thm _ = &lt;proved&gt;
# :h
All events in session:

0.&lt;&lt;Ground Zero&gt;&gt;
1.     Fun: f
# Reflect.Stack.size ();;
- : int = 0"

</code></pre></div></div>

<p>We can use these stack manipulation functions in our own <code class="highlighter-rouge">:program</code> mode functions. For example, here is a light-weight way to “safely” evaluate a sequence of IML events and then subsequently throw away the results. Note this <code class="highlighter-rouge">safe_eval</code> is not truly safe as no checking is done to ensure that the evaluated commands do not contain, e.g., <code class="highlighter-rouge">:push</code> or <code class="highlighter-rouge">:pop</code>:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&gt; let safe_eval xs =
  begin
    Reflect.Stack.push ();
    List.iter Reflect.eval xs;
    Reflect.Stack.pop ()
  end
  ;;
  val safe_eval : string list -&gt; unit = &lt;fun&gt;
&gt; :logic
# safe_eval [\"let f x = x + 1;;\"; \"f 10;;\"; \"theorem f_gt x = f x &gt; x;;\"];;

val f : int -&gt; int = &lt;fun&gt;
- : int = 11
thm f_gt = &lt;proved&gt;
- : unit = ()
# :h
All events in session:
0.&lt;&lt;Ground Zero&gt;&gt;

</code></pre></div></div>

<h4 id="environment-checkpoints">Environment Checkpoints</h4>

<p>The live environment may be serialised to disk through the use of the <code class="highlighter-rouge">:checkpoint</code> directive. A checkpoint must be given a name. By default, it is stored in an Imandra system directory which Imandra will automatically search whenever one attempts to restore the checkpoint.</p>

<p>The loading of checkpoints is designed to be a fast, ideally <code class="highlighter-rouge">O(1)</code> operation. We typically “compile” large Imandra models by loading them in a fresh session and checkpointing the session immediately after their loading is complete. While the initial compilation may take some time (30 sec is not uncommon for a FIX venue model), once the checkpoint has been saved, we may then start (potentially simultaneous) Imandra sessions and <code class="highlighter-rouge">:restore</code> the checkpoint in all of them very quickly (e.g., 0.1 sec).</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            .__      /\ .__                           .___            
     _____  |__|    / / |__| _____ _____    ____    __| _/___________   
     \__  \ |  |   / /  |  |/     \__   \  /    \  / __ |\_  __ \__  \  
      / __ \|  |  / /   |  |  Y Y  \/ __ \|   |  \/ /_/ | |  | \// __ \_
     (____  /__| / /    |__|__|_|  (____  /___|  /\____ | |__|  (____  /
          \/     \/              \/     \/     \/      \/            \/ 
----------------------------------------------------------------------------
 Imandra Commander 0.8a94 - (c)Copyright Aesthetic Integration Ltd, 2014-17
----------------------------------------------------------------------------
# type foo = A | B;;
type foo = A | B
# let f = function
  A -&gt; 10
  | B -&gt; 20
;;
val f : foo -&gt; int = &lt;fun&gt;
# :checkpoint foo
- Building checkpoint foo.
- Checkpoint foo built.

To restore this checkpoint from the toplevel, run
:restore foo
- Linking checkpoint foo back into current session.
- Link complete.
</code></pre></div></div>

<p>Now that the checkpoint exists, we may use the <code class="highlighter-rouge">:restore</code> directive to restore it in a fresh session:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            .__      /\ .__                           .___            
     _____  |__|    / / |__| _____ _____    ____    __| _/___________   
     \__  \ |  |   / /  |  |/     \__   \  /    \  / __ |\_  __ \__  \  
      / __ \|  |  / /   |  |  Y Y  \/ __ \|   |  \/ /_/ | |  | \// __ \_
     (____  /__| / /    |__|__|_|  (____  /___|  /\____ | |__|  (____  /
          \/     \/              \/     \/     \/      \/            \/ 
----------------------------------------------------------------------------
 Imandra Commander 0.8a94 - (c)Copyright Aesthetic Integration Ltd, 2014-17
----------------------------------------------------------------------------
# :restore foo
Checkpoint foo restored.
# :h
All events in session:

0.&lt;&lt;Ground Zero&gt;&gt;
1.  Type: foo
2.  Fun: f

# f A;;
- : int = 10
# instance _ x = f x = 20;;

Instance:

  { x = B; }

</code></pre></div></div>
<p>By default, <code class="highlighter-rouge">:checkpoint</code> will overwrite a checkpoint of the same name, if one exists. To block this overwriting, give <code class="highlighter-rouge">:checkpoint</code> an extra argument of <code class="highlighter-rouge">false</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># :checkpoint foo false
Error: Checkpoint foo already exists (overwrite=false).
</code></pre></div></div>

<h4 id="programmatic-checkpoint-manipulation">Programmatic Checkpoint Manipulation</h4>

<p>The checkpointing functions are available through the <code class="highlighter-rouge">Reflect</code> API.</p>

<p>The key functions are:</p>
<ul>
  <li><code class="highlighter-rouge">Reflect.checkpoint : ?overwrite:bool -&gt; string -&gt; unit</code></li>
  <li><code class="highlighter-rouge">Reflect.restore : string -&gt; unit</code></li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            .__      /\ .__                           .___            
     _____  |__|    / / |__| _____ _____    ____    __| _/___________   
     \__  \ |  |   / /  |  |/     \__   \  /    \  / __ |\_  __ \__  \  
      / __ \|  |  / /   |  |  Y Y  \/ __ \|   |  \/ /_/ | |  | \// __ \_
     (____  /__| / /    |__|__|_|  (____  /___|  /\____ | |__|  (____  /
          \/     \/              \/     \/     \/      \/            \/ 
----------------------------------------------------------------------------
 Imandra Commander 0.8a94 - (c)Copyright Aesthetic Integration Ltd, 2014-17
----------------------------------------------------------------------------
# Reflect.checkpoint;;
- : ?overwrite:bool -&gt; string -&gt; unit = &lt;fun&gt;
# Reflect.checkpoint "foo";;
- Building checkpoint foo.
- Checkpoint foo built.

To restore this checkpoint from the toplevel, run
  :restore foo

- Linking checkpoint foo back into current session.
- Link complete.
- : unit = ()
# Reflect.checkpoint ~overwrite:false "foo\;;
Exception:
  Version.Unsupported "Checkpoint foo already exists (overwrite=false).".

# Reflect.restore "foo";;
Checkpoint foo restored.
- : unit = ()

</code></pre></div></div>

<h4 id="exporting-and-importing-checkpoints">Exporting and Importing Checkpoints</h4>

<p>By default, checkpoints are created and stored in a system-wide Imandra directory. Facilities for exporting and importing checkpoints are provided through the <code class="highlighter-rouge">Reflect</code> API. Exported checkpoints are version-sensitive: they may only be imported by installations of the same version of Imandra that was used to create them.</p>

<p>The relevant functions are:</p>

<ul>
  <li><code class="highlighter-rouge">Reflect.export : string -&gt; string -&gt; unit</code></li>
  <li><code class="highlighter-rouge">Reflect.import : string -&gt; unit</code></li>
</ul>

<p><code class="highlighter-rouge">Reflect.export "foo.icp" "foo"</code> will export an existing checkpoint named <code class="highlighter-rouge">foo</code> into the file <code class="highlighter-rouge">foo.icp</code> in the current directory.</p>

<p><code class="highlighter-rouge">Reflect.import "foo.icp"</code> will import the checkpoint <code class="highlighter-rouge">foo</code> from the file <code class="highlighter-rouge">foo.icp</code>. When a checkpoint is imported, it is installed in the system directory and is then made available to all Imandra instances in the same environment.</p>

<p>There are no restrictions on the export filenames. However, the name of the exported checkpoint (e.g., <code class="highlighter-rouge">foo</code>) is stable and not affected by the export filename.</p>

<p>Let us see an example:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            .__      /\ .__                           .___            
     _____  |__|    / / |__| _____ _____    ____    __| _/___________   
     \__  \ |  |   / /  |  |/     \__   \  /    \  / __ |\_  __ \__  \  
      / __ \|  |  / /   |  |  Y Y  \/ __ \|   |  \/ /_/ | |  | \// __ \_
     (____  /__| / /    |__|__|_|  (____  /___|  /\____ | |__|  (____  /
          \/     \/              \/     \/     \/      \/            \/ 
----------------------------------------------------------------------------
 Imandra Commander 0.8a94 - (c)Copyright Aesthetic Integration Ltd, 2014-17
----------------------------------------------------------------------------
# let f x = x + 1;;
val f : int -&gt; int = &lt;fun&gt;
# let g x = f x + 2;;
val g : int -&gt; int = &lt;fun&gt;
# :checkpoint foo
- Building checkpoint foo.
- Checkpoint foo built.

To restore this checkpoint from the toplevel, run
:restore foo

- Linking checkpoint foo back into current session.
- Link complete.
# Reflect.export \"example.icp\" \"foo\";;
- : unit = ()
</code></pre></div></div>

<p>We can view the exported file in the current directory:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-lh</span> example.icp
<span class="nt">-rw-r--r--</span>  1 grant  staff    34M Jun 20 18:15 example.icp
</code></pre></div></div>

<p>And we can then start a fresh session and import the checkpoint. Once it’s imported, it is made available to all Imandra sessions running in the same environment, just the same as if it had been obtained through a <code class="highlighter-rouge">:checkpoint</code> directive.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            .__      /\ .__                           .___            
     _____  |__|    / / |__| _____ _____    ____    __| _/___________   
     \__  \ |  |   / /  |  |/     \__   \  /    \  / __ |\_  __ \__  \  
      / __ \|  |  / /   |  |  Y Y  \/ __ \|   |  \/ /_/ | |  | \// __ \_
     (____  /__| / /    |__|__|_|  (____  /___|  /\____ | |__|  (____  /
          \/     \/              \/     \/     \/      \/            \/ 
----------------------------------------------------------------------------
 Imandra Commander 0.8a94 - (c)Copyright Aesthetic Integration Ltd, 2014-17
----------------------------------------------------------------------------
 # Reflect.import "example.icp";;
 Archive contains checkpoint foo.
 Importing foo.exe
 Importing foo.exe.dx86cl64
 Importing foo.ims
 Checkpoint foo imported, ready to be restored.
 - : unit = ()
</code></pre></div></div>

<p>Thus, we may then restore it, either through <code class="highlighter-rouge">:restore</code> or <code class="highlighter-rouge">Reflect.restore</code>:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># Reflect.restore "foo";;
Checkpoint foo restored.
- : unit = ()
# :h
All events in session:
0.&lt;&lt;Ground Zero&gt;&gt;
1.     Fun: f
2.     Fun: g
# instance _ x = g x = 10;;

Instance:

{ x = 7; }
# g CX.x;;

- : int = 10
</code></pre></div></div>

</div>
		        </article>
	      </main>
	      <footer class="Footer">
	  <a class="Copyrights"href="http://imandra.ai">&#9400; 2018 Aesthetic Integration Ltd. All rights reserved.</a>
</footer>

    </body>

</html>
