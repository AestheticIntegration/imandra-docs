<!DOCTYPE html>
<html>
    <head><meta charset="utf-8" />
        <meta content="width=device-width, initial-scale=1.0" name="viewport">
        <title>Imandra Documentation - Analysing the UBS ATS Dark Pool</title>
        <meta property="og:url" content="https://docs.imandra.ai/imandra-docs/notebooks/ubs-case-study/">
        <meta property="og:type" content="website">
        <meta property="og:title" content="Imandra Documentation - Analysing the UBS ATS Dark Pool">
        <meta property="og:description" content="In this notebook, we model the order priority logic of the UBS ATS dark pool as described in UBS's June 1st 2015 Form ATS submission to the SEC and analyse it using Imandra. We observe that as described, the order priority logic suffers from a fundamental flaw: the order ranking function is not transitive.">
        <meta property="og:image" content="https://storage.googleapis.com/imandra-assets/images/og_image_default_i78.jpg">


        
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-116937440-6"></script>
        <script>
         window.dataLayer = window.dataLayer || [];
         function gtag(){dataLayer.push(arguments);}
         gtag('js', new Date());

         gtag('config', 'UA-116937440-1');
        </script>
        <script type="text/javascript"> var sc_project=11767520; var sc_invisible=1; var sc_security="fa7e88d1"; </script>
        <script type="text/javascript" src="https://www.statcounter.com/counter/counter.js" async></script>
        <noscript><div class="statcounter">
            <a title="Web Analytics" href="http://statcounter.com/" target="_blank">
                <img class="statcounter" src="//c.statcounter.com/11767520/0/fa7e88d1/1/" alt="Web Analytics"></a>
        </div></noscript>
        

        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.js"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.10/require.min.js"></script>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather+Sans:300,300i,400,400i%7CMerriweather:300,300i,400,400i%7CRoboto+Slab:300,300i,400,400i">

        <link rel="stylesheet" href="/imandra-docs/static/style/style.min.c7df16ea.css" type="text/css">
        <link rel="stylesheet" href="/imandra-docs/static/nbextensions/nbimandra/styles.b466ce6f.css" type="text/css">
        <link rel="stylesheet" href="/imandra-docs/static/docs-styles.b9de737f.css" type="text/css">
        
        <link rel="stylesheet" href="/imandra-docs/static/jekyll-styles.691e8f5f.css" type="text/css">
        
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/docsearch.js@2/dist/cdn/docsearch.min.css" />

        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
        <script src="/imandra-docs/static/nbimandra-rjs-bundle.b85e58fd.js"></script>

        <style type="text/css">
         .highlight .hll { background-color: #ffffcc }
         .highlight  { background: #f8f8f8; }
         .highlight .c { color: #408080; font-style: italic } /* Comment */
         .highlight .err { border: 1px solid #FF0000 } /* Error */
         .highlight .k { color: #008000; font-weight: bold } /* Keyword */
         .highlight .o { color: #666666 } /* Operator */
         .highlight .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
         .highlight .cm { color: #408080; font-style: italic } /* Comment.Multiline */
         .highlight .cp { color: #BC7A00 } /* Comment.Preproc */
         .highlight .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
         .highlight .c1 { color: #408080; font-style: italic } /* Comment.Single */
         .highlight .cs { color: #408080; font-style: italic } /* Comment.Special */
         .highlight .gd { color: #A00000 } /* Generic.Deleted */
         .highlight .ge { font-style: italic } /* Generic.Emph */
         .highlight .gr { color: #FF0000 } /* Generic.Error */
         .highlight .gh { color: #000080; font-weight: bold } /* Generic.Heading */
         .highlight .gi { color: #00A000 } /* Generic.Inserted */
         .highlight .go { color: #888888 } /* Generic.Output */
         .highlight .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
         .highlight .gs { font-weight: bold } /* Generic.Strong */
         .highlight .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
         .highlight .gt { color: #0044DD } /* Generic.Traceback */
         .highlight .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
         .highlight .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
         .highlight .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
         .highlight .kp { color: #008000 } /* Keyword.Pseudo */
         .highlight .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
         .highlight .kt { color: #B00040 } /* Keyword.Type */
         .highlight .m { color: #666666 } /* Literal.Number */
         .highlight .s { color: #BA2121 } /* Literal.String */
         .highlight .na { color: #7D9029 } /* Name.Attribute */
         .highlight .nb { color: #008000 } /* Name.Builtin */
         .highlight .nc { color: #0000FF; font-weight: bold } /* Name.Class */
         .highlight .no { color: #880000 } /* Name.Constant */
         .highlight .nd { color: #AA22FF } /* Name.Decorator */
         .highlight .ni { color: #999999; font-weight: bold } /* Name.Entity */
         .highlight .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
         .highlight .nf { color: #0000FF } /* Name.Function */
         .highlight .nl { color: #A0A000 } /* Name.Label */
         .highlight .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
         .highlight .nt { color: #008000; font-weight: bold } /* Name.Tag */
         .highlight .nv { color: #19177C } /* Name.Variable */
         .highlight .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
         .highlight .w { color: #bbbbbb } /* Text.Whitespace */
         .highlight .mb { color: #666666 } /* Literal.Number.Bin */
         .highlight .mf { color: #666666 } /* Literal.Number.Float */
         .highlight .mh { color: #666666 } /* Literal.Number.Hex */
         .highlight .mi { color: #666666 } /* Literal.Number.Integer */
         .highlight .mo { color: #666666 } /* Literal.Number.Oct */
         .highlight .sa { color: #BA2121 } /* Literal.String.Affix */
         .highlight .sb { color: #BA2121 } /* Literal.String.Backtick */
         .highlight .sc { color: #BA2121 } /* Literal.String.Char */
         .highlight .dl { color: #BA2121 } /* Literal.String.Delimiter */
         .highlight .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
         .highlight .s2 { color: #BA2121 } /* Literal.String.Double */
         .highlight .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
         .highlight .sh { color: #BA2121 } /* Literal.String.Heredoc */
         .highlight .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
         .highlight .sx { color: #008000 } /* Literal.String.Other */
         .highlight .sr { color: #BB6688 } /* Literal.String.Regex */
         .highlight .s1 { color: #BA2121 } /* Literal.String.Single */
         .highlight .ss { color: #19177C } /* Literal.String.Symbol */
         .highlight .bp { color: #008000 } /* Name.Builtin.Pseudo */
         .highlight .fm { color: #0000FF } /* Name.Function.Magic */
         .highlight .vc { color: #19177C } /* Name.Variable.Class */
         .highlight .vg { color: #19177C } /* Name.Variable.Global */
         .highlight .vi { color: #19177C } /* Name.Variable.Instance */
         .highlight .vm { color: #19177C } /* Name.Variable.Magic */
         .highlight .il { color: #666666 } /* Literal.Number.Integer.Long */
        </style>

        <!-- Loading mathjax macro -->
        <!-- Load mathjax -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-MML-AM_CHTML-full,Safe"> </script>
    <!-- MathJax configuration -->
    <script type="text/x-mathjax-config">
    init_mathjax = function() {
        if (window.MathJax) {
        // MathJax loaded
            MathJax.Hub.Config({
                TeX: {
                    equationNumbers: {
                    autoNumber: "AMS",
                    useLabelIds: true
                    }
                },
                tex2jax: {
                    inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                    displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
                    processEscapes: true,
                    processEnvironments: true
                },
                displayAlign: 'center',
                CommonHTML: {
                    linebreaks: { 
                    automatic: true 
                    }
                },
                "HTML-CSS": {
                    linebreaks: { 
                    automatic: true 
                    }
                }
            });
        
            MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
        }
    }
    init_mathjax();
    </script>
    <!-- End of mathjax configuration --><script>
  function handleCopyClick() {
      var el = this;
      var terminal = el.closest('.terminal');
      var highlight = terminal.getElementsByClassName('highlight')[0];
      copyToClipboardMsg(highlight);

      terminal.classList.add('terminal--hide');
      setTimeout(function () {
          terminal.classList.remove('terminal--hide');
      }, 2000);


      function copyToClipboardMsg(elem) {
          var succeed = copyToClipboard(elem);
          var msg;
          if (!succeed) {
              msg = 'Error!';
          } else {
              msg = 'Copied!';
          }

          var msgElem = terminal.querySelector('.terminal__copy-msg');
          msgElem.innerHTML = msg;
          setTimeout(function () {
              msgElem.innerHTML = 'You rock!';
          }, 1000);
      }

      function copyToClipboard(elem) {
          // create hidden text element, if it doesn't already exist
          var targetId = '_hiddenCopyText_';
          var isInput = elem.tagName === 'INPUT' || elem.tagName === 'TEXTAREA';
          var origSelectionStart, origSelectionEnd;
          if (isInput) {
              // can just use the original source element for the selection and copy
              target = elem;
              origSelectionStart = elem.selectionStart;
              origSelectionEnd = elem.selectionEnd;
          } else {
              // must use a temporary form element for the selection and copy
              target = terminal.querySelector('#' + targetId);
              if (!target) {
                  var target = document.createElement('textarea');
                  // target.style.display = 'flex';
                  // target.style.position = 'absolute';
                  // target.style.left = '-1000%';
                  target.id = targetId;
                 elem.appendChild(target);
              }
              target.textContent = elem.textContent.trim();
          }

          // select the content
          var currentFocus = document.activeElement;
          target.focus();
          target.setSelectionRange(0, target.value.length);

          // copy the selection
          var succeed;
          try {
              succeed = document.execCommand('copy');
          } catch (e) {
              succeed = false;
          }
          // restore original focus
          if (currentFocus && typeof currentFocus.focus === 'function') {
              currentFocus.focus();
          }

          if (isInput) {
              // restore prior selection
              elem.setSelectionRange(origSelectionStart, origSelectionEnd);
          } else {
              // clear temporary content
              elem.removeChild(target);
          }
          return succeed;
      }
  }
</script>
    </head>
    <body>
        <div class="background">
        </div>
        <div class="page-container">
            <main class="main-content-column">
                <!-- Jupyter (Imandra core docs) version -->
<header class="header">
    <div class="top-row-container">
        <div class="top-row">

            <div id="toggler--left" class="side__left-menu-toggler">
                <div class="side__toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <p class="side__toggle-text">Docs</p>
            </div>

            <div class="side__logo-container">
                <a class="side__logo-link" href="/">
                    <img class="side__logo " src = "/imandra-docs/jekyll-resources/assets/img/imandra-gradient-logo-docs.svg" alt="Imandra Logo" title="Imandra Logo">
                    <img class="side__logo--min " src="/imandra-docs/jekyll-resources/assets/img/imandra-gradient-logo-min.svg" alt="Imandra Logo" title="Imandra Logo">

                </a>
            </div>

            <div id="toggler--right" class="side__right-menu-toggler">
                <p class="side__toggle-text">Pages</p>
                <div class="side__toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>

            <nav id="side-nav-menu" class="side__nav-container side__nav-container--hidden">
                <ul class="side__nav-list">
                    
                    <li class="side__nav-list-item">
                        <a class="side__nav-link" href="/">Documentation Home</a>
                        
                    </li>
                    
                    <li class="side__nav-list-item">
                        <a class="side__nav-link side__nav-link--active" href="/imandra-docs">Imandra Core</a>
                        
                        <ul class="side__nav-list--sub-level-1">
                            
                            <li class="side__nav-list-item--sub-level-1 side__nav-list--sub-level-1--empty">
                                
                                <a class="side__nav-link" href="/imandra-docs/notebooks/welcome">A quick tour</a>
                                
                                <ul class="side__nav-list--sub-level-2 ">
                                    
                                    
                                    
                                    
                                        
                                        
                                        
                                        
                                    
                                </ul>
                                
                            </li>
                            
                            <li class="side__nav-list-item--sub-level-1 ">
                                
                                <a class="side__nav-link" href="/imandra-docs/notebooks/installation">Installation</a>
                                
                                <ul class="side__nav-list--sub-level-2 ">
                                    
                                    
                                    
                                    
                                        
                                        
                                        
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/installation-simple">Installer</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/installation-manual-opam">Manual (opam)</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/installation-docker">Docker Image</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/installation-jupyter">Jupyter Notebook</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/installation-vscode">VSCode</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/installation-server-image">Server Image</a>
                                            
                                            
                                            
                                        </li>
                                        
                                    
                                </ul>
                                
                            </li>
                            
                            <li class="side__nav-list-item--sub-level-1 side__nav-list--sub-level-1--empty">
                                
                                <a class="side__nav-link" href="/imandra-docs/notebooks/logic-and-program-modes">Logic and Program modes</a>
                                
                                <ul class="side__nav-list--sub-level-2 ">
                                    
                                    
                                    
                                    
                                        
                                        
                                        
                                        
                                    
                                </ul>
                                
                            </li>
                            
                            <li class="side__nav-list-item--sub-level-1 ">
                                
                                <a class="side__nav-link" href="/imandra-docs/notebooks/verification">Verification</a>
                                
                                <ul class="side__nav-list--sub-level-2 ">
                                    
                                    
                                    
                                    
                                        
                                        
                                        
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/verification-commands">Commands</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/verification-attributes">Attributes</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/verification-unrolling">Unrolling</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/verification-simplification">Simplification</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/verification-blast">Blast</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/verification-induction">Induction</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/verification-waterfall">Waterfall</a>
                                            
                                            
                                            
                                        </li>
                                        
                                    
                                </ul>
                                
                            </li>
                            
                            <li class="side__nav-list-item--sub-level-1 side__nav-list--sub-level-1--empty">
                                
                                <a class="side__nav-link" href="/imandra-docs/notebooks/proving-program-termination">Proving program termination</a>
                                
                                <ul class="side__nav-list--sub-level-2 ">
                                    
                                    
                                    
                                    
                                        
                                        
                                        
                                        
                                    
                                </ul>
                                
                            </li>
                            
                            <li class="side__nav-list-item--sub-level-1 ">
                                
                                <a class="side__nav-link" href="/imandra-docs/notebooks/decomposition">Region Decomposition</a>
                                
                                <ul class="side__nav-list--sub-level-2 ">
                                    
                                    
                                    
                                    
                                        
                                        
                                        
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/decomposition-intro">Background to decomposition</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/imandra-tools-intro">Imandra tools introduction</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/idf">Iterative Decomposition Framework</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/region-probabilities">Region Probabilities</a>
                                            
                                            
                                            
                                        </li>
                                        
                                    
                                </ul>
                                
                            </li>
                            
                            <li class="side__nav-list-item--sub-level-1 side__nav-list--sub-level-1--empty">
                                
                                <a class="side__nav-link" href="/imandra-docs/notebooks/loading-files">Multifile development</a>
                                
                                <ul class="side__nav-list--sub-level-2 ">
                                    
                                    
                                    
                                    
                                        
                                        
                                        
                                        
                                    
                                </ul>
                                
                            </li>
                            
                            <li class="side__nav-list-item--sub-level-1 side__nav-list--sub-level-1--empty">
                                
                                <a class="side__nav-link" href="/imandra-docs/notebooks/extracting-ocaml-modules-with-imandra-extract">Extracting OCaml modules</a>
                                
                                <ul class="side__nav-list--sub-level-2 ">
                                    
                                    
                                    
                                    
                                        
                                        
                                        
                                        
                                    
                                </ul>
                                
                            </li>
                            
                            <li class="side__nav-list-item--sub-level-1 side__nav-list--sub-level-1--empty">
                                
                                <a class="side__nav-link" href="/imandra-docs/notebooks/plugins">Code generation and plugins</a>
                                
                                <ul class="side__nav-list--sub-level-2 ">
                                    
                                    
                                    
                                    
                                        
                                        
                                        
                                        
                                    
                                </ul>
                                
                            </li>
                            
                            <li class="side__nav-list-item--sub-level-1 side__nav-list--sub-level-1--empty">
                                
                                <a class="side__nav-link" href="/imandra-docs/notebooks/reflection">Reflection of terms</a>
                                
                                <ul class="side__nav-list--sub-level-2 ">
                                    
                                    
                                    
                                    
                                        
                                        
                                        
                                        
                                    
                                </ul>
                                
                            </li>
                            
                            <li class="side__nav-list-item--sub-level-1 side__nav-list--sub-level-1--empty">
                                
                                <a class="side__nav-link" href="/imandra-docs/notebooks/imandravs">Imandra vs.</a>
                                
                                <ul class="side__nav-list--sub-level-2 ">
                                    
                                    
                                    
                                    
                                        
                                        
                                        
                                        
                                    
                                </ul>
                                
                            </li>
                            
                            <li class="side__nav-list-item--sub-level-1 ">
                                
                                <a class="side__nav-link" href="/imandra-docs/notebooks/examples">Examples</a>
                                
                                <ul class="side__nav-list--sub-level-2  side__nav-list--sub-level-2--active">
                                    
                                    
                                    
                                    
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                        <span class="side__nav-link side__nav-link--minisec">Beginner</span>
                                        </li>
                                        
                                        
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/webservice-auth-logic">Analysing Web-app authentication logic</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/simple-vehicle-controller">Simple vehicle controller</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/simple-stoplight-model">Simple car intersection model</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/reasonml-tic-tac-toe">Tic Tac Toe with ReasonML</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/reasonml-facetime-state-machines">Exploring The Apple FaceTime Bug with ReasonML State Machines</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/crossing-river-safely">Crossing the river safely</a>
                                            
                                            
                                            
                                        </li>
                                        
                                    
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                        <span class="side__nav-link side__nav-link--minisec">Intermediate</span>
                                        </li>
                                        
                                        
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link side__nav-link--active" href="/imandra-docs/notebooks/ubs-case-study">Analysing the UBS ATS Dark Pool</a>
                                            
                                            
                                            
                                            <div class="side__within-page-nav--sub-level-2">
                                            
  
  
  
  <a class="side__nav-link--within-page side__nav-link--within-page--h2" href="#UBS-Future-of-Finance-Challenge---First-Place-Winner">UBS Future of Finance Challenge - First Place Winner</a>
  
  
  
  <a class="side__nav-link--within-page side__nav-link--within-page--h1" href="#An-Imandra-Formal-Model-of-UBS-ATS-Order-Priority-Logic">An Imandra Formal Model of UBS ATS Order Priority Logic</a>
  
  
  
  <a class="side__nav-link--within-page side__nav-link--within-page--h2" href="#Aside:-Custom-Document-Printers">Aside: Custom Document Printers</a>
  
  
  
  <a class="side__nav-link--within-page side__nav-link--within-page--h1" href="#Time,-Price-and-Static-Data">Time, Price and Static Data</a>
  
  
  
  <a class="side__nav-link--within-page side__nav-link--within-page--h1" href="#Order-types">Order types</a>
  
  
  
  <a class="side__nav-link--within-page side__nav-link--within-page--h2" href="#Section-2-of-the-Form-ATS-defines-the-order-types-as-follows:">Section 2 of the Form ATS defines the order types as follows:</a>
  
  
  
  <a class="side__nav-link--within-page side__nav-link--within-page--h1" href="#Capacity,-Eligibilities-and-Crossing-Restrictions">Capacity, Eligibilities and Crossing Restrictions</a>
  
  
  
  <a class="side__nav-link--within-page side__nav-link--within-page--h1" href="#Orders">Orders</a>
  
  
  
  <a class="side__nav-link--within-page side__nav-link--within-page--h1" href="#Determining-how-much-and-at-what-price-two-orders-may-trade">Determining how much and at what price two orders may trade</a>
  
  
  
  <a class="side__nav-link--within-page side__nav-link--within-page--h1" href="#Crossing-Restrictions">Crossing Restrictions</a>
  
  
  
  <a class="side__nav-link--within-page side__nav-link--within-page--h1" href="#Order-Book">Order Book</a>
  
  
  
  <a class="side__nav-link--within-page side__nav-link--within-page--h2" href="#Ranking-functions-for-orders">Ranking functions for orders</a>
  
  
  
  <a class="side__nav-link--within-page side__nav-link--within-page--h1" href="#Extending-the-model-with-Document-printers">Extending the model with Document printers</a>
  
  
                                            </div>
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/six-swiss-exchange-pricing">Region Decomposition - Exchange Pricing</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/verifying-an-ros-node">Creating and Verifying a ROS Node</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/key-pair-security">Key Pair Security in Imandra</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/sudoku">Solving Sudoku with Imandra</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/solver-synthesis">Synthesising a game solver in Imandra</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/exchange-implied-trading">Exchange Implied Trading</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/school-scheduler">Solving school scheduling during COVID</a>
                                            
                                            
                                            
                                        </li>
                                        
                                    
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                        <span class="side__nav-link side__nav-link--minisec">Advanced</span>
                                        </li>
                                        
                                        
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/recursion-induction-and-rewriting">Recursion, Induction and Rewriting</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/verifying-merge-sort">Verifying merge sort in Imandra</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/ripple-carry-adder">Verifying a Ripple Carry Adder</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/region-probabilities-example">Calculating Region Probabilities</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/supervised-learning">Analysing Machine Learning Models</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/probabilistic-reasoning-in-reasonml">Probabilistic Reasoning in ReasonML</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/notebooks/a-comparison-with-tla-plus">A comparison with TLA+</a>
                                            
                                            
                                            
                                        </li>
                                        
                                    
                                </ul>
                                
                            </li>
                            
                            <li class="side__nav-list-item--sub-level-1 ">
                                
                                <a class="side__nav-link" href="/imandra-docs/notebooks/reference">Reference</a>
                                
                                <ul class="side__nav-list--sub-level-2 ">
                                    
                                    
                                    
                                    
                                        
                                        
                                        
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/odoc/imandra-base/Imandra_prelude/">Standard Library</a>
                                            
                                            
                                            
                                        </li>
                                        
                                        <li class="side__nav-list-item--sub-level-2 side__nav-list--sub-level-2--empty">
                                            
                                            <a class="side__nav-link" href="/imandra-docs/odoc/">API Docs</a>
                                            
                                            
                                            
                                        </li>
                                        
                                    
                                </ul>
                                
                            </li>
                            
                        </ul>
                        
                    </li>
                    
                    <li class="side__nav-list-item">
                        <a class="side__nav-link" href="/idf-py">Py IDF</a>
                        
                    </li>
                    
                    <li class="side__nav-list-item">
                        <a class="side__nav-link" href="/ipl">Imandra Protocol Language</a>
                        
                    </li>
                    
                    <li class="side__nav-list-item">
                        <a class="side__nav-link" href="/imandra-rule-synth">Imandra Rule Synth</a>
                        
                    </li>
                    
                    <li class="side__nav-list-item">
                        <a class="side__nav-link" href="/fix-engine">FIX Engine</a>
                        
                    </li>
                    
                </ul>
            </nav>
        </div>
    </div>

    <div class="background">
    </div>



    <div class="template-header">
        <div class="top-bar">
            <div class="side__nav-search">
                <input id="search" type="search" placeholder="Search">
                <div class="side__nav-search-icon">
                    <i class="fa fa-search"></i>
                </div>
            </div>

            <nav class="top-bar__nav-container" id="top-menu">
                <a href="#" class="top-bar__toggle">≡</a>
                <div class="top-nav-bar__group ">
                    <div class="top-nav-bar__nav nav-bar--blue top-nav-bar__nav--hidden">
                        <ul class="top-nav-bar__links top-nav-bar__links--hidden-smaller-than-tablet">



                            <li class="top-nav-bar__item top-nav-bar__item--flex">
                                <a href="https://www.imandra.ai/" class="top-nav-bar__link">Home</a>
                            </li>

                            <li class="top-nav-bar__item top-nav-bar__item--group dropdown--applications">
                                <p class="top-nav-bar__link top-nav-bar__link--group" onclick="">Applications</p>
                                <ul class="dropdown-content dropdown-content--applications">
                                    <li class="dropdown__item dropdown__item--with-icon">
                                        <img class="dropdown__icon" src="/imandra-docs/jekyll-resources/assets/img/icon--menu--fv.svg" alt="Formal Verification" title="Formal Verification Icon">
                                        <a class="dropdown__link" href="https://www.imandra.ai/app-fv">Formal Verification</a>
                                    </li>
                                    <li class="dropdown__item dropdown__item--with-icon">
                                        <img class="dropdown__icon" src="/imandra-docs/jekyll-resources/assets/img/icon--menu--mbse.svg" alt="Model-Based Software Engineering" title="Model-Based Software Engineering Icon">
                                        <a class="dropdown__link" href="https://www.imandra.ai/app-mbse">Model-Based Software Engineering</a>
                                    </li>
                                    <li class="dropdown__item dropdown__item--with-icon">
                                        <img class="dropdown__icon" src="/imandra-docs/jekyll-resources/assets/img/icon--menu--si.svg" alt="IPL Demo Gallery" title="System Integration Icon">
                                        <a class="dropdown__link dropdown__link--last" href="https://www.imandra.ai/app-si">System Integration</a>
                                    </li>
                                </ul>
                            </li>

                            <li class="top-nav-bar__item top-nav-bar__item--group dropdown--explore">
                                <p class="top-nav-bar__link top-nav-bar__link--group" onclick="">Explore</p>
                                <ul class="dropdown-content dropdown-content--explore">
                                    <li class="dropdown__item dropdown__item--with-icon">
                                        <img class="dropdown__icon" src="/imandra-docs/jekyll-resources/assets/img/icon--menu--core.svg" alt="Try Imandra" title="Try Imandra Icon">
                                        <a class="dropdown__link" href="https://try.imandra.ai/">Try Online</a>
                                    </li>
                                    <li class="dropdown__item dropdown__item--with-icon">
                                        <img class="dropdown__icon" src="/imandra-docs/jekyll-resources/assets/img/icon--menu--demos.svg" alt="Imandra Demo Gallery" title="Imandra Demo Gallery Icon">
                                        <a class="dropdown__link" href="https://www.imandra.ai/demos">Demo Gallery</a>
                                    </li>
                                    <li class="dropdown__item dropdown__item--with-icon">
                                        <img class="dropdown__icon" src="/imandra-docs/jekyll-resources/assets/img/icon--menu--demos.svg" alt="IPL Demo Gallery" title="IPL Gallery Icon">
                                        <a class="dropdown__link dropdown__link--last" href="https://www.imandra.ai/ipl-gallery">IPL Gallery</a>
                                    </li>
                                </ul>
                            </li>




                            <li class="top-nav-bar__item top-nav-bar__item--group dropdown--docs">
                                <p class="top-nav-bar__link top-nav-bar__link--group" onclick="">Docs</p>
                                <ul class="dropdown-content dropdown-content--docs">
                                    <li class="dropdown__item dropdown__item--with-icon">
                                        <img class="dropdown__icon" src="/imandra-docs/jekyll-resources/assets/img/icon--menu--docs.svg" alt="Docs" title="Docs Icon">
                                        <a class="dropdown__link" href="https://docs.imandra.ai/imandra-docs/">Imandra Core</a>
                                    </li>
                                    <li class="dropdown__item dropdown__item--with-icon">
                                        <img class="dropdown__icon" src="/imandra-docs/jekyll-resources/assets/img/icon--menu--docs.svg" alt="Docs" title="Docs Icon">
                                        <a class="dropdown__link" href="https://docs.imandra.ai/idf-py/">PYIDF</a>
                                    </li>
                                    <li class="dropdown__item dropdown__item--with-icon">
                                        <img class="dropdown__icon" src="/imandra-docs/jekyll-resources/assets/img/icon--menu--docs.svg" alt="Docs" title="Docs Icon">
                                        <a class="dropdown__link" href="https://docs.imandra.ai/ipl/">IPL</a>
                                    </li>
                                    <li class="dropdown__item dropdown__item--with-icon">
                                        <img class="dropdown__icon" src="/imandra-docs/jekyll-resources/assets/img/icon--menu--docs.svg" alt="Docs" title="Docs Icon">
                                        <a class="dropdown__link" href="https://docs.imandra.ai/imandra-rule-synth/">Rule Synthesis</a>
                                    </li>
                                    <li class="dropdown__item dropdown__item--with-icon">
                                        <img class="dropdown__icon" src="/imandra-docs/jekyll-resources/assets/img/icon--menu--docs.svg" alt="Docs" title="Docs Icon">
                                        <a class="dropdown__link dropdown__link--last" href="https://docs.imandra.ai/fix-engine/">Fix Engine</a>
                                    </li>
                                </ul>
                            </li>



                            <li class="top-nav-bar__item top-nav-bar__item--group dropdown--products">
                                <p class="top-nav-bar__link top-nav-bar__link--group" onclick="">Products</p>
                                <ul class="dropdown-content dropdown-content--products">
                                    <li class="dropdown__item dropdown__item--with-icon">
                                        <img class="dropdown__icon" src="/imandra-docs/jekyll-resources/assets/img/icon--menu--core.svg" alt="Imandra Core" title="Imandra Core Icon">
                                        <a class="dropdown__link" href="https://www.imandra.ai/core">Imandra Core</a>
                                    </li>
                                    <li class="dropdown__item dropdown__item--with-icon">
                                        <img class="dropdown__icon" src="/imandra-docs/jekyll-resources/assets/img/icon--menu--ipl.svg" alt="Imandra Protocol Language" title="Imandra Protocol Language Icon">
                                        <a class="dropdown__link" href="https://www.imandra.ai/ipl-product">Imandra Protocol Language</a>
                                    </li>
                                    <li class="dropdown__item dropdown__item--with-icon">
                                        <img class="dropdown__icon" src="/imandra-docs/jekyll-resources/assets/img/icon--menu--systems.svg" alt="Imandra Markets - Systems" title="Imandra Markets - Systems Icon">
                                        <a class="dropdown__link" href="https://www.imandra.ai/systems">Imandra Markets - Systems</a>
                                    </li>
                                    <li class="dropdown__item dropdown__item--with-icon">
                                        <img class="dropdown__icon" src="/imandra-docs/jekyll-resources/assets/img/icon--menu--connectivity.svg" alt="Imandra Markets - Connectivity" title="Imandra Markets - Connectivity Icon">
                                        <a class="dropdown__link dropdown__link--last" href="https://www.imandra.ai/connectivity">Imandra Markets - Connectivity</a>
                                    </li>
                                    <li class="dropdown__item dropdown__item--with-icon">
                                        <img class="dropdown__icon" src="/imandra-docs/jekyll-resources/assets/img/icon--menu--autopilot.svg" alt="Imandra Markets - Autopilot" title="Imandra Markets - Autopilot Icon">
                                        <a class="dropdown__link dropdown__link--last" href="https://www.imandra.ai/autopilot">Imandra Markets - Autopilot</a>
                                    </li>
                                </ul>
                            </li>



                            <li class="top-nav-bar__item top-nav-bar__item--group dropdown--industries">
                                <p class="top-nav-bar__link top-nav-bar__link--group" onclick="">Industries</p>
                                <ul class="dropdown-content dropdown-content--industries">
                                    <li class="dropdown__item dropdown__item--with-icon">
                                        <img class="dropdown__icon" src="/imandra-docs/jekyll-resources/assets/img/icon--menu--financial.svg" alt="Financial Markets" title="Financial Markets Icon">
                                        <a class="dropdown__link " href="https://www.imandra.ai/markets">Financial Markets</a>
                                    </li>
                                    <li class="dropdown__item dropdown__item--with-icon">
                                        <img class="dropdown__icon" src="/imandra-docs/jekyll-resources/assets/img/icon--menu--autonomy.svg" alt="Autonomous Systems" title="Autonomous Systems Icon">
                                        <a class="dropdown__link" href="https://www.imandra.ai/autonomy">Autonomous Systems</a>
                                    </li>
                                    <li class="dropdown__item dropdown__item--with-icon">
                                        <img class="dropdown__icon" src="/imandra-docs/jekyll-resources/assets/img/icon--menu--ml.svg" alt="Machine Learning" title="Machine Learning Icon">
                                        <a class="dropdown__link" href="https://www.imandra.ai/ml">Machine Learning</a>
                                    </li>
                                    <li class="dropdown__item dropdown__item--with-icon">
                                        <img class="dropdown__icon" src="/imandra-docs/jekyll-resources/assets/img/icon--menu--government.svg" alt="Machine Learning" title="Machine Learning Icon">
                                        <a class="dropdown__link dropdown__link--last" href="https://www.imandra.ai/government">Government and defense</a>
                                    </li>
                                </ul>
                            </li>

                            <li class="top-nav-bar__item top-nav-bar__item--group dropdown--media">
                                <p class="top-nav-bar__link top-nav-bar__link--group" onclick="">Media</p>
                                <ul class="dropdown-content dropdown-content--media">
                                    <li class="dropdown__item dropdown__item--with-icon">
                                        <img class="dropdown__icon" src="/imandra-docs/jekyll-resources/assets/img/icon--menu--media.svg" alt="Media" title="Media Icon">
                                        <a class="dropdown__link " href="https://www.imandra.ai/media">Media</a>
                                    </li>
                                    <li class="dropdown__item dropdown__item--with-icon">
                                        <img class="dropdown__icon" src="/imandra-docs/jekyll-resources/assets/img/icon--menu--blog.svg" alt="Blog" title="Blog Icon">
                                        <a class="dropdown__link dropdown__link--last " href="https://medium.com/imandra">Blog</a>
                                    </li>
                                </ul>
                            </li>

                            <li class="top-nav-bar__item top-nav-bar__item--group dropdown--company">
                                <p class="top-nav-bar__link top-nav-bar__link--group" onclick="">Company</p>
                                <ul class="dropdown-content dropdown-content--company">
                                    <li class="dropdown__item dropdown__item--with-icon">
                                        <img class="dropdown__icon" src="/imandra-docs/jekyll-resources/assets/img/icon--menu--about.svg" alt="About" title="About Icon">
                                        <a class="dropdown__link" href="https://www.imandra.ai/about">About</a>
                                    </li>
                                    <li class="dropdown__item dropdown__item--with-icon">
                                        <img class="dropdown__icon" src="/imandra-docs/jekyll-resources/assets/img/icon--menu--careers.svg" alt=" Careers" title="Careers Icon">
                                        <a class="dropdown__link dropdown__link--bottom" href="https://www.imandra.ai/careers">Careers</a>
                                    </li>
                                    <li class="dropdown__item dropdown__item--with-icon">
                                        <img class="dropdown__icon" src="/imandra-docs/jekyll-resources/assets/img/icon--menu--research.svg" alt="Research" title="Research Icon">
                                        <a class="dropdown__link dropdown__link--last" href="https://www.imandra.ai/research">Research</a>
                                    </li>
                                </ul>
                            </li>
                        </ul>

                    </div>
                </div>
            </nav>
        </div>

        

        <div class="template-header__image-container">
            <a class="template-header__image" href="/imandra-docs">
                <img class="site-specific-image" src="/imandra-docs/static/img/site_specific_image_v_2.svg">
            </a>
        </div>
    </div>



    <script>
        document.getElementById('toggler--left').addEventListener('click', function () {
            document.querySelector('.side__right-menu-toggler .side__toggle').classList.remove(
                'side__toggle--active');
            document.querySelector('.side__left-menu-toggler .side__toggle').classList.toggle(
                'side__toggle--active');
            document.getElementsByClassName('side__nav-container')[0].classList.toggle(
                'side__nav-container--hidden');
            document.getElementsByClassName('top-nav-bar__nav')[0].classList.add('top-nav-bar__nav--hidden');
        });

        document.getElementById('toggler--right').addEventListener('click', function () {
            document.querySelector('.side__left-menu-toggler .side__toggle').classList.remove(
                'side__toggle--active');
            document.querySelector('.side__right-menu-toggler .side__toggle').classList.toggle(
                'side__toggle--active');

            document.getElementsByClassName('side__nav-container')[0].classList.add(
                'side__nav-container--hidden');
            document.getElementsByClassName('top-nav-bar__nav')[0].classList.toggle(
                'top-nav-bar__nav--hidden');
        });
    </script>
</header>
                <article class="article__container article__container--notebooks">
                    <div class="main-content main-content--jupyter">
                        
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h1 id="Imandra-encoding-of-UBS-dark-pool-(Form-ATS)">Imandra encoding of UBS dark pool (Form ATS)<a class="anchor-link" href="#Imandra-encoding-of-UBS-dark-pool-(Form-ATS)">&#182;</a></h1><p>In this notebook, we model the order priority logic of the UBS ATS dark pool as described in UBS's <a href="https://storage.googleapis.com/imandra-notebook-assets/Form-ATS-June15.pdf">June 1st 2015 Form ATS submission to the SEC</a> and analyse it using Imandra.</p>
<p>We observe that as described, the order priority logic suffers from a fundamental flaw: the order ranking function is not <em>transitive</em>.</p>
<p>This type of subtle issue in matching logic strongly motivates the use of formal, <a href="https://medium.com/imandra/machine-reasonable-apis-and-regulations-20f29e1bd4cf">machine reasonable</a> disclosures.</p>
<p>Some relevant references:</p>
<ul>
<li><a href="https://www.bloomberg.com/news/articles/2016-03-04/intel-s-pentium-bug-fix-is-proposed-as-solution-for-dark-pools">Bloomberg - Intel's Pentium Bug Fix Is Proposed as Solution for Dark Pools</a></li>
<li>our 2017 Lecture Notes in AI paper <a href="https://link.springer.com/chapter/10.1007/978-3-319-63046-5_3">Formal Verification of Financial Algorithms</a></li>
<li>our 2016 <a href="https://www.sec.gov/comments/s7-23-15/s72315-24.pdf">SEC Reg ATS-N comment letter</a> proposing the <em>Precise Specification Standard</em> for disclosure of financial algorithms</li>
<li>our 2018 <a href="https://medium.com/imandra/machine-reasonable-apis-and-regulations-20f29e1bd4cf">Machine Reasonable APIs and Regulations</a> Medium post</li>
</ul>
<h2 id="UBS-Future-of-Finance-Challenge---First-Place-Winner">UBS Future of Finance Challenge - First Place Winner<a class="anchor-link" href="#UBS-Future-of-Finance-Challenge---First-Place-Winner">&#182;</a></h2><p><img src="https://storage.googleapis.com/imandra-notebook-assets/winningubsfinals2015_jpg-large.jpg" width=500></p>
<p>This analysis was part of Aesthetic Integration's entry in the 2015 UBS Future of Finance Challenge, for which we won first place (out of 620 companies from 52 countries!). This analysis is based purely on publicly available documents, and is based on our interpretation of the English prose written in the Form ATS.</p>
<p><img src="https://storage.googleapis.com/imandra-notebook-assets/ubs-form-ats-first-page.png" width=500></p>
<h1 id="An-Imandra-Formal-Model-of-UBS-ATS-Order-Priority-Logic">An Imandra Formal Model of UBS ATS Order Priority Logic<a class="anchor-link" href="#An-Imandra-Formal-Model-of-UBS-ATS-Order-Priority-Logic">&#182;</a></h1><p>We begin our model by defining a record type corresponding to the current NBB/O and relevant market data signals.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="try-this-container">
  <a href="https://try.imandra.ai/launch/?next=/h/user-redirect/notebooks/Analysing%20the%20UBS%20ATS%20Dark%20Pool.ipynb%23try-cell-2" target="_blank" rel="nofollow">
    <div class="try-this">Try this!</div>
  </a>
</div>
<div class="input">
<div class="prompt input_prompt">In&nbsp;[1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ocaml"><pre><span></span><span class="k">type</span> <span class="n">mkt_data</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">nbb</span> <span class="o">:</span> <span class="n">real</span><span class="o">;</span>
  <span class="n">nbo</span> <span class="o">:</span> <span class="n">real</span><span class="o">;</span>
  <span class="n">l_up</span> <span class="o">:</span> <span class="n">real</span><span class="o">;</span>
  <span class="n">l_down</span> <span class="o">:</span> <span class="n">real</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[1]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>type mkt_data = { nbb : real; nbo : real; l_up : real; l_down : real; }
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Let us now introduce some useful functions on <code>mkt_data</code>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="try-this-container">
  <a href="https://try.imandra.ai/launch/?next=/h/user-redirect/notebooks/Analysing%20the%20UBS%20ATS%20Dark%20Pool.ipynb%23try-cell-4" target="_blank" rel="nofollow">
    <div class="try-this">Try this!</div>
  </a>
</div>
<div class="input">
<div class="prompt input_prompt">In&nbsp;[2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ocaml"><pre><span></span><span class="k">type</span> <span class="n">mkt_cond</span> <span class="o">=</span> <span class="nc">MKT_NORMAL</span> <span class="o">|</span> <span class="nc">MKT_CROSSED</span> <span class="o">|</span> <span class="nc">MKT_LOCKED</span>

<span class="k">let</span> <span class="n">which_mkt</span> <span class="n">mkt</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">mkt</span><span class="o">.</span><span class="n">nbo</span> <span class="o">=</span> <span class="n">mkt</span><span class="o">.</span><span class="n">nbb</span> <span class="k">then</span> <span class="nc">MKT_LOCKED</span>
  <span class="k">else</span> <span class="k">if</span> <span class="n">mkt</span><span class="o">.</span><span class="n">nbo</span> <span class="o">&lt;.</span> <span class="n">mkt</span><span class="o">.</span><span class="n">nbb</span> <span class="k">then</span> <span class="nc">MKT_CROSSED</span>
  <span class="k">else</span> <span class="nc">MKT_NORMAL</span>

<span class="k">let</span> <span class="n">mid_point</span> <span class="n">mkt</span> <span class="o">=</span> <span class="o">(</span><span class="n">mkt</span><span class="o">.</span><span class="n">nbb</span> <span class="o">+.</span> <span class="n">mkt</span><span class="o">.</span><span class="n">nbo</span><span class="o">)</span> <span class="o">/.</span> <span class="mi">2</span><span class="o">.</span><span class="mi">0</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[2]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>type mkt_cond = MKT_NORMAL | MKT_CROSSED | MKT_LOCKED
val which_mkt : mkt_data -&gt; mkt_cond = &lt;fun&gt;
val mid_point : mkt_data -&gt; real = &lt;fun&gt;
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Because our model is executable, we can compute with various <code>mkt_data</code> values:</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="try-this-container">
  <a href="https://try.imandra.ai/launch/?next=/h/user-redirect/notebooks/Analysing%20the%20UBS%20ATS%20Dark%20Pool.ipynb%23try-cell-6" target="_blank" rel="nofollow">
    <div class="try-this">Try this!</div>
  </a>
</div>
<div class="input">
<div class="prompt input_prompt">In&nbsp;[3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ocaml"><pre><span></span><span class="o">{</span><span class="n">nbb</span><span class="o">=</span><span class="mi">42</span><span class="o">.</span><span class="mi">11</span><span class="o">;</span> <span class="n">nbo</span><span class="o">=</span><span class="mi">42</span><span class="o">.</span><span class="mi">10</span><span class="o">;</span> <span class="n">l_up</span><span class="o">=</span><span class="mi">3</span><span class="o">.</span> <span class="o">;</span> <span class="n">l_down</span><span class="o">=</span> <span class="mi">2</span><span class="o">.</span><span class="mi">5</span><span class="o">}</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[3]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>- : mkt_data = {nbb = 4211/100; nbo = 421/10; l_up = 3; l_down = 5/2}
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="try-this-container">
  <a href="https://try.imandra.ai/launch/?next=/h/user-redirect/notebooks/Analysing%20the%20UBS%20ATS%20Dark%20Pool.ipynb%23try-cell-7" target="_blank" rel="nofollow">
    <div class="try-this">Try this!</div>
  </a>
</div>
<div class="input">
<div class="prompt input_prompt">In&nbsp;[4]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ocaml"><pre><span></span><span class="n">which_mkt</span> <span class="o">{</span><span class="n">nbb</span><span class="o">=</span><span class="mi">42</span><span class="o">.</span><span class="mi">11</span><span class="o">;</span> <span class="n">nbo</span><span class="o">=</span><span class="mi">42</span><span class="o">.</span><span class="mi">10</span><span class="o">;</span> <span class="n">l_up</span><span class="o">=</span><span class="mi">3</span><span class="o">.</span> <span class="o">;</span> <span class="n">l_down</span><span class="o">=</span> <span class="mi">2</span><span class="o">.</span><span class="mi">5</span><span class="o">}</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[4]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>- : mkt_cond = MKT_CROSSED
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Aside:-Custom-Document-Printers">Aside: Custom Document Printers<a class="anchor-link" href="#Aside:-Custom-Document-Printers">&#182;</a></h2><p>Imandra has a powerful structured <em>document</em> system for making custom views and interfaces for your algorithm analysis tasks.</p>
<p>To make our Imandra notebooks and analysis toolchains user-friendly, we can define and install our own custom Imandra <em>document printer</em> that will render our market data type in a table in our notebook.</p>
<p>For example, we can define a simple table-based document printer for our <code>mkt_data</code> type as follows.</p>
<p>We use the <code>[@@program]</code> attribute on our pretty-printer definition, to tell Imandra to only define this function in <code>#program</code> mode (not in <code>#logic</code> mode, i.e., not within our formal logic). Arbitrary OCaml functions can be defined in <code>#program</code> mode, the basis for much custom Imandra interfaces and proof automation:</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="try-this-container">
  <a href="https://try.imandra.ai/launch/?next=/h/user-redirect/notebooks/Analysing%20the%20UBS%20ATS%20Dark%20Pool.ipynb%23try-cell-9" target="_blank" rel="nofollow">
    <div class="try-this">Try this!</div>
  </a>
</div>
<div class="input">
<div class="prompt input_prompt">In&nbsp;[5]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ocaml"><pre><span></span><span class="k">let</span> <span class="n">doc_of_mkt_data</span> <span class="n">m</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">module</span> <span class="nc">D</span> <span class="o">=</span> <span class="nc">Document</span> <span class="k">in</span>
  <span class="nn">D</span><span class="p">.</span><span class="n">indent</span> <span class="s2">&quot;mkt_data&quot;</span> <span class="o">@@</span> <span class="nn">D</span><span class="p">.</span><span class="n">record</span> <span class="o">[</span>
           <span class="s2">&quot;nbb&quot;</span><span class="o">,</span> <span class="nn">D</span><span class="p">.</span><span class="n">s</span> <span class="o">@@</span> <span class="nn">Real</span><span class="p">.</span><span class="n">to_string_approx</span> <span class="n">m</span><span class="o">.</span><span class="n">nbb</span><span class="o">;</span>
           <span class="s2">&quot;nbo&quot;</span><span class="o">,</span> <span class="nn">D</span><span class="p">.</span><span class="n">s</span> <span class="o">@@</span> <span class="nn">Real</span><span class="p">.</span><span class="n">to_string_approx</span> <span class="n">m</span><span class="o">.</span><span class="n">nbo</span><span class="o">;</span>
           <span class="s2">&quot;l_up&quot;</span><span class="o">,</span> <span class="nn">D</span><span class="p">.</span><span class="n">s</span> <span class="o">@@</span> <span class="nn">Real</span><span class="p">.</span><span class="n">to_string_approx</span> <span class="n">m</span><span class="o">.</span><span class="n">l_up</span><span class="o">;</span>
           <span class="s2">&quot;l_down&quot;</span><span class="o">,</span> <span class="nn">D</span><span class="p">.</span><span class="n">s</span> <span class="o">@@</span> <span class="nn">Real</span><span class="p">.</span><span class="n">to_string_approx</span> <span class="n">m</span><span class="o">.</span><span class="n">l_down</span><span class="o">;</span>
  <span class="o">]</span>
<span class="o">[@@</span><span class="n">program</span><span class="o">]</span>

<span class="o">#</span><span class="n">install_doc</span> <span class="n">doc_of_mkt_data</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[5]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>val doc_of_mkt_data : mkt_data -&gt; Document.t = &lt;fun&gt;
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>If we view the same <code>mkt_data</code> value as above, we'll now see it rendered with our custom pretty-printer:</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="try-this-container">
  <a href="https://try.imandra.ai/launch/?next=/h/user-redirect/notebooks/Analysing%20the%20UBS%20ATS%20Dark%20Pool.ipynb%23try-cell-11" target="_blank" rel="nofollow">
    <div class="try-this">Try this!</div>
  </a>
</div>
<div class="input">
<div class="prompt input_prompt">In&nbsp;[6]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ocaml"><pre><span></span><span class="o">{</span><span class="n">nbb</span><span class="o">=</span><span class="mi">42</span><span class="o">.</span><span class="mi">11</span><span class="o">;</span> <span class="n">nbo</span><span class="o">=</span><span class="mi">42</span><span class="o">.</span><span class="mi">10</span><span class="o">;</span> <span class="n">l_up</span><span class="o">=</span><span class="mi">3</span><span class="o">.</span> <span class="o">;</span> <span class="n">l_down</span><span class="o">=</span> <span class="mi">2</span><span class="o">.</span><span class="mi">5</span><span class="o">}</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[6]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>- : mkt_data = &lt;document&gt;
</pre>
</div>

</div>

<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div><div><h4>mkt_data</h4><div class="imandra-table" id="table-0c8c4b20-3f01-4650-a592-4667911762ef"><table><tr><td><b>nbb</b></td><td>42.11</td></tr><tr><td><b>nbo</b></td><td>42.1</td></tr><tr><td><b>l_up</b></td><td>3.</td></tr><tr><td><b>l_down</b></td><td>2.5</td></tr></table></div></div></div>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h1 id="Time,-Price-and-Static-Data">Time, Price and Static Data<a class="anchor-link" href="#Time,-Price-and-Static-Data">&#182;</a></h1><p>We now define some types and functions for representing <code>time</code>, <code>price</code> and <code>static_data</code>. We use <code>int</code> for <code>time</code> and <code>real</code> for <code>price</code>, as it is sufficient for this analysis, but custom types (e.g., <code>decs</code> with price bands) can be easily defined.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="try-this-container">
  <a href="https://try.imandra.ai/launch/?next=/h/user-redirect/notebooks/Analysing%20the%20UBS%20ATS%20Dark%20Pool.ipynb%23try-cell-13" target="_blank" rel="nofollow">
    <div class="try-this">Try this!</div>
  </a>
</div>
<div class="input">
<div class="prompt input_prompt">In&nbsp;[7]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ocaml"><pre><span></span><span class="k">type</span> <span class="n">time</span> <span class="o">=</span> <span class="kt">int</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[7]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>type time = int
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="try-this-container">
  <a href="https://try.imandra.ai/launch/?next=/h/user-redirect/notebooks/Analysing%20the%20UBS%20ATS%20Dark%20Pool.ipynb%23try-cell-14" target="_blank" rel="nofollow">
    <div class="try-this">Try this!</div>
  </a>
</div>
<div class="input">
<div class="prompt input_prompt">In&nbsp;[8]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ocaml"><pre><span></span><span class="k">type</span> <span class="n">price</span> <span class="o">=</span> <span class="n">real</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[8]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>type price = real
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="try-this-container">
  <a href="https://try.imandra.ai/launch/?next=/h/user-redirect/notebooks/Analysing%20the%20UBS%20ATS%20Dark%20Pool.ipynb%23try-cell-15" target="_blank" rel="nofollow">
    <div class="try-this">Try this!</div>
  </a>
</div>
<div class="input">
<div class="prompt input_prompt">In&nbsp;[9]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ocaml"><pre><span></span><span class="k">type</span> <span class="n">static_data</span> <span class="o">=</span> <span class="o">{</span> <span class="n">round_lot</span> <span class="o">:</span> <span class="kt">int</span><span class="o">;</span>
                     <span class="n">tick_size</span> <span class="o">:</span> <span class="kt">float</span> <span class="o">}</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[9]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>type static_data = { round_lot : time; tick_size : float; }
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h1 id="Order-types">Order types<a class="anchor-link" href="#Order-types">&#182;</a></h1><p>We now define the order types supported by the dark pool.</p>
<h2 id="Section-2-of-the-Form-ATS-defines-the-order-types-as-follows:">Section 2 of the Form ATS defines the order types as follows:<a class="anchor-link" href="#Section-2-of-the-Form-ATS-defines-the-order-types-as-follows:">&#182;</a></h2><p>Order Types:</p>
<ul>
<li>Pegged Orders (both Resident and IOC TimeInForce).
<pre><code>Pegging can be to the near, midpoint, or far
side of the NBBO. Pegged Orders may have a limit price.</code></pre>
</li>
<li>Limit Orders (both Resident and IOC TimeInForce)</li>
<li>Market Orders (both Resident and IOC TimeInForce)</li>
</ul>
<p>Conditional Indication Types:</p>
<ul>
<li>Pegged Conditional Indications (Resident T)</li>
<li>Limit Conditional Indications (Resident TimeInForce only)</li>
</ul>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="try-this-container">
  <a href="https://try.imandra.ai/launch/?next=/h/user-redirect/notebooks/Analysing%20the%20UBS%20ATS%20Dark%20Pool.ipynb%23try-cell-17" target="_blank" rel="nofollow">
    <div class="try-this">Try this!</div>
  </a>
</div>
<div class="input">
<div class="prompt input_prompt">In&nbsp;[10]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ocaml"><pre><span></span><span class="k">type</span> <span class="n">order_side</span> <span class="o">=</span> <span class="nc">BUY</span> <span class="o">|</span> <span class="nc">SELL</span> <span class="o">|</span> <span class="nc">SELL_SHORT</span>

<span class="k">type</span> <span class="n">order_peg</span> <span class="o">=</span> <span class="nc">NEAR</span> <span class="o">|</span> <span class="nc">MID</span> <span class="o">|</span> <span class="nc">FAR</span> <span class="o">|</span> <span class="nc">NO_PEG</span>

<span class="k">type</span> <span class="n">order_type</span> <span class="o">=</span>
    <span class="nc">MARKET</span>
  <span class="o">|</span> <span class="nc">LIMIT</span>
  <span class="o">|</span> <span class="nc">PEGGED</span>
  <span class="o">|</span> <span class="nc">PEGGED_CI</span>
  <span class="o">|</span> <span class="nc">LIMIT_CI</span>
  <span class="o">|</span> <span class="nc">FIRM_UP_PEGGED</span>
  <span class="o">|</span> <span class="nc">FIRM_UP_LIMIT</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[10]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>type order_side = BUY | SELL | SELL_SHORT
type order_peg = NEAR | MID | FAR | NO_PEG
type order_type =
    MARKET
  | LIMIT
  | PEGGED
  | PEGGED_CI
  | LIMIT_CI
  | FIRM_UP_PEGGED
  | FIRM_UP_LIMIT
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Source Categories are defined in the Form ATS as follows:</p>
<ul>
<li>Source Category 1: Retail orders routed by broker - dealer clients of the UBS Retail Market Making business.</li>
<li>Source Category 2: Certain orders received from UBS algorithms, where the underlying client is an institutional client of UBS.</li>
<li>Source Category 3: Orders received from Order Originators that are determined by UBS to exhibit lowto - neutral reversion.</li>
<li>Source Category 4: All other orders not originating from Source Categories 1, 2 or 3.</li>
</ul>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="try-this-container">
  <a href="https://try.imandra.ai/launch/?next=/h/user-redirect/notebooks/Analysing%20the%20UBS%20ATS%20Dark%20Pool.ipynb%23try-cell-19" target="_blank" rel="nofollow">
    <div class="try-this">Try this!</div>
  </a>
</div>
<div class="input">
<div class="prompt input_prompt">In&nbsp;[11]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ocaml"><pre><span></span><span class="k">type</span> <span class="n">order_attr</span> <span class="o">=</span> <span class="nc">RESIDENT</span> <span class="o">|</span> <span class="nc">IOC</span>

<span class="k">type</span> <span class="n">category</span> <span class="o">=</span> <span class="nc">C_ONE</span> <span class="o">|</span> <span class="nc">C_TWO</span> <span class="o">|</span> <span class="nc">C_THREE</span> <span class="o">|</span> <span class="nc">C_FOUR</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[11]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>type order_attr = RESIDENT | IOC
type category = C_ONE | C_TWO | C_THREE | C_FOUR
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h1 id="Capacity,-Eligibilities-and-Crossing-Restrictions">Capacity, Eligibilities and Crossing Restrictions<a class="anchor-link" href="#Capacity,-Eligibilities-and-Crossing-Restrictions">&#182;</a></h1></div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="try-this-container">
  <a href="https://try.imandra.ai/launch/?next=/h/user-redirect/notebooks/Analysing%20the%20UBS%20ATS%20Dark%20Pool.ipynb%23try-cell-21" target="_blank" rel="nofollow">
    <div class="try-this">Try this!</div>
  </a>
</div>
<div class="input">
<div class="prompt input_prompt">In&nbsp;[12]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ocaml"><pre><span></span><span class="k">type</span> <span class="n">capacity</span> <span class="o">=</span> <span class="nc">Principal</span> <span class="o">|</span> <span class="nc">Agency</span>

<span class="c">(* ID of the order source *)</span>

<span class="k">type</span> <span class="n">order_source</span> <span class="o">=</span> <span class="kt">int</span>

<span class="c">(* UBS&#39;s ID in the model *)</span>

<span class="k">let</span> <span class="n">ubs_id</span> <span class="o">=</span> <span class="mi">12</span>

<span class="c">(* Category crossing constraints *)</span>

<span class="k">type</span> <span class="n">category_elig</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">c_one_elig</span> <span class="o">:</span> <span class="kt">bool</span><span class="o">;</span>
  <span class="n">c_two_elig</span> <span class="o">:</span> <span class="kt">bool</span><span class="o">;</span>
  <span class="n">c_three_elig</span> <span class="o">:</span> <span class="kt">bool</span><span class="o">;</span>
  <span class="n">c_four_elig</span> <span class="o">:</span> <span class="kt">bool</span><span class="o">;</span>
<span class="o">}</span>

<span class="k">let</span> <span class="n">default_cat_elig</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">c_one_elig</span> <span class="o">=</span> <span class="bp">true</span><span class="o">;</span>
  <span class="n">c_two_elig</span> <span class="o">=</span> <span class="bp">true</span><span class="o">;</span>
  <span class="n">c_three_elig</span> <span class="o">=</span> <span class="bp">true</span><span class="o">;</span>
  <span class="n">c_four_elig</span> <span class="o">=</span> <span class="bp">true</span><span class="o">;</span>
<span class="o">}</span>

<span class="c">(* Type for crossing restrictions *)</span>

<span class="k">type</span> <span class="n">cross_restrict</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">cr_self_cross</span> <span class="o">:</span> <span class="kt">bool</span><span class="o">;</span>
  <span class="n">cr_ubs_principal</span> <span class="o">:</span> <span class="kt">bool</span><span class="o">;</span>
  <span class="n">cr_round_lot_only</span> <span class="o">:</span> <span class="kt">bool</span><span class="o">;</span>
  <span class="n">cr_no_locked_nbbo</span> <span class="o">:</span> <span class="kt">bool</span><span class="o">;</span>
  <span class="n">cr_pegged_mid_point_mode</span> <span class="o">:</span> <span class="kt">int</span><span class="o">;</span>

  <span class="c">(* From the examples, we understand that: 0 - no constraint 1 - mid      *)</span>
  <span class="c">(* constraint 2 - limit constraint                                       *)</span>

  <span class="n">cr_enable_conditionals</span> <span class="o">:</span> <span class="kt">bool</span><span class="o">;</span>
  <span class="n">cr_min_qty</span> <span class="o">:</span> <span class="kt">bool</span><span class="o">;</span>
  <span class="n">cr_cat_elig</span> <span class="o">:</span> <span class="n">category_elig</span><span class="o">;</span>
<span class="o">}</span>

<span class="k">let</span> <span class="n">default_cross_restrict</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">cr_self_cross</span> <span class="o">=</span> <span class="bp">false</span><span class="o">;</span>
  <span class="n">cr_ubs_principal</span> <span class="o">=</span> <span class="bp">false</span><span class="o">;</span>
  <span class="n">cr_round_lot_only</span> <span class="o">=</span> <span class="bp">false</span><span class="o">;</span>
  <span class="n">cr_no_locked_nbbo</span> <span class="o">=</span> <span class="bp">false</span><span class="o">;</span>
  <span class="n">cr_pegged_mid_point_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
  <span class="n">cr_enable_conditionals</span> <span class="o">=</span> <span class="bp">false</span><span class="o">;</span>
  <span class="n">cr_min_qty</span> <span class="o">=</span> <span class="bp">false</span><span class="o">;</span>
  <span class="n">cr_cat_elig</span> <span class="o">=</span> <span class="n">default_cat_elig</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[12]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>type capacity = Principal | Agency
type order_source = time
val ubs_id : order_source = 12
type category_elig = {
  c_one_elig : bool;
  c_two_elig : bool;
  c_three_elig : bool;
  c_four_elig : bool;
}
val default_cat_elig : category_elig =
  {c_one_elig = true; c_two_elig = true; c_three_elig = true;
   c_four_elig = true}
type cross_restrict = {
  cr_self_cross : bool;
  cr_ubs_principal : bool;
  cr_round_lot_only : bool;
  cr_no_locked_nbbo : bool;
  cr_pegged_mid_point_mode : order_source;
  cr_enable_conditionals : bool;
  cr_min_qty : bool;
  cr_cat_elig : category_elig;
}
val default_cross_restrict : cross_restrict =
  {cr_self_cross = false; cr_ubs_principal = false;
   cr_round_lot_only = false; cr_no_locked_nbbo = false;
   cr_pegged_mid_point_mode = 0; cr_enable_conditionals = false;
   cr_min_qty = false;
   cr_cat_elig =
    {c_one_elig = true; c_two_elig = true; c_three_elig = true;
     c_four_elig = true}}
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h1 id="Orders">Orders<a class="anchor-link" href="#Orders">&#182;</a></h1><p>We now define the type <code>order</code>, representing all data associated with a given order.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="try-this-container">
  <a href="https://try.imandra.ai/launch/?next=/h/user-redirect/notebooks/Analysing%20the%20UBS%20ATS%20Dark%20Pool.ipynb%23try-cell-23" target="_blank" rel="nofollow">
    <div class="try-this">Try this!</div>
  </a>
</div>
<div class="input">
<div class="prompt input_prompt">In&nbsp;[13]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ocaml"><pre><span></span><span class="c">(* Note: there&#39;s both the quantity of the order and the current filled quantity. *)</span>

<span class="k">type</span> <span class="n">order</span> <span class="o">=</span>
    <span class="o">{</span> <span class="n">id</span> <span class="o">:</span> <span class="kt">int</span><span class="o">;</span>                        <span class="c">(* Order ID *)</span>
      <span class="n">peg</span> <span class="o">:</span> <span class="n">order_peg</span><span class="o">;</span>                 <span class="c">(* Near, Mid, Far or NoPeg *)</span>
      <span class="n">client_id</span> <span class="o">:</span> <span class="kt">int</span><span class="o">;</span>                 <span class="c">(* Client ID *)</span>
      <span class="n">order_type</span> <span class="o">:</span> <span class="n">order_type</span><span class="o">;</span>         <span class="c">(* Market, Limit or Pegged order + Conditional Indications *)</span>
      <span class="n">qty</span> <span class="o">:</span> <span class="kt">int</span><span class="o">;</span>                       <span class="c">(* Original quantity of the order (updated after cancel/replace) *)</span>
      <span class="n">min_qty</span> <span class="o">:</span> <span class="kt">int</span><span class="o">;</span>                   <span class="c">(* Minimum acceptible quantity to trade *)</span>
      <span class="n">leaves_qty</span> <span class="o">:</span> <span class="kt">int</span><span class="o">;</span>                <span class="c">(* Remaining quantity of the order *)</span>
      <span class="n">price</span> <span class="o">:</span> <span class="n">price</span><span class="o">;</span>                   <span class="c">(* Limit price (Not used if the order *)</span>
      <span class="n">time</span> <span class="o">:</span> <span class="n">time</span><span class="o">;</span>                     <span class="c">(* time of order entry (reset on update)) *)</span>
      <span class="n">src</span> <span class="o">:</span> <span class="n">order_source</span><span class="o">;</span>              <span class="c">(* ID of the order source *)</span>
      <span class="n">order_attr</span> <span class="o">:</span> <span class="n">order_attr</span><span class="o">;</span>         <span class="c">(* Resident or Immediate Or Cancel (IOC) *)</span>
      <span class="n">capacity</span> <span class="o">:</span> <span class="n">capacity</span><span class="o">;</span>             <span class="c">(* Principal or agency *)</span>
      <span class="n">category</span> <span class="o">:</span> <span class="n">category</span><span class="o">;</span>             <span class="c">(* Client category *)</span>
      <span class="n">cross_restrict</span> <span class="o">:</span> <span class="n">cross_restrict</span><span class="o">;</span> <span class="c">(* Crossing restrictions *)</span>
      <span class="n">locate_found</span> <span class="o">:</span> <span class="kt">bool</span><span class="o">;</span>             <span class="c">(* A sell-short order without a locate would be rejected *)</span>
      <span class="n">expiry_time</span> <span class="o">:</span> <span class="kt">int</span><span class="o">;</span>               <span class="c">(* When will the order expire? *)</span>
    <span class="o">}</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[13]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>type order = {
  id : order_source;
  peg : order_peg;
  client_id : order_source;
  order_type : order_type;
  qty : order_source;
  min_qty : order_source;
  leaves_qty : order_source;
  price : price;
  time : order_source;
  src : order_source;
  order_attr : order_attr;
  capacity : capacity;
  category : category;
  cross_restrict : cross_restrict;
  locate_found : bool;
  expiry_time : order_source;
}
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h1 id="Determining-how-much-and-at-what-price-two-orders-may-trade">Determining how much and at what price two orders may trade<a class="anchor-link" href="#Determining-how-much-and-at-what-price-two-orders-may-trade">&#182;</a></h1></div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="try-this-container">
  <a href="https://try.imandra.ai/launch/?next=/h/user-redirect/notebooks/Analysing%20the%20UBS%20ATS%20Dark%20Pool.ipynb%23try-cell-25" target="_blank" rel="nofollow">
    <div class="try-this">Try this!</div>
  </a>
</div>
<div class="input">
<div class="prompt input_prompt">In&nbsp;[14]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ocaml"><pre><span></span><span class="c">(** Uses two orders&#39; timestamps to determin the older price of the two *)</span>
<span class="k">let</span> <span class="n">older_price</span> <span class="o">(</span><span class="n">o1</span><span class="o">,</span> <span class="n">o2</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">o1</span><span class="o">.</span><span class="n">time</span> <span class="o">&gt;</span> <span class="n">o2</span><span class="o">.</span><span class="n">time</span> <span class="k">then</span> <span class="n">o2</span><span class="o">.</span><span class="n">price</span> <span class="k">else</span> <span class="n">o1</span><span class="o">.</span><span class="n">price</span>

<span class="k">type</span> <span class="n">fill_price</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">Known</span> <span class="k">of</span> <span class="n">price</span>
  <span class="o">|</span> <span class="nc">Unknown</span>
  <span class="o">|</span> <span class="nc">TOP</span> <span class="k">of</span> <span class="n">price</span>

<span class="c">(* Functions for categorisations  *)</span>

<span class="k">let</span> <span class="n">cat_priority</span> <span class="o">(</span><span class="n">o1</span><span class="o">,</span> <span class="n">o2</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">o1</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="nc">C_ONE</span> <span class="k">then</span> <span class="bp">false</span>
  <span class="k">else</span> <span class="k">if</span> <span class="n">o1</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="nc">C_TWO</span> <span class="o">&amp;&amp;</span>
            <span class="o">(</span><span class="n">o2</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="nc">C_THREE</span> <span class="o">||</span> <span class="n">o2</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="nc">C_FOUR</span><span class="o">)</span>
  <span class="k">then</span> <span class="bp">false</span>
  <span class="k">else</span> <span class="k">if</span> <span class="n">o1</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="nc">C_THREE</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">o2</span><span class="o">.</span><span class="n">category</span> <span class="o">=</span> <span class="nc">C_FOUR</span><span class="o">)</span> <span class="k">then</span> <span class="bp">false</span>
  <span class="k">else</span> <span class="bp">true</span>

<span class="k">let</span> <span class="n">eff_min_qty</span> <span class="o">(</span><span class="n">o</span><span class="o">)</span> <span class="o">=</span> <span class="n">min</span> <span class="n">o</span><span class="o">.</span><span class="n">min_qty</span> <span class="n">o</span><span class="o">.</span><span class="n">leaves_qty</span>

<span class="k">let</span> <span class="n">effective_size</span> <span class="o">(</span><span class="n">o</span><span class="o">,</span> <span class="n">should_round</span><span class="o">,</span> <span class="n">round_lot</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">should_round</span> <span class="o">=</span> <span class="bp">true</span> <span class="k">then</span>
    <span class="o">(</span> <span class="k">if</span> <span class="n">round_lot</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="o">(</span> <span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="n">leaves_qty</span> <span class="o">/</span> <span class="n">round_lot</span><span class="o">)</span> <span class="o">*</span> <span class="n">round_lot</span> <span class="o">)</span>
      <span class="k">else</span> <span class="n">o</span><span class="o">.</span><span class="n">leaves_qty</span> <span class="o">)</span>
  <span class="k">else</span>
    <span class="n">o</span><span class="o">.</span><span class="n">leaves_qty</span>

<span class="c">(* The pricing functions *)</span>

<span class="k">let</span> <span class="n">lessAggressive</span> <span class="o">(</span><span class="n">side</span><span class="o">,</span> <span class="n">lim_price</span><span class="o">,</span> <span class="n">far_price</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">lim_price</span> <span class="o">&lt;.</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span> <span class="k">then</span> <span class="n">far_price</span> <span class="k">else</span>
    <span class="o">(</span><span class="k">if</span> <span class="n">side</span> <span class="o">=</span> <span class="nc">BUY</span> <span class="k">then</span> <span class="nn">Real</span><span class="p">.</span><span class="n">min</span> <span class="n">lim_price</span> <span class="n">far_price</span>
     <span class="k">else</span> <span class="nn">Real</span><span class="p">.</span><span class="n">max</span> <span class="n">lim_price</span> <span class="n">far_price</span><span class="o">)</span>

<span class="c">(** This function is used to calculate the priority price *)</span>
<span class="k">let</span> <span class="n">priority_price</span> <span class="o">(</span><span class="n">side</span><span class="o">,</span> <span class="n">o</span><span class="o">,</span> <span class="n">mkt</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">calc_pegged_price</span> <span class="o">=</span>
    <span class="o">(</span> <span class="k">match</span> <span class="n">o</span><span class="o">.</span><span class="n">peg</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">FAR</span> <span class="o">-&gt;</span> <span class="n">lessAggressive</span><span class="o">(</span><span class="n">side</span><span class="o">,</span> <span class="n">o</span><span class="o">.</span><span class="n">price</span><span class="o">,</span>
                              <span class="o">(</span><span class="k">if</span> <span class="n">side</span> <span class="o">=</span> <span class="nc">BUY</span> <span class="k">then</span> <span class="n">mkt</span><span class="o">.</span><span class="n">nbo</span> <span class="k">else</span> <span class="n">mkt</span><span class="o">.</span><span class="n">nbb</span><span class="o">))</span>
      <span class="o">|</span> <span class="nc">MID</span> <span class="o">-&gt;</span> <span class="n">lessAggressive</span><span class="o">(</span><span class="n">side</span><span class="o">,</span> <span class="n">o</span><span class="o">.</span><span class="n">price</span><span class="o">,</span> <span class="o">(</span><span class="n">mid_point</span> <span class="n">mkt</span><span class="o">))</span>
      <span class="o">|</span> <span class="nc">NEAR</span> <span class="o">-&gt;</span> <span class="n">lessAggressive</span><span class="o">(</span><span class="n">side</span><span class="o">,</span> <span class="n">o</span><span class="o">.</span><span class="n">price</span><span class="o">,</span>
                               <span class="o">(</span><span class="k">if</span> <span class="n">side</span> <span class="o">=</span> <span class="nc">BUY</span> <span class="k">then</span> <span class="n">mkt</span><span class="o">.</span><span class="n">nbb</span> <span class="k">else</span> <span class="n">mkt</span><span class="o">.</span><span class="n">nbo</span><span class="o">))</span>
      <span class="o">|</span> <span class="nc">NO_PEG</span> <span class="o">-&gt;</span> <span class="n">o</span><span class="o">.</span><span class="n">price</span> <span class="o">)</span>
  <span class="k">in</span>
  <span class="k">let</span> <span class="n">calc_nbbo_capped_limit</span> <span class="o">=</span>
    <span class="o">(</span> <span class="k">if</span> <span class="n">side</span> <span class="o">=</span> <span class="nc">BUY</span> <span class="k">then</span> <span class="n">lessAggressive</span> <span class="o">(</span><span class="nc">BUY</span><span class="o">,</span> <span class="n">o</span><span class="o">.</span><span class="n">price</span><span class="o">,</span> <span class="n">mkt</span><span class="o">.</span><span class="n">nbo</span><span class="o">)</span>
      <span class="k">else</span> <span class="n">lessAggressive</span> <span class="o">(</span><span class="nc">SELL</span><span class="o">,</span> <span class="n">o</span><span class="o">.</span><span class="n">price</span><span class="o">,</span> <span class="n">mkt</span><span class="o">.</span><span class="n">nbb</span> <span class="o">)</span> <span class="o">)</span>
  <span class="k">in</span>
  <span class="k">match</span> <span class="n">o</span><span class="o">.</span><span class="n">order_type</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nc">LIMIT</span> <span class="o">-&gt;</span> <span class="n">calc_nbbo_capped_limit</span>
  <span class="o">|</span> <span class="nc">MARKET</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">side</span> <span class="o">=</span> <span class="nc">BUY</span> <span class="k">then</span> <span class="n">mkt</span><span class="o">.</span><span class="n">nbo</span> <span class="k">else</span> <span class="n">mkt</span><span class="o">.</span><span class="n">nbb</span>
  <span class="o">|</span> <span class="nc">PEGGED</span> <span class="o">-&gt;</span> <span class="n">calc_pegged_price</span>
  <span class="o">|</span> <span class="nc">PEGGED_CI</span> <span class="o">-&gt;</span> <span class="n">calc_pegged_price</span>
  <span class="o">|</span> <span class="nc">LIMIT_CI</span> <span class="o">-&gt;</span> <span class="n">calc_nbbo_capped_limit</span>
  <span class="o">|</span> <span class="nc">FIRM_UP_PEGGED</span> <span class="o">-&gt;</span> <span class="n">calc_pegged_price</span>
  <span class="o">|</span> <span class="nc">FIRM_UP_LIMIT</span> <span class="o">-&gt;</span> <span class="n">calc_nbbo_capped_limit</span>

<span class="c">(** This is used to calculate the actual price at which the order would trade   *)</span>
<span class="k">let</span> <span class="n">exec_price</span> <span class="o">(</span><span class="n">side</span><span class="o">,</span> <span class="n">o</span><span class="o">,</span> <span class="n">mkt</span><span class="o">)</span> <span class="o">=</span>
  <span class="n">priority_price</span> <span class="o">(</span><span class="n">side</span><span class="o">,</span> <span class="n">o</span><span class="o">,</span> <span class="n">mkt</span><span class="o">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[14]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>val older_price : order * order -&gt; price = &lt;fun&gt;
type fill_price = Known of price | Unknown | TOP of price
val cat_priority : order * order -&gt; bool = &lt;fun&gt;
val eff_min_qty : order -&gt; order_source = &lt;fun&gt;
val effective_size : order * bool * order_source -&gt; order_source = &lt;fun&gt;
val lessAggressive : order_side * price * price -&gt; price = &lt;fun&gt;
val priority_price : order_side * order * mkt_data -&gt; price = &lt;fun&gt;
val exec_price : order_side * order * mkt_data -&gt; price = &lt;fun&gt;
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h1 id="Crossing-Restrictions">Crossing Restrictions<a class="anchor-link" href="#Crossing-Restrictions">&#182;</a></h1><p>The UBS ATS allows all Order Originators to use the following optional
crossing restrictions, on a per - order or configured basis:</p>
<ul>
<li>No Self Cross: To prevent crossing against 'own orders' (orders sent with the same client ID).</li>
<li>No UBS Principal: To prevent crossing against UBS BD Principal Orders, or UBS affiliate Principal orders.</li>
<li>Round Lot Only: To prevent crossing in other than round lot orders.</li>
<li>No Locked: To prevent crossing on a pegged order when the NBBO is locked. (Bid = Offer)</li>
<li>PeggedMidPointMode: To prevent a Mid - point Pegged Order from being executed
  at its limit price if (i) in the case of a buy order, its limit price is less
  than the mid - point of the spread between the NBB and NBO and (ii) in the
  case of a sell order, its limit price is greater than the mid - point of the
  spread between the NBB and NBO. In the event this restriction is not
  elected, a Mid - Point Pegged Order with a specified limit price may be executed
  at the limit price even if the price is not equal to the mid - point of the
  spread between the NBB and the NBBO.</li>
<li>Enable Conditionals: To enable a Resident Order to interact with Conditional Indicators.</li>
<li>Minimum Quantity: Orders may be routed to the UBS ATS with a minimum quantity
  value specified. UBS ATS will only cross where at least this number of shares
  is available from a single eligible contra side order.</li>
</ul>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="try-this-container">
  <a href="https://try.imandra.ai/launch/?next=/h/user-redirect/notebooks/Analysing%20the%20UBS%20ATS%20Dark%20Pool.ipynb%23try-cell-27" target="_blank" rel="nofollow">
    <div class="try-this">Try this!</div>
  </a>
</div>
<div class="input">
<div class="prompt input_prompt">In&nbsp;[15]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ocaml"><pre><span></span><span class="c">(* Note that these are order-level constraints. There are members of this  *)</span>
<span class="c">(* structure, like cr_min_qty and cr_round_lot_only that are used in       *)</span>
<span class="c">(* calculating the effective minimum price.                                *)</span>

<span class="k">let</span> <span class="n">get_cat_eligibility</span> <span class="o">(</span><span class="n">cat_elig</span><span class="o">,</span> <span class="n">c</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">c</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nc">C_ONE</span> <span class="o">-&gt;</span> <span class="n">cat_elig</span><span class="o">.</span><span class="n">c_one_elig</span>
  <span class="o">|</span> <span class="nc">C_TWO</span> <span class="o">-&gt;</span> <span class="n">cat_elig</span><span class="o">.</span><span class="n">c_two_elig</span>
  <span class="o">|</span> <span class="nc">C_THREE</span> <span class="o">-&gt;</span> <span class="n">cat_elig</span><span class="o">.</span><span class="n">c_three_elig</span>
  <span class="o">|</span> <span class="nc">C_FOUR</span> <span class="o">-&gt;</span> <span class="n">cat_elig</span><span class="o">.</span><span class="n">c_four_elig</span>

<span class="k">let</span> <span class="n">can_orders_cross</span> <span class="o">(</span><span class="n">o1</span><span class="o">,</span> <span class="n">o2</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">o1_cr</span> <span class="o">=</span> <span class="n">o1</span><span class="o">.</span><span class="n">cross_restrict</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">o2_cr</span> <span class="o">=</span> <span class="n">o2</span><span class="o">.</span><span class="n">cross_restrict</span> <span class="k">in</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">o1_cr</span><span class="o">.</span><span class="n">cr_self_cross</span> <span class="o">||</span> <span class="n">o2_cr</span><span class="o">.</span><span class="n">cr_self_cross</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">o1</span><span class="o">.</span><span class="n">client_id</span> <span class="o">=</span> <span class="n">o2</span><span class="o">.</span><span class="n">client_id</span><span class="o">)</span>
  <span class="k">then</span> <span class="bp">false</span>
  <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">o1_cr</span><span class="o">.</span><span class="n">cr_ubs_principal</span> <span class="o">||</span> <span class="n">o2_cr</span><span class="o">.</span><span class="n">cr_ubs_principal</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
            <span class="o">(</span><span class="n">o1</span><span class="o">.</span><span class="n">client_id</span> <span class="o">=</span> <span class="n">ubs_id</span> <span class="o">||</span> <span class="n">o2</span><span class="o">.</span><span class="n">client_id</span> <span class="o">=</span> <span class="n">ubs_id</span><span class="o">)</span> <span class="k">then</span> <span class="bp">false</span>
  <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">o1_cr</span><span class="o">.</span><span class="n">cr_enable_conditionals</span> <span class="o">||</span> <span class="n">o2_cr</span><span class="o">.</span><span class="n">cr_enable_conditionals</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
            <span class="o">(</span><span class="n">o1</span><span class="o">.</span><span class="n">order_type</span> <span class="o">=</span> <span class="nc">LIMIT_CI</span> <span class="o">||</span> <span class="n">o1</span><span class="o">.</span><span class="n">order_type</span> <span class="o">=</span> <span class="nc">PEGGED_CI</span><span class="o">)</span> <span class="k">then</span> <span class="bp">false</span>
  <span class="k">else</span> <span class="bp">true</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[15]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>val get_cat_eligibility : category_elig * category -&gt; bool = &lt;fun&gt;
val can_orders_cross : order * order -&gt; bool = &lt;fun&gt;
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h1 id="Order-Book">Order Book<a class="anchor-link" href="#Order-Book">&#182;</a></h1><p>The Order Book is used to match buy orders against sell orders.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="try-this-container">
  <a href="https://try.imandra.ai/launch/?next=/h/user-redirect/notebooks/Analysing%20the%20UBS%20ATS%20Dark%20Pool.ipynb%23try-cell-29" target="_blank" rel="nofollow">
    <div class="try-this">Try this!</div>
  </a>
</div>
<div class="input">
<div class="prompt input_prompt">In&nbsp;[16]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ocaml"><pre><span></span><span class="k">type</span> <span class="n">order_book</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">buys</span>  <span class="o">:</span> <span class="n">order</span> <span class="kt">list</span><span class="o">;</span>
  <span class="n">sells</span> <span class="o">:</span> <span class="n">order</span> <span class="kt">list</span><span class="o">;</span>
<span class="o">}</span>

<span class="k">let</span> <span class="n">empty_book</span> <span class="o">=</span> <span class="o">{</span> <span class="n">buys</span> <span class="o">=</span> <span class="bp">[]</span><span class="o">;</span> <span class="n">sells</span> <span class="o">=</span> <span class="bp">[]</span> <span class="o">}</span>

<span class="k">type</span> <span class="n">fill</span> <span class="o">=</span> <span class="o">{</span> <span class="n">order_buy</span> <span class="o">:</span> <span class="n">order</span><span class="o">;</span>
              <span class="n">order_sell</span> <span class="o">:</span> <span class="n">order</span><span class="o">;</span>
              <span class="n">fill_qty</span> <span class="o">:</span> <span class="kt">int</span><span class="o">;</span>
              <span class="n">fill_price</span> <span class="o">:</span> <span class="n">fill_price</span><span class="o">;</span>
              <span class="n">fill_time</span> <span class="o">:</span> <span class="n">time</span><span class="o">;</span>
            <span class="o">}</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[16]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>type order_book = { buys : order list; sells : order list; }
val empty_book : order_book = {buys = []; sells = []}
type fill = {
  order_buy : order;
  order_sell : order;
  fill_qty : order_source;
  fill_price : fill_price;
  fill_time : order_source;
}
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h2 id="Ranking-functions-for-orders">Ranking functions for orders<a class="anchor-link" href="#Ranking-functions-for-orders">&#182;</a></h2><p>From Section 4.1 of UBS's June, 2015 Form ATS:</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<pre><code>Eligible Resident Orders and IOC Orders are given priority
based first on price and second on the time of their receipt by the UBS ATS.
Eligibility is determined based on the crossing restrictions associated with
the orders on both sides of the potential cross.

Invites are sent to the Order Originators of Conditional Indications on a
priority based first on price, second on the quantity and third on the time of
receipt by UBS ATS. For orders with the same price and time, priority is given
to Resident and IOC Orders over Conditional Indications.

All marketable limit orders (i.e., buy orders with limit prices at or above the
NBO or sell orders with limit prices at or below the NBB) will be treated as
though they are at equivalent prices for priority purposes. As such, they will
be handled based strictly on time priority, as if they were market orders. If a
marketable limit order becomes non - marketable before execution, it will be treated
as a limit order and will receive price / time priority, with time based upon the
original time of receipt of the order by the UBS ATS.</code></pre>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Let us formalise this logic below.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="try-this-container">
  <a href="https://try.imandra.ai/launch/?next=/h/user-redirect/notebooks/Analysing%20the%20UBS%20ATS%20Dark%20Pool.ipynb%23try-cell-33" target="_blank" rel="nofollow">
    <div class="try-this">Try this!</div>
  </a>
</div>
<div class="input">
<div class="prompt input_prompt">In&nbsp;[17]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ocaml"><pre><span></span><span class="k">let</span> <span class="n">non_ci</span> <span class="o">(</span><span class="n">ot</span><span class="o">)</span> <span class="o">=</span> <span class="n">not</span><span class="o">(</span><span class="n">ot</span> <span class="o">=</span> <span class="nc">PEGGED_CI</span> <span class="o">||</span> <span class="n">ot</span> <span class="o">=</span> <span class="nc">LIMIT_CI</span><span class="o">);;</span>

<span class="k">let</span> <span class="n">order_higher_ranked</span> <span class="o">(</span><span class="n">side</span><span class="o">,</span> <span class="n">o1</span><span class="o">,</span> <span class="n">o2</span><span class="o">,</span> <span class="n">mkt</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">ot1</span> <span class="o">=</span> <span class="n">o1</span><span class="o">.</span><span class="n">order_type</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">ot2</span> <span class="o">=</span> <span class="n">o2</span><span class="o">.</span><span class="n">order_type</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">p_price1</span> <span class="o">=</span> <span class="n">priority_price</span> <span class="o">(</span><span class="n">side</span><span class="o">,</span> <span class="n">o1</span><span class="o">,</span> <span class="n">mkt</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">p_price2</span> <span class="o">=</span> <span class="n">priority_price</span> <span class="o">(</span><span class="n">side</span><span class="o">,</span> <span class="n">o2</span><span class="o">,</span> <span class="n">mkt</span><span class="o">)</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">wins_price</span> <span class="o">=</span> <span class="o">(</span>
    <span class="k">if</span> <span class="n">side</span> <span class="o">=</span> <span class="nc">BUY</span> <span class="k">then</span>
      <span class="o">(</span> <span class="k">if</span> <span class="n">p_price1</span> <span class="o">&gt;.</span> <span class="n">p_price2</span> <span class="k">then</span> <span class="mi">1</span>
        <span class="k">else</span> <span class="k">if</span> <span class="n">p_price1</span> <span class="o">=</span> <span class="n">p_price2</span> <span class="k">then</span> <span class="mi">0</span>
        <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span>
    <span class="k">else</span>
      <span class="o">(</span> <span class="k">if</span> <span class="n">p_price1</span> <span class="o">&lt;.</span> <span class="n">p_price2</span> <span class="k">then</span> <span class="mi">1</span>
        <span class="k">else</span> <span class="k">if</span> <span class="n">p_price1</span> <span class="o">=</span> <span class="n">p_price2</span> <span class="k">then</span> <span class="mi">0</span>
        <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">)</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">wins_time</span> <span class="o">=</span> <span class="o">(</span>
    <span class="k">if</span> <span class="n">o1</span><span class="o">.</span><span class="n">time</span> <span class="o">&lt;</span> <span class="n">o2</span><span class="o">.</span><span class="n">time</span> <span class="k">then</span> <span class="mi">1</span>
    <span class="k">else</span> <span class="k">if</span> <span class="n">o1</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">o2</span><span class="o">.</span><span class="n">time</span> <span class="k">then</span> <span class="mi">0</span>
    <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
  <span class="o">)</span> <span class="k">in</span>

  <span class="c">(* Note that the CI priority is price, quantity and then time *)</span>
  <span class="k">if</span> <span class="n">wins_price</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">then</span> <span class="bp">true</span>
  <span class="k">else</span> <span class="k">if</span> <span class="n">wins_price</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">then</span> <span class="bp">false</span>
  <span class="k">else</span> <span class="o">(</span>
    <span class="c">(* Same price level - first check to see whether we&#39;re comparing two   *)</span>
    <span class="c">(* CI orders here                                                      *)</span>
    <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="n">non_ci</span> <span class="o">(</span><span class="n">ot1</span><span class="o">))</span> <span class="o">&amp;&amp;</span> <span class="n">not</span> <span class="o">(</span><span class="n">non_ci</span> <span class="o">(</span><span class="n">ot2</span><span class="o">))</span> <span class="k">then</span>
      <span class="n">o1</span><span class="o">.</span><span class="n">leaves_qty</span> <span class="o">&gt;</span> <span class="n">o2</span><span class="o">.</span><span class="n">leaves_qty</span>
    <span class="k">else</span> <span class="o">(</span> <span class="k">if</span> <span class="n">wins_time</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">then</span> <span class="bp">true</span>
           <span class="k">else</span> <span class="k">if</span> <span class="n">wins_time</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">then</span> <span class="bp">false</span>
           <span class="k">else</span> <span class="o">(</span>
             <span class="k">if</span> <span class="n">non_ci</span><span class="o">(</span><span class="n">ot1</span><span class="o">)</span> <span class="k">then</span> <span class="bp">true</span>
             <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">not</span><span class="o">(</span><span class="n">non_ci</span><span class="o">(</span><span class="n">ot1</span><span class="o">))</span> <span class="o">&amp;&amp;</span> <span class="n">non_ci</span><span class="o">(</span><span class="n">ot2</span><span class="o">))</span> <span class="k">then</span> <span class="bp">false</span>
             <span class="k">else</span>
               <span class="n">o1</span><span class="o">.</span><span class="n">leaves_qty</span> <span class="o">&gt;</span> <span class="n">o2</span><span class="o">.</span><span class="n">leaves_qty</span><span class="o">)</span>
         <span class="o">)</span>
  <span class="o">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[17]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>val non_ci : order_type -&gt; bool = &lt;fun&gt;
val order_higher_ranked : order_side * order * order * mkt_data -&gt; bool =
  &lt;fun&gt;
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>The property we're interested in is whether this ranking predicate is transitive (a necessary condition for being a proper ordering relation that can be used for sorting, e.g., orders in the book):</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="try-this-container">
  <a href="https://try.imandra.ai/launch/?next=/h/user-redirect/notebooks/Analysing%20the%20UBS%20ATS%20Dark%20Pool.ipynb%23try-cell-35" target="_blank" rel="nofollow">
    <div class="try-this">Try this!</div>
  </a>
</div>
<div class="input">
<div class="prompt input_prompt">In&nbsp;[18]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ocaml"><pre><span></span><span class="k">let</span> <span class="n">rank_transitivity</span> <span class="n">side</span> <span class="n">o1</span> <span class="n">o2</span> <span class="n">o3</span> <span class="n">mkt</span> <span class="o">=</span>
    <span class="n">order_higher_ranked</span><span class="o">(</span><span class="n">side</span><span class="o">,</span><span class="n">o1</span><span class="o">,</span><span class="n">o2</span><span class="o">,</span><span class="n">mkt</span><span class="o">)</span> <span class="o">&amp;&amp;</span>
    <span class="n">order_higher_ranked</span><span class="o">(</span><span class="n">side</span><span class="o">,</span><span class="n">o2</span><span class="o">,</span><span class="n">o3</span><span class="o">,</span><span class="n">mkt</span><span class="o">)</span>
    <span class="o">==&gt;</span>
    <span class="n">order_higher_ranked</span><span class="o">(</span><span class="n">side</span><span class="o">,</span><span class="n">o1</span><span class="o">,</span><span class="n">o3</span><span class="o">,</span><span class="n">mkt</span><span class="o">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[18]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>val rank_transitivity :
  order_side -&gt; order -&gt; order -&gt; order -&gt; mkt_data -&gt; bool = &lt;fun&gt;
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Now we can check whether this property of being transitive holds:</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="try-this-container">
  <a href="https://try.imandra.ai/launch/?next=/h/user-redirect/notebooks/Analysing%20the%20UBS%20ATS%20Dark%20Pool.ipynb%23try-cell-37" target="_blank" rel="nofollow">
    <div class="try-this">Try this!</div>
  </a>
</div>
<div class="input">
<div class="prompt input_prompt">In&nbsp;[19]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ocaml"><pre><span></span><span class="n">verify</span> <span class="o">(</span><span class="k">fun</span> <span class="n">side</span> <span class="n">o1</span> <span class="n">o2</span> <span class="n">o3</span> <span class="n">mkt</span> <span class="o">-&gt;</span> <span class="n">rank_transitivity</span> <span class="n">side</span> <span class="n">o1</span> <span class="n">o2</span> <span class="n">o3</span> <span class="n">mkt</span><span class="o">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[19]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>- : order_side -&gt; order -&gt; order -&gt; order -&gt; mkt_data -&gt; bool = &lt;fun&gt;
module CX :
  sig
    val side : order_side
    val o1 : order
    val o2 : order
    val o3 : order
    val mkt : mkt_data
  end
</pre>
</div>

</div>

<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div><pre>Counterexample (after 0 steps, 0.067s):
 let (side : order_side) = BUY
 let (o1 : order) =
  {id = 10; peg = NEAR; client_id = 11; order_type = PEGGED; qty = 12;
   min_qty = 13; leaves_qty = 18214; price = (Real.mk_of_string &quot;-56201/2&quot;);
   time = 0; src = 14; order_attr = RESIDENT; capacity = Principal;
   category = C_ONE;
   cross_restrict =
    {cr_self_cross = false; cr_ubs_principal = false;
     cr_round_lot_only = false; cr_no_locked_nbbo = false;
     cr_pegged_mid_point_mode = 9; cr_enable_conditionals = false;
     cr_min_qty = false;
     cr_cat_elig =
      {c_one_elig = false; c_two_elig = false; c_three_elig = false;
       c_four_elig = false}};
   locate_found = false; expiry_time = 15}
 let (o2 : order) =
  {id = 18; peg = NEAR; client_id = 19; order_type = PEGGED_CI; qty = 20;
   min_qty = 21; leaves_qty = 20652; price = 1008.0; time = 1; src = 22;
   order_attr = RESIDENT; capacity = Principal; category = C_ONE;
   cross_restrict =
    {cr_self_cross = false; cr_ubs_principal = false;
     cr_round_lot_only = false; cr_no_locked_nbbo = false;
     cr_pegged_mid_point_mode = 17; cr_enable_conditionals = false;
     cr_min_qty = false;
     cr_cat_elig =
      {c_one_elig = false; c_two_elig = false; c_three_elig = false;
       c_four_elig = false}};
   locate_found = false; expiry_time = 23}
 let (o3 : order) =
  {id = 3; peg = NEAR; client_id = 4; order_type = PEGGED_CI; qty = 5;
   min_qty = 6; leaves_qty = 20651; price = (Real.mk_of_string &quot;-1/2&quot;);
   time = (-1); src = 7; order_attr = RESIDENT; capacity = Principal;
   category = C_ONE;
   cross_restrict =
    {cr_self_cross = false; cr_ubs_principal = false;
     cr_round_lot_only = false; cr_no_locked_nbbo = false;
     cr_pegged_mid_point_mode = 2; cr_enable_conditionals = false;
     cr_min_qty = false;
     cr_cat_elig =
      {c_one_elig = false; c_two_elig = false; c_three_elig = false;
       c_four_elig = false}};
   locate_found = false; expiry_time = 8}
 let (mkt : mkt_data) =
  {nbb = (Real.mk_of_string &quot;2015/2&quot;); nbo = (Real.mk_of_string &quot;59207/2&quot;);
   l_up = 2.0; l_down = 3.0}
</pre></div>

</div>

</div>

<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div><div style="font-size: 1.2em; padding: 0.5em; border-top: 1px dashed #D84315; border-bottom: 1px dashed #D84315"><i class="fa fa-times-circle-o" style="margin-right: 0.5em; color: #D84315"></i><span>Refuted</span></div><div><div class="imandra-alternatives" id="alt-b905307f-3921-4389-8201-b2c117048b73"><ul class="nav nav-tabs"><li class="active" data-toggle="tab"><a>call graph</a></li><li class="" data-toggle="tab"><a>proof</a></li></ul><div class="tab-content"><div class="tab-pane active"><div class="imandra-graphviz" id="graphviz-b8c7b69d-f7ed-4dae-bbcb-6545711f9507"><textarea style="display: none">digraph &quot;call graph&quot; {
goal [label=&quot;let (_x_0 : order_type) = o1.order_type in\llet (_x_1 : bool) = Is_a(LIMIT, _x_0) in\llet (_x_2 : bool) = side = BUY in\llet (_x_3 : real) = if _x_2 then ….nbo else ….nbb in\llet (_x_4 : bool) = Is_a(MARKET, _x_0) in\llet (_x_5 : order_type) = o3.order_type in\llet (_x_6 : bool) = Is_a(LIMIT, _x_5) in\llet (_x_7 : bool) = Is_a(MARKET, _x_5) in\llet (_x_8 : int)\l    = if (if _x_4 then _x_3 else if _x_1 then … else …) =\l         (if _x_7 then _x_3 else if _x_6 then … else …)\l      then 0 else -1\lin\llet (_x_9 : bool) = Is_a(PEGGED, _x_5) \|\| Is_a(PEGGED_CI, _x_5) in\llet (_x_10 : bool) = Is_a(PEGGED, _x_0) \|\| Is_a(PEGGED_CI, _x_0) in\llet (_x_11 : int)\l    = if _x_2\l      then\l        if (if _x_4 then _x_3\l            else\l            if _x_1 then if _x_2 then … else …\l            else if _x_10 then … else …)\l           \&lt;=.\l           (if _x_7 then _x_3\l            else\l            if _x_6 then if _x_2 then … else …\l            else if _x_9 then … else …)\l        then _x_8 else 1\l      else\l      if (if _x_7 then _x_3\l          else\l          if _x_6 then if _x_2 then … else …\l          else if _x_9 then … else …)\l         \&lt;=.\l         (if _x_4 then _x_3\l          else\l          if _x_1 then if _x_2 then … else …\l          else if _x_10 then … else …)\l      then _x_8 else 1\lin\llet (_x_12 : int) = o3.time in\llet (_x_13 : int) = o1.time in\llet (_x_14 : bool) = _x_12 \&lt;= _x_13 in\llet (_x_15 : bool) = _x_0 = LIMIT_CI \|\| _x_0 = PEGGED_CI in\llet (_x_16 : bool) = not _x_15 in\llet (_x_17 : bool) = _x_5 = PEGGED_CI \|\| _x_5 = LIMIT_CI in\llet (_x_18 : bool) = not _x_17 in\llet (_x_19 : int) = o1.leaves_qty in\llet (_x_20 : int) = o3.leaves_qty in\llet (_x_21 : bool) = not (_x_19 \&lt;= _x_20) in\llet (_x_22 : order_type) = o2.order_type in\llet (_x_23 : bool) = Is_a(LIMIT, _x_22) in\llet (_x_24 : bool) = Is_a(MARKET, _x_22) in\llet (_x_25 : int)\l    = if (if _x_4 then _x_3 else if _x_1 then … else …) =\l         (if _x_24 then _x_3 else if _x_23 then … else …)\l      then 0 else -1\lin\llet (_x_26 : bool) = Is_a(PEGGED, _x_22) \|\| Is_a(PEGGED_CI, _x_22) in\llet (_x_27 : int)\l    = if _x_2\l      then\l        if (if _x_4 then _x_3\l            else\l            if _x_1 then if _x_2 then … else …\l            else if _x_10 then … else …)\l           \&lt;=.\l           (if _x_24 then _x_3\l            else\l            if _x_23 then if _x_2 then … else …\l            else if _x_26 then … else …)\l        then _x_25 else 1\l      else\l      if (if _x_24 then _x_3\l          else\l          if _x_23 then if _x_2 then … else …\l          else if _x_26 then … else …)\l         \&lt;=.\l         (if _x_4 then _x_3\l          else\l          if _x_1 then if _x_2 then … else …\l          else if _x_10 then … else …)\l      then _x_25 else 1\lin\llet (_x_28 : int) = o2.time in\llet (_x_29 : bool) = _x_28 \&lt;= _x_13 in\llet (_x_30 : bool) = _x_22 = LIMIT_CI \|\| _x_22 = PEGGED_CI in\llet (_x_31 : bool) = not _x_30 in\llet (_x_32 : int) = o2.leaves_qty in\llet (_x_33 : bool) = not (_x_19 \&lt;= _x_32) in\llet (_x_34 : int)\l    = if (if _x_24 then _x_3 else if _x_23 then … else …) =\l         (if _x_7 then _x_3 else if _x_6 then … else …)\l      then 0 else -1\lin\llet (_x_35 : int)\l    = if _x_2\l      then\l        if (if _x_24 then _x_3\l            else\l            if _x_23 then if _x_2 then … else …\l            else if _x_26 then … else …)\l           \&lt;=.\l           (if _x_7 then _x_3\l            else\l            if _x_6 then if _x_2 then … else …\l            else if _x_9 then … else …)\l        then _x_34 else 1\l      else\l      if (if _x_7 then _x_3\l          else\l          if _x_6 then if _x_2 then … else …\l          else if _x_9 then … else …)\l         \&lt;=.\l         (if _x_24 then _x_3\l          else\l          if _x_23 then if _x_2 then … else …\l          else if _x_26 then … else …)\l      then _x_34 else 1\lin\llet (_x_36 : bool) = _x_12 \&lt;= _x_28 in\llet (_x_37 : bool) = not (_x_32 \&lt;= _x_20) in\lnot\l((_x_11 = 1\l  \|\| not (_x_11 = -1)\l     &amp;&amp; (if _x_15 &amp;&amp; _x_17 then _x_21\l         else\l           (not _x_14\l            \|\| not (_x_14 &amp;&amp; not (_x_13 = _x_12))\l               &amp;&amp; (_x_16 \|\| not (_x_15 &amp;&amp; _x_18) &amp;&amp; _x_21))))\l \|\| not\l    ((_x_27 = 1\l      \|\| not (_x_27 = -1)\l         &amp;&amp; (if _x_15 &amp;&amp; _x_30 then _x_33\l             else\l               (not _x_29\l                \|\| not (_x_29 &amp;&amp; not (_x_13 = _x_28))\l                   &amp;&amp; (_x_16 \|\| not (_x_15 &amp;&amp; _x_31) &amp;&amp; _x_33))))\l     &amp;&amp; (_x_35 = 1\l         \|\| not (_x_35 = -1)\l            &amp;&amp; (if _x_30 &amp;&amp; _x_17 then _x_37\l                else\l                  (not _x_36\l                   \|\| not (_x_36 &amp;&amp; not (_x_28 = _x_12))\l                      &amp;&amp; (_x_31 \|\| not (_x_30 &amp;&amp; _x_18) &amp;&amp; _x_37))))))&quot;,shape=box,style=filled,color=&quot;cyan&quot;,fontname=&quot;courier&quot;,fontsize=14];
}
</textarea><button class="btn btn-primary">Load graph</button><div class="imandra-graphviz-loading display-none">Loading..</div><div class="imandra-graphviz-target"></div><script>
require(['nbextensions/nbimandra/graphviz'], function (graphviz) {
  var target = '#graphviz-b8c7b69d-f7ed-4dae-bbcb-6545711f9507';
  graphviz.hydrate(target);
});
</script></div></div><div class="tab-pane"><div class="imandra-proof-top"><div class="imandra-fold panel panel-default" id="fold-17347c99-eaa7-4266-8d9e-f9b3c1875fb8"><div class="panel-heading"><div><i class="fa fa-chevron-down hidden"></i><i class="fa fa-chevron-right"></i><span>proof attempt</span></div></div><div class="panel-body collapse"><div class="imandra-proof"><div class="imandra-alternatives" id="alt-de0d1925-83b9-4a6c-a5bb-5c72b42dea57"><ul class="nav nav-tabs"><li class="active" data-toggle="tab"><a>summary</a></li><li class="" data-toggle="tab"><a>full</a></li><li class="" data-toggle="tab"><a>graph</a></li></ul><div class="tab-content"><div class="tab-pane active"><div class="imandra-table" id="table-951aedfe-9901-41b5-accc-f7a8b6b2ef31"><table><tr><td><b>ground_instances</b></td><td>0</td></tr><tr><td><b>definitions</b></td><td>0</td></tr><tr><td><b>inductions</b></td><td>0</td></tr><tr><td><b>search_time</b></td><td><pre>0.069s</pre></td></tr><tr><td><b>details</b></td><td><div class="imandra-fold panel panel-default" id="fold-6a0311df-7530-42c2-bd9d-68ff7d8f25dd"><div class="panel-heading"><div><i class="fa fa-chevron-down hidden"></i><i class="fa fa-chevron-right"></i><span>Expand</span></div></div><div class="panel-body collapse"><div class="imandra-table" id="table-b60acab4-e068-4c78-99ec-517c8e5763b3"><table><tr><td><b>smt_stats</b></td><td><div class="imandra-table" id="table-b950a428-2fe7-48a6-bb9b-2851b5481fbb"><table><tr><td><b>num checks</b></td><td>1</td></tr><tr><td><b>arith-assume-eqs</b></td><td>2</td></tr><tr><td><b>arith-make-feasible</b></td><td>83</td></tr><tr><td><b>arith-max-columns</b></td><td>50</td></tr><tr><td><b>arith-conflicts</b></td><td>3</td></tr><tr><td><b>rlimit count</b></td><td>53863</td></tr><tr><td><b>arith-cheap-eqs</b></td><td>61</td></tr><tr><td><b>mk clause</b></td><td>626</td></tr><tr><td><b>datatype occurs check</b></td><td>21</td></tr><tr><td><b>mk bool var</b></td><td>788</td></tr><tr><td><b>arith-lower</b></td><td>86</td></tr><tr><td><b>arith-diseq</b></td><td>58</td></tr><tr><td><b>datatype splits</b></td><td>50</td></tr><tr><td><b>decisions</b></td><td>998</td></tr><tr><td><b>arith-propagations</b></td><td>20</td></tr><tr><td><b>propagations</b></td><td>1214</td></tr><tr><td><b>interface eqs</b></td><td>2</td></tr><tr><td><b>arith-bound-propagations-cheap</b></td><td>20</td></tr><tr><td><b>arith-max-rows</b></td><td>29</td></tr><tr><td><b>conflicts</b></td><td>20</td></tr><tr><td><b>datatype accessor ax</b></td><td>58</td></tr><tr><td><b>arith-bound-propagations-lp</b></td><td>16</td></tr><tr><td><b>datatype constructor ax</b></td><td>175</td></tr><tr><td><b>num allocs</b></td><td>4610371</td></tr><tr><td><b>final checks</b></td><td>3</td></tr><tr><td><b>added eqs</b></td><td>1357</td></tr><tr><td><b>del clause</b></td><td>131</td></tr><tr><td><b>arith eq adapter</b></td><td>43</td></tr><tr><td><b>arith-upper</b></td><td>56</td></tr><tr><td><b>time</b></td><td>0.037000</td></tr><tr><td><b>memory</b></td><td>11.580000</td></tr><tr><td><b>max memory</b></td><td>12.600000</td></tr></table></div></td></tr></table></div></div><script>
require(['nbextensions/nbimandra/fold'], function (fold) {
  var target = '#fold-6a0311df-7530-42c2-bd9d-68ff7d8f25dd';
  fold.hydrate(target);
});
</script></div></td></tr></table></div></div><div class="tab-pane"><div class="imandra-fold panel panel-default" id="fold-9c5ef4e2-688c-4eea-847b-d8f9c5d25674"><div class="panel-heading"><div><i class="fa fa-chevron-down hidden"></i><i class="fa fa-chevron-right"></i><span>Expand</span></div></div><div class="panel-body collapse"><ul><li><pre>start[0.069s]
  let (_x_0 : int) = ( :var_1: ).time in
  let (_x_1 : int) = ( :var_2: ).time in
  let (_x_2 : int) = ( :var_1: ).leaves_qty in
  let (_x_3 : int) = ( :var_2: ).leaves_qty in
  let (_x_4 : order_type) = ( :var_1: ).order_type in
  let (_x_5 : bool) = _x_4 = PEGGED_CI || _x_4 = LIMIT_CI in
  let (_x_6 : order_type) = ( :var_2: ).order_type in
  let (_x_7 : bool) = _x_6 = PEGGED_CI || _x_6 = LIMIT_CI in
  let (_x_8 : order_type) = ….1.order_type in
  let (_x_9 : bool) = Is_a(LIMIT, _x_8) in
  let (_x_10 : bool) = ….0 = BUY in
  let (_x_11 : real) = if _x_10 then ….nbo else ….nbb in
  let (_x_12 : bool) = Is_a(MARKET, _x_8) in
  let (_x_13 : order_type) = ….1.order_type in
  let (_x_14 : bool) = Is_a(LIMIT, _x_13) in
  let (_x_15 : bool) = ….0 = BUY in
  let (_x_16 : real) = if _x_15 then ….nbo else ….nbb in
  let (_x_17 : bool) = Is_a(MARKET, _x_13) in
  let (_x_18 : int)
      = if (if _x_12 then _x_11 else if _x_9 then … else …) =
           (if _x_17 then _x_16 else if _x_14 then … else …)
        then 0 else -1
  in
  let (_x_19 : bool) = Is_a(PEGGED, _x_8) in
  let (_x_20 : bool) = Is_a(PEGGED, _x_13) in
  let (_x_21 : bool) = ( :var_0: ) = BUY in
  let (_x_22 : int)
      = if _x_21
        then
          if (if _x_12 then _x_11
              else
              if _x_9 then if _x_10 then … else …
              else if _x_19 then … else …)
             &gt;.
             (if _x_17 then _x_16
              else
              if _x_14 then if _x_15 then … else …
              else if _x_20 then … else …)
          then 1 else _x_18
        else
        if (if _x_12 then _x_11
            else
            if _x_9 then if _x_10 then … else …
            else if _x_19 then … else …)
           &lt;.
           (if _x_17 then _x_16
            else
            if _x_14 then if _x_15 then … else …
            else if _x_20 then … else …)
        then 1 else _x_18
  in
  let (_x_23 : int) = ( :var_4: ).time in
  let (_x_24 : int) = ( :var_4: ).leaves_qty in
  let (_x_25 : order_type) = ( :var_4: ).order_type in
  let (_x_26 : bool) = _x_25 = PEGGED_CI || _x_25 = LIMIT_CI in
  let (_x_27 : order_type) = ….1.order_type in
  let (_x_28 : bool) = Is_a(LIMIT, _x_27) in
  let (_x_29 : bool) = ….0 = BUY in
  let (_x_30 : real) = if _x_29 then ….nbo else ….nbb in
  let (_x_31 : bool) = Is_a(MARKET, _x_27) in
  let (_x_32 : order_type) = ….1.order_type in
  let (_x_33 : bool) = Is_a(LIMIT, _x_32) in
  let (_x_34 : bool) = ….0 = BUY in
  let (_x_35 : real) = if _x_34 then ….nbo else ….nbb in
  let (_x_36 : bool) = Is_a(MARKET, _x_32) in
  let (_x_37 : int)
      = if (if _x_31 then _x_30 else if _x_28 then … else …) =
           (if _x_36 then _x_35 else if _x_33 then … else …)
        then 0 else -1
  in
  let (_x_38 : bool) = Is_a(PEGGED, _x_27) in
  let (_x_39 : bool) = Is_a(PEGGED, _x_32) in
  let (_x_40 : int)
      = if _x_21
        then
          if (if _x_31 then _x_30
              else
              if _x_28 then if _x_29 then … else …
              else if _x_38 then … else …)
             &gt;.
             (if _x_36 then _x_35
              else
              if _x_33 then if _x_34 then … else …
              else if _x_39 then … else …)
          then 1 else _x_37
        else
        if (if _x_31 then _x_30
            else
            if _x_28 then if _x_29 then … else …
            else if _x_38 then … else …)
           &lt;.
           (if _x_36 then _x_35
            else
            if _x_33 then if _x_34 then … else …
            else if _x_39 then … else …)
        then 1 else _x_37
  in
  let (_x_41 : order_type) = ….order_type in
  let (_x_42 : bool) = Is_a(LIMIT, _x_41) in
  let (_x_43 : bool) = ….0 = BUY in
  let (_x_44 : real) = if _x_43 then … else … in
  let (_x_45 : bool) = Is_a(MARKET, _x_41) in
  let (_x_46 : order_type) = ….order_type in
  let (_x_47 : bool) = Is_a(LIMIT, _x_46) in
  let (_x_48 : bool) = ….0 = BUY in
  let (_x_49 : real) = if _x_48 then … else … in
  let (_x_50 : bool) = Is_a(MARKET, _x_46) in
  let (_x_51 : int)
      = if (if _x_45 then _x_44 else if _x_42 then … else …) =
           (if _x_50 then _x_49 else if _x_47 then … else …)
        then 0 else -1
  in
  let (_x_52 : order_type) = ….1.order_type in
  let (_x_53 : bool) = Is_a(PEGGED, _x_52) in
  let (_x_54 : order_type) = ….1.order_type in
  let (_x_55 : bool) = ….0 = BUY in
  let (_x_56 : bool) = ….0 = BUY in
  let (_x_57 : int)
      = if _x_21
        then
          if (if Is_a(MARKET, _x_54) then if _x_55 then ….nbo else ….nbb
              else
              if Is_a(LIMIT, _x_54) then if _x_55 then … else …
              else if Is_a(PEGGED, _x_54) then … else …)
             &gt;.
             (if Is_a(MARKET, _x_52) then if _x_56 then ….nbo else ….nbb
              else
              if Is_a(LIMIT, _x_52) then if _x_56 then … else …
              else if _x_53 then … else …)
          then 1 else _x_51
        else
        if (if _x_45 then _x_44
            else
            if _x_42 then if _x_43 then … else …
            else if Is_a(PEGGED, _x_41) then … else …)
           &lt;.
           (if _x_50 then _x_49
            else
            if _x_47 then if _x_48 then … else …
            else if _x_53 then … else …)
        then 1 else _x_51
  in
  (if _x_22 = 1 then true
   else
   if _x_22 = -1 then false
   else
   if _x_5 &amp;&amp; _x_7 then _x_2 &gt; _x_3
   else if (if _x_0 &lt; _x_1 then 1 else …) = 1 then true else …)
  &amp;&amp; (if _x_40 = 1 then true
      else
      if _x_40 = -1 then false
      else
      if _x_7 &amp;&amp; _x_26 then _x_3 &gt; _x_24
      else if (if _x_1 &lt; _x_23 then 1 else …) = 1 then true else …)
  ==&gt; (if _x_57 = 1 then true
       else
       if _x_57 = -1 then false
       else
       if _x_5 &amp;&amp; _x_26 then _x_2 &gt; _x_24
       else if (if _x_0 &lt; _x_23 then 1 else …) = 1 then true else …)</pre></li><li><div><h4>simplify</h4><div class="imandra-table" id="table-6285f4bb-60aa-4165-85c5-cccc05dbec74"><table><tr><td><b>into</b></td><td><pre>let (_x_0 : bool) = Is_a(LIMIT, …) in
let (_x_1 : bool) = ( :var_0: ) = BUY in
let (_x_2 : real) = if _x_1 then … else … in
let (_x_3 : bool) = Is_a(MARKET, …) in
let (_x_4 : order_type) = ( :var_4: ).order_type in
let (_x_5 : bool) = Is_a(LIMIT, _x_4) in
let (_x_6 : bool) = Is_a(MARKET, _x_4) in
let (_x_7 : int)
    = if (if _x_3 then _x_2 else if _x_0 then … else …) =
         (if _x_6 then _x_2 else if _x_5 then … else …)
      then 0 else -1
in
let (_x_8 : bool) = Is_a(PEGGED, _x_4) || Is_a(PEGGED_CI, _x_4) in
let (_x_9 : real) = if _x_1 then ( :var_3: ).nbo else ( :var_3: ).nbb in
let (_x_10 : bool) = Is_a(PEGGED, …) || Is_a(PEGGED_CI, …) in
let (_x_11 : order_type) = ( :var_1: ).order_type in
let (_x_12 : bool) = Is_a(LIMIT, _x_11) in
let (_x_13 : bool) = Is_a(MARKET, _x_11) in
let (_x_14 : int)
    = if (if _x_6 then _x_9
          else
          if _x_5 then if _x_1 then … else …
          else if _x_8 then … else …)
         &lt;=.
         (if _x_13 then _x_9
          else
          if _x_12 then if _x_1 then … else …
          else if _x_10 then … else …)
      then _x_7 else 1
in
let (_x_15 : int) = ( :var_4: ).time in
let (_x_16 : int) = ( :var_1: ).time in
let (_x_17 : bool) = _x_15 &lt;= _x_16 in
let (_x_18 : bool) = … = LIMIT_CI || … = PEGGED_CI in
let (_x_19 : bool) = not _x_18 in
let (_x_20 : bool) = _x_4 = PEGGED_CI || _x_4 = LIMIT_CI in
let (_x_21 : bool) = not _x_20 in
let (_x_22 : int) = ( :var_1: ).leaves_qty in
let (_x_23 : int) = ( :var_4: ).leaves_qty in
let (_x_24 : bool) = not (_x_22 &lt;= _x_23) in
let (_x_25 : order_type) = ( :var_2: ).order_type in
let (_x_26 : bool) = Is_a(LIMIT, _x_25) in
let (_x_27 : bool) = Is_a(MARKET, _x_25) in
let (_x_28 : int)
    = if (if _x_3 then _x_2 else if _x_0 then … else …) =
         (if _x_27 then _x_2 else if _x_26 then … else …)
      then 0 else -1
in
let (_x_29 : bool) = Is_a(PEGGED, _x_25) || Is_a(PEGGED_CI, _x_25) in
let (_x_30 : int)
    = if _x_1
      then
        if (if _x_3 then _x_2
            else
            if _x_0 then if _x_1 then … else …
            else if _x_10 then … else …)
           &lt;=.
           (if _x_27 then _x_2
            else
            if _x_26 then if _x_1 then … else …
            else if _x_29 then … else …)
        then _x_28 else 1
      else
      if (if _x_27 then _x_2
          else
          if _x_26 then if _x_1 then … else …
          else if _x_29 then … else …)
         &lt;=.
         (if _x_3 then _x_2
          else
          if _x_0 then if _x_1 then … else …
          else if _x_10 then … else …)
      then _x_28 else 1
in
let (_x_31 : int) = ( :var_2: ).time in
let (_x_32 : bool) = _x_31 &lt;= _x_16 in
let (_x_33 : bool) = _x_25 = LIMIT_CI || _x_25 = PEGGED_CI in
let (_x_34 : bool) = not _x_33 in
let (_x_35 : int) = ( :var_2: ).leaves_qty in
let (_x_36 : bool) = not (_x_22 &lt;= _x_35) in
let (_x_37 : int)
    = if (if _x_27 then _x_2 else if _x_26 then … else …) =
         (if _x_6 then _x_2 else if _x_5 then … else …)
      then 0 else -1
in
let (_x_38 : int)
    = if _x_1
      then
        if (if _x_27 then _x_2
            else
            if _x_26 then if _x_1 then … else …
            else if _x_29 then … else …)
           &lt;=.
           (if _x_6 then _x_2
            else
            if _x_5 then if _x_1 then … else …
            else if _x_8 then … else …)
        then _x_37 else 1
      else
      if (if _x_6 then _x_2
          else
          if _x_5 then if _x_1 then … else …
          else if _x_8 then … else …)
         &lt;=.
         (if _x_27 then _x_2
          else
          if _x_26 then if _x_1 then … else …
          else if _x_29 then … else …)
      then _x_37 else 1
in
let (_x_39 : bool) = _x_15 &lt;= _x_31 in
let (_x_40 : bool) = not (_x_35 &lt;= _x_23) in
((if _x_1
  then
    if (if _x_13 then _x_9
        else
        if _x_12 then if _x_1 then … else …
        else
        if Is_a(PEGGED, _x_11) || Is_a(PEGGED_CI, _x_11) then … else …)
       &lt;=.
       (if _x_6 then _x_9
        else
        if _x_5 then if _x_1 then … else … else if _x_8 then … else …)
    then
      if (if _x_13 then _x_9 else if _x_12 then … else …) =
         (if _x_6 then _x_9 else if _x_5 then … else …)
      then 0 else -1
    else 1
  else _x_14)
 = 1
 || not
    ((if _x_1
      then
        if (if _x_3 then _x_2
            else
            if _x_0 then if _x_1 then … else …
            else if _x_10 then … else …)
           &lt;=.
           (if _x_6 then _x_2
            else
            if _x_5 then if _x_1 then … else …
            else if _x_8 then … else …)
        then _x_7 else 1
      else _x_14)
     = -1)
    &amp;&amp; (if _x_18 &amp;&amp; _x_20 then _x_24
        else
          (not _x_17
           || not (_x_17 &amp;&amp; not (_x_16 = _x_15))
              &amp;&amp; (_x_19 || not (_x_18 &amp;&amp; _x_21) &amp;&amp; _x_24))))
|| not
   ((_x_30 = 1
     || not (_x_30 = -1)
        &amp;&amp; (if _x_18 &amp;&amp; _x_33 then _x_36
            else
              (not _x_32
               || not (_x_32 &amp;&amp; not (_x_16 = _x_31))
                  &amp;&amp; (_x_19 || not (_x_18 &amp;&amp; _x_34) &amp;&amp; _x_36))))
    &amp;&amp; (_x_38 = 1
        || not (_x_38 = -1)
           &amp;&amp; (if _x_33 &amp;&amp; _x_20 then _x_40
               else
                 (not _x_39
                  || not (_x_39 &amp;&amp; not (_x_31 = _x_15))
                     &amp;&amp; (_x_34 || not (_x_33 &amp;&amp; _x_21) &amp;&amp; _x_40)))))</pre></td></tr><tr><td><b>expansions</b></td><td><pre>[]</pre></td></tr><tr><td><b>rewrite_steps</b></td><td><ul></ul></td></tr><tr><td><b>forward_chaining</b></td><td><ul></ul></td></tr></table></div></div></li><li>Sat (Some  let (side : order_side) = BUY
 let (o1 : order) =
  {id = 10; peg = NEAR; client_id = 11; order_type = PEGGED; qty = 12;
   min_qty = 13; leaves_qty = 18214; price = (Real.mk_of_string &quot;-56201/2&quot;);
   time = 0; src = 14; order_attr = RESIDENT; capacity = Principal;
   category = C_ONE;
   cross_restrict =
    {cr_self_cross = false; cr_ubs_principal = false;
     cr_round_lot_only = false; cr_no_locked_nbbo = false;
     cr_pegged_mid_point_mode = 9; cr_enable_conditionals = false;
     cr_min_qty = false;
     cr_cat_elig =
      {c_one_elig = false; c_two_elig = false; c_three_elig = false;
       c_four_elig = false}};
   locate_found = false; expiry_time = 15}
 let (o2 : order) =
  {id = 18; peg = NEAR; client_id = 19; order_type = PEGGED_CI; qty = 20;
   min_qty = 21; leaves_qty = 20652; price = 1008.0; time = 1; src = 22;
   order_attr = RESIDENT; capacity = Principal; category = C_ONE;
   cross_restrict =
    {cr_self_cross = false; cr_ubs_principal = false;
     cr_round_lot_only = false; cr_no_locked_nbbo = false;
     cr_pegged_mid_point_mode = 17; cr_enable_conditionals = false;
     cr_min_qty = false;
     cr_cat_elig =
      {c_one_elig = false; c_two_elig = false; c_three_elig = false;
       c_four_elig = false}};
   locate_found = false; expiry_time = 23}
 let (o3 : order) =
  {id = 3; peg = NEAR; client_id = 4; order_type = PEGGED_CI; qty = 5;
   min_qty = 6; leaves_qty = 20651; price = (Real.mk_of_string &quot;-1/2&quot;);
   time = (-1); src = 7; order_attr = RESIDENT; capacity = Principal;
   category = C_ONE;
   cross_restrict =
    {cr_self_cross = false; cr_ubs_principal = false;
     cr_round_lot_only = false; cr_no_locked_nbbo = false;
     cr_pegged_mid_point_mode = 2; cr_enable_conditionals = false;
     cr_min_qty = false;
     cr_cat_elig =
      {c_one_elig = false; c_two_elig = false; c_three_elig = false;
       c_four_elig = false}};
   locate_found = false; expiry_time = 8}
 let (mkt : mkt_data) =
  {nbb = (Real.mk_of_string &quot;2015/2&quot;); nbo = (Real.mk_of_string &quot;59207/2&quot;);
   l_up = 2.0; l_down = 3.0}
)</li></ul></div><script>
require(['nbextensions/nbimandra/fold'], function (fold) {
  var target = '#fold-9c5ef4e2-688c-4eea-847b-d8f9c5d25674';
  fold.hydrate(target);
});
</script></div></div><div class="tab-pane"><div class="imandra-graphviz" id="graphviz-6af77f3a-614b-402f-88b4-77ae3fd9e0ce"><textarea style="display: none">digraph &quot;proof&quot; {
p_2 [label=&quot;Start (let (_x_0 : int) = ( :var_1: ).time in\l       let (_x_1 : int) = ( :var_2: ).time in\l       let (_x_2 : int) = ( :var_1: ).leaves_qty in\l       let (_x_3 : int) = ( :var_2: ).leaves_qty in\l       let (_x_4 : order_type) = ( :var_1: ).order_type in\l       let (_x_5 : bool) = _x_4 = PEGGED_CI \|\| _x_4 = LIMIT_CI in\l       let (_x_6 : order_type) = ( :var_2: ).order_type in\l       let (_x_7 : bool) = _x_6 = PEGGED_CI \|\| _x_6 = LIMIT_CI in\l       let (_x_8 : order_type) = ….1.order_type in\l       let (_x_9 : bool) = Is_a(LIMIT, _x_8) in\l       let (_x_10 : bool) = ….0 = BUY in\l       let (_x_11 : real) = if _x_10 then ….nbo else ….nbb in\l       let (_x_12 : bool) = Is_a(MARKET, _x_8) in\l       let (_x_13 : order_type) = ….1.order_type in\l       let (_x_14 : bool) = Is_a(LIMIT, _x_13) in\l       let (_x_15 : bool) = ….0 = BUY in\l       let (_x_16 : real) = if _x_15 then ….nbo else ….nbb in\l       let (_x_17 : bool) = Is_a(MARKET, _x_13) in\l       let (_x_18 : int)\l           = if (if _x_12 then _x_11 else if _x_9 then … else …) =\l                (if _x_17 then _x_16 else if _x_14 then … else …)\l             then 0 else -1\l       in\l       let (_x_19 : bool) = Is_a(PEGGED, _x_8) in\l       let (_x_20 : bool) = Is_a(PEGGED, _x_13) in\l       let (_x_21 : bool) = ( :var_0: ) = BUY in\l       let (_x_22 : int)\l           = if _x_21\l             then\l               if (if _x_12 then _x_11\l                   else\l                   if _x_9 then if _x_10 then … else …\l                   else if _x_19 then … else …)\l                  \&gt;.\l                  (if _x_17 then _x_16\l                   else\l                   if _x_14 then if _x_15 then … else …\l                   else if _x_20 then … else …)\l               then 1 else _x_18\l             else\l             if (if _x_12 then _x_11\l                 else\l                 if _x_9 then if _x_10 then … else …\l                 else if _x_19 then … else …)\l                \&lt;.\l                (if _x_17 then _x_16\l                 else\l                 if _x_14 then if _x_15 then … else …\l                 else if _x_20 then … else …)\l             then 1 else _x_18\l       in\l       let (_x_23 : int) = ( :var_4: ).time in\l       let (_x_24 : int) = ( :var_4: ).leaves_qty in\l       let (_x_25 : order_type) = ( :var_4: ).order_type in\l       let (_x_26 : bool) = _x_25 = PEGGED_CI \|\| _x_25 = LIMIT_CI in\l       let (_x_27 : order_type) = ….1.order_type in\l       let (_x_28 : bool) = Is_a(LIMIT, _x_27) in\l       let (_x_29 : bool) = ….0 = BUY in\l       let (_x_30 : real) = if _x_29 then ….nbo else ….nbb in\l       let (_x_31 : bool) = Is_a(MARKET, _x_27) in\l       let (_x_32 : order_type) = ….1.order_type in\l       let (_x_33 : bool) = Is_a(LIMIT, _x_32) in\l       let (_x_34 : bool) = ….0 = BUY in\l       let (_x_35 : real) = if _x_34 then ….nbo else ….nbb in\l       let (_x_36 : bool) = Is_a(MARKET, _x_32) in\l       let (_x_37 : int)\l           = if (if _x_31 then _x_30 else if _x_28 then … else …) =\l                (if _x_36 then _x_35 else if _x_33 then … else …)\l             then 0 else -1\l       in\l       let (_x_38 : bool) = Is_a(PEGGED, _x_27) in\l       let (_x_39 : bool) = Is_a(PEGGED, _x_32) in\l       let (_x_40 : int)\l           = if _x_21\l             then\l               if (if _x_31 then _x_30\l                   else\l                   if _x_28 then if _x_29 then … else …\l                   else if _x_38 then … else …)\l                  \&gt;.\l                  (if _x_36 then _x_35\l                   else\l                   if _x_33 then if _x_34 then … else …\l                   else if _x_39 then … else …)\l               then 1 else _x_37\l             else\l             if (if _x_31 then _x_30\l                 else\l                 if _x_28 then if _x_29 then … else …\l                 else if _x_38 then … else …)\l                \&lt;.\l                (if _x_36 then _x_35\l                 else\l                 if _x_33 then if _x_34 then … else …\l                 else if _x_39 then … else …)\l             then 1 else _x_37\l       in\l       let (_x_41 : order_type) = ….order_type in\l       let (_x_42 : bool) = Is_a(LIMIT, _x_41) in\l       let (_x_43 : bool) = ….0 = BUY in\l       let (_x_44 : real) = if _x_43 then … else … in\l       let (_x_45 : bool) = Is_a(MARKET, _x_41) in\l       let (_x_46 : order_type) = ….order_type in\l       let (_x_47 : bool) = Is_a(LIMIT, _x_46) in\l       let (_x_48 : bool) = ….0 = BUY in\l       let (_x_49 : real) = if _x_48 then … else … in\l       let (_x_50 : bool) = Is_a(MARKET, _x_46) in\l       let (_x_51 : int)\l           = if (if _x_45 then _x_44 else if _x_42 then … else …) =\l                (if _x_50 then _x_49 else if _x_47 then … else …)\l             then 0 else -1\l       in\l       let (_x_52 : order_type) = ….1.order_type in\l       let (_x_53 : bool) = Is_a(PEGGED, _x_52) in\l       let (_x_54 : order_type) = ….1.order_type in\l       let (_x_55 : bool) = ….0 = BUY in\l       let (_x_56 : bool) = ….0 = BUY in\l       let (_x_57 : int)\l           = if _x_21\l             then\l               if (if Is_a(MARKET, _x_54)\l                   then if _x_55 then ….nbo else ….nbb\l                   else\l                   if Is_a(LIMIT, _x_54) then if _x_55 then … else …\l                   else if Is_a(PEGGED, _x_54) then … else …)\l                  \&gt;.\l                  (if Is_a(MARKET, _x_52)\l                   then if _x_56 then ….nbo else ….nbb\l                   else\l                   if Is_a(LIMIT, _x_52) then if _x_56 then … else …\l                   else if _x_53 then … else …)\l               then 1 else _x_51\l             else\l             if (if _x_45 then _x_44\l                 else\l                 if _x_42 then if _x_43 then … else …\l                 else if Is_a(PEGGED, _x_41) then … else …)\l                \&lt;.\l                (if _x_50 then _x_49\l                 else\l                 if _x_47 then if _x_48 then … else …\l                 else if _x_53 then … else …)\l             then 1 else _x_51\l       in\l       (if _x_22 = 1 then true\l        else\l        if _x_22 = -1 then false\l        else\l        if _x_5 &amp;&amp; _x_7 then _x_2 \&gt; _x_3\l        else if (if _x_0 \&lt; _x_1 then 1 else …) = 1 then true else …)\l       &amp;&amp; (if _x_40 = 1 then true\l           else\l           if _x_40 = -1 then false\l           else\l           if _x_7 &amp;&amp; _x_26 then _x_3 \&gt; _x_24\l           else if (if _x_1 \&lt; _x_23 then 1 else …) = 1 then true else …)\l       ==\&gt; (if _x_57 = 1 then true\l            else\l            if _x_57 = -1 then false\l            else\l            if _x_5 &amp;&amp; _x_26 then _x_2 \&gt; _x_24\l            else if (if _x_0 \&lt; _x_23 then 1 else …) = 1 then true else …)\l       :time 0.069s)&quot;,shape=box,style=filled,fontname=&quot;courier&quot;,fontsize=14];
p_2 -&gt; p_1 [label=&quot;&quot;];
p_1 [label=&quot;Simplify (let (_x_0 : bool) = Is_a(LIMIT, …) in\l          let (_x_1 : bool) = ( :var_0: ) = BUY in\l          let (_x_2 : real) = if _x_1 then … else … in\l          let (_x_3 : bool) = Is_a(MARKET, …) in\l          let (_x_4 : order_type) = ( :var_4: ).order_type in\l          let (_x_5 : bool) = Is_a(LIMIT, _x_4) in\l          let (_x_6 : bool) = Is_a(MARKET, _x_4) in\l          let (_x_7 : int)\l              = if (if _x_3 then _x_2 else if _x_0 then … else …) =\l                   (if _x_6 then _x_2 else if _x_5 then … else …)\l                then 0 else -1\l          in\l          let (_x_8 : bool) = Is_a(PEGGED, _x_4) \|\| Is_a(PEGGED_CI, _x_4) in\l          let (_x_9 : real)\l              = if _x_1 then ( :var_3: ).nbo else ( :var_3: ).nbb\l          in\l          let (_x_10 : bool) = Is_a(PEGGED, …) \|\| Is_a(PEGGED_CI, …) in\l          let (_x_11 : order_type) = ( :var_1: ).order_type in\l          let (_x_12 : bool) = Is_a(LIMIT, _x_11) in\l          let (_x_13 : bool) = Is_a(MARKET, _x_11) in\l          let (_x_14 : int)\l              = if (if _x_6 then _x_9\l                    else\l                    if _x_5 then if _x_1 then … else …\l                    else if _x_8 then … else …)\l                   \&lt;=.\l                   (if _x_13 then _x_9\l                    else\l                    if _x_12 then if _x_1 then … else …\l                    else if _x_10 then … else …)\l                then _x_7 else 1\l          in\l          let (_x_15 : int) = ( :var_4: ).time in\l          let (_x_16 : int) = ( :var_1: ).time in\l          let (_x_17 : bool) = _x_15 \&lt;= _x_16 in\l          let (_x_18 : bool) = … = LIMIT_CI \|\| … = PEGGED_CI in\l          let (_x_19 : bool) = not _x_18 in\l          let (_x_20 : bool) = _x_4 = PEGGED_CI \|\| _x_4 = LIMIT_CI in\l          let (_x_21 : bool) = not _x_20 in\l          let (_x_22 : int) = ( :var_1: ).leaves_qty in\l          let (_x_23 : int) = ( :var_4: ).leaves_qty in\l          let (_x_24 : bool) = not (_x_22 \&lt;= _x_23) in\l          let (_x_25 : order_type) = ( :var_2: ).order_type in\l          let (_x_26 : bool) = Is_a(LIMIT, _x_25) in\l          let (_x_27 : bool) = Is_a(MARKET, _x_25) in\l          let (_x_28 : int)\l              = if (if _x_3 then _x_2 else if _x_0 then … else …) =\l                   (if _x_27 then _x_2 else if _x_26 then … else …)\l                then 0 else -1\l          in\l          let (_x_29 : bool) = Is_a(PEGGED, _x_25) \|\| Is_a(PEGGED_CI, _x_25)\l          in\l          let (_x_30 : int)\l              = if _x_1\l                then\l                  if (if _x_3 then _x_2\l                      else\l                      if _x_0 then if _x_1 then … else …\l                      else if _x_10 then … else …)\l                     \&lt;=.\l                     (if _x_27 then _x_2\l                      else\l                      if _x_26 then if _x_1 then … else …\l                      else if _x_29 then … else …)\l                  then _x_28 else 1\l                else\l                if (if _x_27 then _x_2\l                    else\l                    if _x_26 then if _x_1 then … else …\l                    else if _x_29 then … else …)\l                   \&lt;=.\l                   (if _x_3 then _x_2\l                    else\l                    if _x_0 then if _x_1 then … else …\l                    else if _x_10 then … else …)\l                then _x_28 else 1\l          in\l          let (_x_31 : int) = ( :var_2: ).time in\l          let (_x_32 : bool) = _x_31 \&lt;= _x_16 in\l          let (_x_33 : bool) = _x_25 = LIMIT_CI \|\| _x_25 = PEGGED_CI in\l          let (_x_34 : bool) = not _x_33 in\l          let (_x_35 : int) = ( :var_2: ).leaves_qty in\l          let (_x_36 : bool) = not (_x_22 \&lt;= _x_35) in\l          let (_x_37 : int)\l              = if (if _x_27 then _x_2 else if _x_26 then … else …) =\l                   (if _x_6 then _x_2 else if _x_5 then … else …)\l                then 0 else -1\l          in\l          let (_x_38 : int)\l              = if _x_1\l                then\l                  if (if _x_27 then _x_2\l                      else\l                      if _x_26 then if _x_1 then … else …\l                      else if _x_29 then … else …)\l                     \&lt;=.\l                     (if _x_6 then _x_2\l                      else\l                      if _x_5 then if _x_1 then … else …\l                      else if _x_8 then … else …)\l                  then _x_37 else 1\l                else\l                if (if _x_6 then _x_2\l                    else\l                    if _x_5 then if _x_1 then … else …\l                    else if _x_8 then … else …)\l                   \&lt;=.\l                   (if _x_27 then _x_2\l                    else\l                    if _x_26 then if _x_1 then … else …\l                    else if _x_29 then … else …)\l                then _x_37 else 1\l          in\l          let (_x_39 : bool) = _x_15 \&lt;= _x_31 in\l          let (_x_40 : bool) = not (_x_35 \&lt;= _x_23) in\l          ((if _x_1\l            then\l              if (if _x_13 then _x_9\l                  else\l                  if _x_12 then if _x_1 then … else …\l                  else\l                  if Is_a(PEGGED, _x_11) \|\| Is_a(PEGGED_CI, _x_11) then …\l                  else …)\l                 \&lt;=.\l                 (if _x_6 then _x_9\l                  else\l                  if _x_5 then if _x_1 then … else …\l                  else if _x_8 then … else …)\l              then\l                if (if _x_13 then _x_9 else if _x_12 then … else …) =\l                   (if _x_6 then _x_9 else if _x_5 then … else …)\l                then 0 else -1\l              else 1\l            else _x_14)\l           = 1\l           \|\| not\l              ((if _x_1\l                then\l                  if (if _x_3 then _x_2\l                      else\l                      if _x_0 then if _x_1 then … else …\l                      else if _x_10 then … else …)\l                     \&lt;=.\l                     (if _x_6 then _x_2\l                      else\l                      if _x_5 then if _x_1 then … else …\l                      else if _x_8 then … else …)\l                  then _x_7 else 1\l                else _x_14)\l               = -1)\l              &amp;&amp; (if _x_18 &amp;&amp; _x_20 then _x_24\l                  else\l                    (not _x_17\l                     \|\| not (_x_17 &amp;&amp; not (_x_16 = _x_15))\l                        &amp;&amp; (_x_19 \|\| not (_x_18 &amp;&amp; _x_21) &amp;&amp; _x_24))))\l          \|\| not\l             ((_x_30 = 1\l               \|\| not (_x_30 = -1)\l                  &amp;&amp; (if _x_18 &amp;&amp; _x_33 then _x_36\l                      else\l                        (not _x_32\l                         \|\| not (_x_32 &amp;&amp; not (_x_16 = _x_31))\l                            &amp;&amp; (_x_19 \|\| not (_x_18 &amp;&amp; _x_34) &amp;&amp; _x_36))))\l              &amp;&amp; (_x_38 = 1\l                  \|\| not (_x_38 = -1)\l                     &amp;&amp; (if _x_33 &amp;&amp; _x_20 then _x_40\l                         else\l                           (not _x_39\l                            \|\| not (_x_39 &amp;&amp; not (_x_31 = _x_15))\l                               &amp;&amp; (_x_34 \|\| not (_x_33 &amp;&amp; _x_21) &amp;&amp; _x_40)))))\l          :expansions [] :rw [] :fc [])&quot;,shape=box,style=filled,fontname=&quot;courier&quot;,fontsize=14];
p_1 -&gt; p_0 [label=&quot;&quot;];
p_0 [label=&quot;Sat (Some  let (side : order_side) = BUY\l let (o1 : order) =\l  \{id = 10; peg = NEAR; client_id = 11; order_type = PEGGED; qty = 12;\l   min_qty = 13; leaves_qty = 18214; price = (Real.mk_of_string \&quot;-56201/2\&quot;);\l   time = 0; src = 14; order_attr = RESIDENT; capacity = Principal;\l   category = C_ONE;\l   cross_restrict =\l    \{cr_self_cross = false; cr_ubs_principal = false;\l     cr_round_lot_only = false; cr_no_locked_nbbo = false;\l     cr_pegged_mid_point_mode = 9; cr_enable_conditionals = false;\l     cr_min_qty = false;\l     cr_cat_elig =\l      \{c_one_elig = false; c_two_elig = false; c_three_elig = false;\l       c_four_elig = false\}\};\l   locate_found = false; expiry_time = 15\}\l let (o2 : order) =\l  \{id = 18; peg = NEAR; client_id = 19; order_type = PEGGED_CI; qty = 20;\l   min_qty = 21; leaves_qty = 20652; price = 1008.0; time = 1; src = 22;\l   order_attr = RESIDENT; capacity = Principal; category = C_ONE;\l   cross_restrict =\l    \{cr_self_cross = false; cr_ubs_principal = false;\l     cr_round_lot_only = false; cr_no_locked_nbbo = false;\l     cr_pegged_mid_point_mode = 17; cr_enable_conditionals = false;\l     cr_min_qty = false;\l     cr_cat_elig =\l      \{c_one_elig = false; c_two_elig = false; c_three_elig = false;\l       c_four_elig = false\}\};\l   locate_found = false; expiry_time = 23\}\l let (o3 : order) =\l  \{id = 3; peg = NEAR; client_id = 4; order_type = PEGGED_CI; qty = 5;\l   min_qty = 6; leaves_qty = 20651; price = (Real.mk_of_string \&quot;-1/2\&quot;);\l   time = (-1); src = 7; order_attr = RESIDENT; capacity = Principal;\l   category = C_ONE;\l   cross_restrict =\l    \{cr_self_cross = false; cr_ubs_principal = false;\l     cr_round_lot_only = false; cr_no_locked_nbbo = false;\l     cr_pegged_mid_point_mode = 2; cr_enable_conditionals = false;\l     cr_min_qty = false;\l     cr_cat_elig =\l      \{c_one_elig = false; c_two_elig = false; c_three_elig = false;\l       c_four_elig = false\}\};\l   locate_found = false; expiry_time = 8\}\l let (mkt : mkt_data) =\l  \{nbb = (Real.mk_of_string \&quot;2015/2\&quot;); nbo = (Real.mk_of_string \&quot;59207/2\&quot;);\l   l_up = 2.0; l_down = 3.0\}\l)&quot;,shape=box,style=filled,fontname=&quot;courier&quot;,fontsize=14];
}
</textarea><button class="btn btn-primary">Load graph</button><div class="imandra-graphviz-loading display-none">Loading..</div><div class="imandra-graphviz-target"></div><script>
require(['nbextensions/nbimandra/graphviz'], function (graphviz) {
  var target = '#graphviz-6af77f3a-614b-402f-88b4-77ae3fd9e0ce';
  graphviz.hydrate(target);
});
</script></div></div></div><script>
require(['nbextensions/nbimandra/alternatives'], function (alternatives) {
  var target = '#alt-de0d1925-83b9-4a6c-a5bb-5c72b42dea57';
  alternatives.hydrate(target);
});
</script></div></div></div><script>
require(['nbextensions/nbimandra/fold'], function (fold) {
  var target = '#fold-17347c99-eaa7-4266-8d9e-f9b3c1875fb8';
  fold.hydrate(target);
});
</script></div></div></div></div><script>
require(['nbextensions/nbimandra/alternatives'], function (alternatives) {
  var target = '#alt-b905307f-3921-4389-8201-b2c117048b73';
  alternatives.hydrate(target);
});
</script></div></div></div>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>We just showed that the ranking function is <strong>not</strong> transitive! As always, the components of the counterexample are automatically reflected into a module called <code>CX</code> and can be computed with, just as any other value in our runtime:</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="try-this-container">
  <a href="https://try.imandra.ai/launch/?next=/h/user-redirect/notebooks/Analysing%20the%20UBS%20ATS%20Dark%20Pool.ipynb%23try-cell-39" target="_blank" rel="nofollow">
    <div class="try-this">Try this!</div>
  </a>
</div>
<div class="input">
<div class="prompt input_prompt">In&nbsp;[20]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ocaml"><pre><span></span><span class="nn">CX</span><span class="p">.</span><span class="n">o1</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[20]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>- : order =
{id = 10; peg = NEAR; client_id = 11; order_type = PEGGED; qty = 12;
 min_qty = 13; leaves_qty = 18214; price = -56201/2; time = 0; src = 14;
 order_attr = RESIDENT; capacity = Principal; category = C_ONE;
 cross_restrict =
  {cr_self_cross = false; cr_ubs_principal = false;
   cr_round_lot_only = false; cr_no_locked_nbbo = false;
   cr_pegged_mid_point_mode = 9; cr_enable_conditionals = false;
   cr_min_qty = false;
   cr_cat_elig =
    {c_one_elig = false; c_two_elig = false; c_three_elig = false;
     c_four_elig = false}};
 locate_found = false; expiry_time = 15}
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Let's verify this counterexample to transitivity by computation!</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="try-this-container">
  <a href="https://try.imandra.ai/launch/?next=/h/user-redirect/notebooks/Analysing%20the%20UBS%20ATS%20Dark%20Pool.ipynb%23try-cell-41" target="_blank" rel="nofollow">
    <div class="try-this">Try this!</div>
  </a>
</div>
<div class="input">
<div class="prompt input_prompt">In&nbsp;[21]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ocaml"><pre><span></span><span class="n">order_higher_ranked</span> <span class="nn">CX</span><span class="p">.</span><span class="o">(</span><span class="n">side</span><span class="o">,</span> <span class="n">o1</span><span class="o">,</span> <span class="n">o2</span><span class="o">,</span> <span class="n">mkt</span><span class="o">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[21]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>- : bool = true
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="try-this-container">
  <a href="https://try.imandra.ai/launch/?next=/h/user-redirect/notebooks/Analysing%20the%20UBS%20ATS%20Dark%20Pool.ipynb%23try-cell-42" target="_blank" rel="nofollow">
    <div class="try-this">Try this!</div>
  </a>
</div>
<div class="input">
<div class="prompt input_prompt">In&nbsp;[22]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ocaml"><pre><span></span><span class="n">order_higher_ranked</span> <span class="nn">CX</span><span class="p">.</span><span class="o">(</span><span class="n">side</span><span class="o">,</span> <span class="n">o2</span><span class="o">,</span> <span class="n">o3</span><span class="o">,</span> <span class="n">mkt</span><span class="o">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[22]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>- : bool = true
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="try-this-container">
  <a href="https://try.imandra.ai/launch/?next=/h/user-redirect/notebooks/Analysing%20the%20UBS%20ATS%20Dark%20Pool.ipynb%23try-cell-43" target="_blank" rel="nofollow">
    <div class="try-this">Try this!</div>
  </a>
</div>
<div class="input">
<div class="prompt input_prompt">In&nbsp;[23]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ocaml"><pre><span></span><span class="n">order_higher_ranked</span> <span class="nn">CX</span><span class="p">.</span><span class="o">(</span><span class="n">side</span><span class="o">,</span> <span class="n">o1</span><span class="o">,</span> <span class="n">o3</span><span class="o">,</span> <span class="n">mkt</span><span class="o">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[23]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>- : bool = false
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Let us add some additional constraints to help make our counterexample "pretty":</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="try-this-container">
  <a href="https://try.imandra.ai/launch/?next=/h/user-redirect/notebooks/Analysing%20the%20UBS%20ATS%20Dark%20Pool.ipynb%23try-cell-45" target="_blank" rel="nofollow">
    <div class="try-this">Try this!</div>
  </a>
</div>
<div class="input">
<div class="prompt input_prompt">In&nbsp;[24]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ocaml"><pre><span></span><span class="k">let</span> <span class="n">pretty</span> <span class="n">mkt</span> <span class="n">o1</span> <span class="n">o2</span> <span class="n">o3</span> <span class="o">=</span>
    <span class="n">o1</span><span class="o">.</span><span class="n">leaves_qty</span> <span class="o">&lt;=</span> <span class="n">o1</span><span class="o">.</span><span class="n">qty</span> <span class="o">&amp;&amp;</span>
    <span class="n">o2</span><span class="o">.</span><span class="n">leaves_qty</span> <span class="o">&lt;=</span> <span class="n">o2</span><span class="o">.</span><span class="n">qty</span> <span class="o">&amp;&amp;</span>
    <span class="n">o3</span><span class="o">.</span><span class="n">leaves_qty</span> <span class="o">&lt;=</span> <span class="n">o3</span><span class="o">.</span><span class="n">qty</span> <span class="o">&amp;&amp;</span>
    <span class="n">o1</span><span class="o">.</span><span class="n">time</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
    <span class="n">o2</span><span class="o">.</span><span class="n">time</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
    <span class="n">o3</span><span class="o">.</span><span class="n">time</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
    <span class="n">o1</span><span class="o">.</span><span class="n">price</span> <span class="o">&gt;.</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span> <span class="o">&amp;&amp;</span>
    <span class="n">o2</span><span class="o">.</span><span class="n">price</span> <span class="o">&gt;.</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span> <span class="o">&amp;&amp;</span>
    <span class="n">o3</span><span class="o">.</span><span class="n">price</span> <span class="o">&gt;.</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span> <span class="o">&amp;&amp;</span>
    <span class="n">o1</span><span class="o">.</span><span class="n">qty</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
    <span class="n">o2</span><span class="o">.</span><span class="n">qty</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
    <span class="n">o3</span><span class="o">.</span><span class="n">qty</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
    <span class="n">o1</span><span class="o">.</span><span class="n">leaves_qty</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
    <span class="n">o2</span><span class="o">.</span><span class="n">leaves_qty</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
    <span class="n">o3</span><span class="o">.</span><span class="n">leaves_qty</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
    <span class="n">mkt</span><span class="o">.</span><span class="n">l_down</span> <span class="o">&gt;.</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span> <span class="o">&amp;&amp;</span>
    <span class="n">mkt</span><span class="o">.</span><span class="n">nbb</span> <span class="o">&gt;.</span> <span class="n">mkt</span><span class="o">.</span><span class="n">l_down</span> <span class="o">&amp;&amp;</span>
    <span class="n">mkt</span><span class="o">.</span><span class="n">nbo</span> <span class="o">&gt;.</span> <span class="n">mkt</span><span class="o">.</span><span class="n">nbb</span> <span class="o">&amp;&amp;</span>
    <span class="n">mkt</span><span class="o">.</span><span class="n">l_up</span> <span class="o">&gt;.</span> <span class="n">mkt</span><span class="o">.</span><span class="n">nbo</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[24]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>val pretty : mkt_data -&gt; order -&gt; order -&gt; order -&gt; bool = &lt;fun&gt;
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="try-this-container">
  <a href="https://try.imandra.ai/launch/?next=/h/user-redirect/notebooks/Analysing%20the%20UBS%20ATS%20Dark%20Pool.ipynb%23try-cell-46" target="_blank" rel="nofollow">
    <div class="try-this">Try this!</div>
  </a>
</div>
<div class="input">
<div class="prompt input_prompt">In&nbsp;[25]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ocaml"><pre><span></span><span class="n">verify</span> <span class="o">(</span><span class="k">fun</span> <span class="n">side</span> <span class="n">o1</span> <span class="n">o2</span> <span class="n">o3</span> <span class="n">mkt</span> <span class="o">-&gt;</span> <span class="n">pretty</span> <span class="n">mkt</span> <span class="n">o1</span> <span class="n">o2</span> <span class="n">o3</span> <span class="o">==&gt;</span> <span class="n">rank_transitivity</span> <span class="n">side</span> <span class="n">o1</span> <span class="n">o2</span> <span class="n">o3</span> <span class="n">mkt</span><span class="o">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[25]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>- : order_side -&gt; order -&gt; order -&gt; order -&gt; mkt_data -&gt; bool = &lt;fun&gt;
module CX :
  sig
    val side : order_side
    val o1 : order
    val o2 : order
    val o3 : order
    val mkt : mkt_data
  end
</pre>
</div>

</div>

<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div><pre>Counterexample (after 0 steps, 0.074s):
 let (side : order_side) = BUY
 let (o1 : order) =
  {id = 9; peg = NEAR; client_id = 10; order_type = PEGGED; qty = 4033;
   min_qty = 11; leaves_qty = 1596; price = (Real.mk_of_string &quot;275005/4&quot;);
   time = 1; src = 12; order_attr = RESIDENT; capacity = Principal;
   category = C_ONE;
   cross_restrict =
    {cr_self_cross = false; cr_ubs_principal = false;
     cr_round_lot_only = false; cr_no_locked_nbbo = false;
     cr_pegged_mid_point_mode = 8; cr_enable_conditionals = false;
     cr_min_qty = false;
     cr_cat_elig =
      {c_one_elig = false; c_two_elig = false; c_three_elig = false;
       c_four_elig = false}};
   locate_found = false; expiry_time = 13}
 let (o2 : order) =
  {id = 16; peg = NEAR; client_id = 17; order_type = PEGGED_CI; qty = 8856;
   min_qty = 18; leaves_qty = 1595; price = (Real.mk_of_string &quot;275003/4&quot;);
   time = 21240; src = 19; order_attr = RESIDENT; capacity = Principal;
   category = C_ONE;
   cross_restrict =
    {cr_self_cross = false; cr_ubs_principal = false;
     cr_round_lot_only = false; cr_no_locked_nbbo = false;
     cr_pegged_mid_point_mode = 15; cr_enable_conditionals = false;
     cr_min_qty = false;
     cr_cat_elig =
      {c_one_elig = false; c_two_elig = false; c_three_elig = false;
       c_four_elig = false}};
   locate_found = false; expiry_time = 20}
 let (o3 : order) =
  {id = 3; peg = NO_PEG; client_id = 4; order_type = LIMIT_CI; qty = 11798;
   min_qty = 5; leaves_qty = 1594; price = (Real.mk_of_string &quot;275003/4&quot;);
   time = 0; src = 6; order_attr = RESIDENT; capacity = Principal;
   category = C_ONE;
   cross_restrict =
    {cr_self_cross = false; cr_ubs_principal = false;
     cr_round_lot_only = false; cr_no_locked_nbbo = false;
     cr_pegged_mid_point_mode = 2; cr_enable_conditionals = false;
     cr_min_qty = false;
     cr_cat_elig =
      {c_one_elig = false; c_two_elig = false; c_three_elig = false;
       c_four_elig = false}};
   locate_found = false; expiry_time = 7}
 let (mkt : mkt_data) =
  {nbb = (Real.mk_of_string &quot;275003/4&quot;); nbo = 68751.0;
   l_up = (Real.mk_of_string &quot;308465/4&quot;);
   l_down = (Real.mk_of_string &quot;137501/2&quot;)}
</pre></div>

</div>

</div>

<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div><div style="font-size: 1.2em; padding: 0.5em; border-top: 1px dashed #D84315; border-bottom: 1px dashed #D84315"><i class="fa fa-times-circle-o" style="margin-right: 0.5em; color: #D84315"></i><span>Refuted</span></div><div><div class="imandra-alternatives" id="alt-c75b4418-0a69-4a99-bdf1-5bb85c82b4cf"><ul class="nav nav-tabs"><li class="active" data-toggle="tab"><a>call graph</a></li><li class="" data-toggle="tab"><a>proof</a></li></ul><div class="tab-content"><div class="tab-pane active"><div class="imandra-graphviz" id="graphviz-df75b589-4e16-4190-8f8f-4bf2b8009f93"><textarea style="display: none">digraph &quot;call graph&quot; {
goal [label=&quot;let (_x_0 : order_type) = o1.order_type in\llet (_x_1 : bool) = Is_a(LIMIT, _x_0) in\llet (_x_2 : real) = ….nbb in\llet (_x_3 : real) = ….nbo in\llet (_x_4 : bool) = side = BUY in\llet (_x_5 : real) = if _x_4 then _x_3 else _x_2 in\llet (_x_6 : bool) = Is_a(MARKET, _x_0) in\llet (_x_7 : order_type) = o3.order_type in\llet (_x_8 : bool) = Is_a(LIMIT, _x_7) in\llet (_x_9 : bool) = Is_a(MARKET, _x_7) in\llet (_x_10 : int)\l    = if (if _x_6 then _x_5 else if _x_1 then … else …) =\l         (if _x_9 then _x_5 else if _x_8 then … else …)\l      then 0 else -1\lin\llet (_x_11 : bool) = Is_a(PEGGED, _x_7) \|\| Is_a(PEGGED_CI, _x_7) in\llet (_x_12 : bool) = Is_a(PEGGED, _x_0) \|\| Is_a(PEGGED_CI, _x_0) in\llet (_x_13 : int)\l    = if _x_4\l      then\l        if (if _x_6 then _x_5\l            else\l            if _x_1 then if _x_4 then … else …\l            else if _x_12 then … else …)\l           \&lt;=.\l           (if _x_9 then _x_5\l            else\l            if _x_8 then if _x_4 then … else …\l            else if _x_11 then … else …)\l        then _x_10 else 1\l      else\l      if (if _x_9 then _x_5\l          else\l          if _x_8 then if _x_4 then … else …\l          else if _x_11 then … else …)\l         \&lt;=.\l         (if _x_6 then _x_5\l          else\l          if _x_1 then if _x_4 then … else …\l          else if _x_12 then … else …)\l      then _x_10 else 1\lin\llet (_x_14 : int) = o3.time in\llet (_x_15 : int) = o1.time in\llet (_x_16 : bool) = _x_14 \&lt;= _x_15 in\llet (_x_17 : bool) = _x_0 = LIMIT_CI \|\| _x_0 = PEGGED_CI in\llet (_x_18 : bool) = not _x_17 in\llet (_x_19 : bool) = _x_7 = PEGGED_CI \|\| _x_7 = LIMIT_CI in\llet (_x_20 : bool) = not _x_19 in\llet (_x_21 : int) = o1.leaves_qty in\llet (_x_22 : int) = o3.leaves_qty in\llet (_x_23 : bool) = not (_x_21 \&lt;= _x_22) in\llet (_x_24 : order_type) = o2.order_type in\llet (_x_25 : bool) = Is_a(LIMIT, _x_24) in\llet (_x_26 : bool) = Is_a(MARKET, _x_24) in\llet (_x_27 : int)\l    = if (if _x_6 then _x_5 else if _x_1 then … else …) =\l         (if _x_26 then _x_5 else if _x_25 then … else …)\l      then 0 else -1\lin\llet (_x_28 : bool) = Is_a(PEGGED, _x_24) \|\| Is_a(PEGGED_CI, _x_24) in\llet (_x_29 : int)\l    = if _x_4\l      then\l        if (if _x_6 then _x_5\l            else\l            if _x_1 then if _x_4 then … else …\l            else if _x_12 then … else …)\l           \&lt;=.\l           (if _x_26 then _x_5\l            else\l            if _x_25 then if _x_4 then … else …\l            else if _x_28 then … else …)\l        then _x_27 else 1\l      else\l      if (if _x_26 then _x_5\l          else\l          if _x_25 then if _x_4 then … else …\l          else if _x_28 then … else …)\l         \&lt;=.\l         (if _x_6 then _x_5\l          else\l          if _x_1 then if _x_4 then … else …\l          else if _x_12 then … else …)\l      then _x_27 else 1\lin\llet (_x_30 : int) = o2.time in\llet (_x_31 : bool) = _x_30 \&lt;= _x_15 in\llet (_x_32 : bool) = _x_24 = LIMIT_CI \|\| _x_24 = PEGGED_CI in\llet (_x_33 : bool) = not _x_32 in\llet (_x_34 : int) = o2.leaves_qty in\llet (_x_35 : bool) = not (_x_21 \&lt;= _x_34) in\llet (_x_36 : int)\l    = if (if _x_26 then _x_5 else if _x_25 then … else …) =\l         (if _x_9 then _x_5 else if _x_8 then … else …)\l      then 0 else -1\lin\llet (_x_37 : int)\l    = if _x_4\l      then\l        if (if _x_26 then _x_5\l            else\l            if _x_25 then if _x_4 then … else …\l            else if _x_28 then … else …)\l           \&lt;=.\l           (if _x_9 then _x_5\l            else\l            if _x_8 then if _x_4 then … else …\l            else if _x_11 then … else …)\l        then _x_36 else 1\l      else\l      if (if _x_9 then _x_5\l          else\l          if _x_8 then if _x_4 then … else …\l          else if _x_11 then … else …)\l         \&lt;=.\l         (if _x_26 then _x_5\l          else\l          if _x_25 then if _x_4 then … else …\l          else if _x_28 then … else …)\l      then _x_36 else 1\lin\llet (_x_38 : bool) = _x_14 \&lt;= _x_30 in\llet (_x_39 : bool) = not (_x_34 \&lt;= _x_22) in\llet (_x_40 : int) = o1.qty in\llet (_x_41 : int) = o2.qty in\llet (_x_42 : int) = o3.qty in\llet (_x_43 : real) = ….l_down in\lnot\l(((_x_13 = 1\l   \|\| not (_x_13 = -1)\l      &amp;&amp; (if _x_17 &amp;&amp; _x_19 then _x_23\l          else\l            (not _x_16\l             \|\| not (_x_16 &amp;&amp; not (_x_15 = _x_14))\l                &amp;&amp; (_x_18 \|\| not (_x_17 &amp;&amp; _x_20) &amp;&amp; _x_23))))\l  \|\| not\l     ((_x_29 = 1\l       \|\| not (_x_29 = -1)\l          &amp;&amp; (if _x_17 &amp;&amp; _x_32 then _x_35\l              else\l                (not _x_31\l                 \|\| not (_x_31 &amp;&amp; not (_x_15 = _x_30))\l                    &amp;&amp; (_x_18 \|\| not (_x_17 &amp;&amp; _x_33) &amp;&amp; _x_35))))\l      &amp;&amp; (_x_37 = 1\l          \|\| not (_x_37 = -1)\l             &amp;&amp; (if _x_32 &amp;&amp; _x_19 then _x_39\l                 else\l                   (not _x_38\l                    \|\| not (_x_38 &amp;&amp; not (_x_30 = _x_14))\l                       &amp;&amp; (_x_33 \|\| not (_x_32 &amp;&amp; _x_20) &amp;&amp; _x_39))))))\l \|\| not\l    ((((((((((((((((((_x_21 \&lt;= _x_40 &amp;&amp; _x_34 \&lt;= _x_41) &amp;&amp; _x_22 \&lt;= _x_42)\l                    &amp;&amp; _x_15 \&gt;= 0)\l                   &amp;&amp; _x_30 \&gt;= 0)\l                  &amp;&amp; _x_14 \&gt;= 0)\l                 &amp;&amp; not (o1.price \&lt;=. 0))\l                &amp;&amp; not (o2.price \&lt;=. 0))\l               &amp;&amp; not (o3.price \&lt;=. 0))\l              &amp;&amp; not (_x_40 \&lt;= 0))\l             &amp;&amp; not (_x_41 \&lt;= 0))\l            &amp;&amp; not (_x_42 \&lt;= 0))\l           &amp;&amp; _x_21 \&gt;= 0)\l          &amp;&amp; _x_34 \&gt;= 0)\l         &amp;&amp; _x_22 \&gt;= 0)\l        &amp;&amp; not (_x_43 \&lt;=. 0))\l       &amp;&amp; not (_x_2 \&lt;=. _x_43))\l      &amp;&amp; not (_x_3 \&lt;=. _x_2))\l     &amp;&amp; not (….l_up \&lt;=. _x_3)))&quot;,shape=box,style=filled,color=&quot;cyan&quot;,fontname=&quot;courier&quot;,fontsize=14];
}
</textarea><button class="btn btn-primary">Load graph</button><div class="imandra-graphviz-loading display-none">Loading..</div><div class="imandra-graphviz-target"></div><script>
require(['nbextensions/nbimandra/graphviz'], function (graphviz) {
  var target = '#graphviz-df75b589-4e16-4190-8f8f-4bf2b8009f93';
  graphviz.hydrate(target);
});
</script></div></div><div class="tab-pane"><div class="imandra-proof-top"><div class="imandra-fold panel panel-default" id="fold-a69cad80-c6d8-4e2b-917f-ec6175928496"><div class="panel-heading"><div><i class="fa fa-chevron-down hidden"></i><i class="fa fa-chevron-right"></i><span>proof attempt</span></div></div><div class="panel-body collapse"><div class="imandra-proof"><div class="imandra-alternatives" id="alt-88acf5f6-974b-4cc8-8ab8-f5057134ba30"><ul class="nav nav-tabs"><li class="active" data-toggle="tab"><a>summary</a></li><li class="" data-toggle="tab"><a>full</a></li><li class="" data-toggle="tab"><a>graph</a></li></ul><div class="tab-content"><div class="tab-pane active"><div class="imandra-table" id="table-c92f911b-89aa-4a5a-9930-1feee442d100"><table><tr><td><b>ground_instances</b></td><td>0</td></tr><tr><td><b>definitions</b></td><td>0</td></tr><tr><td><b>inductions</b></td><td>0</td></tr><tr><td><b>search_time</b></td><td><pre>0.075s</pre></td></tr><tr><td><b>details</b></td><td><div class="imandra-fold panel panel-default" id="fold-6291d377-238f-42ec-b774-5b2fa97fb1b1"><div class="panel-heading"><div><i class="fa fa-chevron-down hidden"></i><i class="fa fa-chevron-right"></i><span>Expand</span></div></div><div class="panel-body collapse"><div class="imandra-table" id="table-e152dfe5-b699-4775-befc-3f3fee3d437b"><table><tr><td><b>smt_stats</b></td><td><div class="imandra-table" id="table-5874f6b6-d131-4b28-a832-7dab50ddbb92"><table><tr><td><b>num checks</b></td><td>1</td></tr><tr><td><b>arith-assume-eqs</b></td><td>3</td></tr><tr><td><b>arith-make-feasible</b></td><td>95</td></tr><tr><td><b>arith-max-columns</b></td><td>60</td></tr><tr><td><b>arith-conflicts</b></td><td>4</td></tr><tr><td><b>rlimit count</b></td><td>59624</td></tr><tr><td><b>arith-cheap-eqs</b></td><td>75</td></tr><tr><td><b>mk clause</b></td><td>621</td></tr><tr><td><b>datatype occurs check</b></td><td>22</td></tr><tr><td><b>mk bool var</b></td><td>879</td></tr><tr><td><b>arith-lower</b></td><td>70</td></tr><tr><td><b>arith-diseq</b></td><td>50</td></tr><tr><td><b>datatype splits</b></td><td>99</td></tr><tr><td><b>decisions</b></td><td>1276</td></tr><tr><td><b>arith-propagations</b></td><td>26</td></tr><tr><td><b>propagations</b></td><td>1417</td></tr><tr><td><b>interface eqs</b></td><td>3</td></tr><tr><td><b>arith-bound-propagations-cheap</b></td><td>26</td></tr><tr><td><b>arith-max-rows</b></td><td>34</td></tr><tr><td><b>conflicts</b></td><td>33</td></tr><tr><td><b>datatype accessor ax</b></td><td>87</td></tr><tr><td><b>minimized lits</b></td><td>6</td></tr><tr><td><b>arith-bound-propagations-lp</b></td><td>13</td></tr><tr><td><b>datatype constructor ax</b></td><td>255</td></tr><tr><td><b>num allocs</b></td><td>10654701</td></tr><tr><td><b>final checks</b></td><td>4</td></tr><tr><td><b>added eqs</b></td><td>1884</td></tr><tr><td><b>del clause</b></td><td>157</td></tr><tr><td><b>arith eq adapter</b></td><td>42</td></tr><tr><td><b>arith-upper</b></td><td>83</td></tr><tr><td><b>time</b></td><td>0.047000</td></tr><tr><td><b>memory</b></td><td>14.990000</td></tr><tr><td><b>max memory</b></td><td>16.070000</td></tr></table></div></td></tr></table></div></div><script>
require(['nbextensions/nbimandra/fold'], function (fold) {
  var target = '#fold-6291d377-238f-42ec-b774-5b2fa97fb1b1';
  fold.hydrate(target);
});
</script></div></td></tr></table></div></div><div class="tab-pane"><div class="imandra-fold panel panel-default" id="fold-8befc76d-4fca-40a4-b266-ff46078dd1c9"><div class="panel-heading"><div><i class="fa fa-chevron-down hidden"></i><i class="fa fa-chevron-right"></i><span>Expand</span></div></div><div class="panel-body collapse"><ul><li><pre>start[0.075s]
  let (_x_0 : int) = ( :var_0: ).leaves_qty in
  let (_x_1 : int) = ( :var_0: ).qty in
  let (_x_2 : int) = ( :var_1: ).leaves_qty in
  let (_x_3 : int) = ( :var_1: ).qty in
  let (_x_4 : int) = ( :var_2: ).leaves_qty in
  let (_x_5 : int) = ( :var_2: ).qty in
  let (_x_6 : int) = ( :var_0: ).time in
  let (_x_7 : int) = ( :var_1: ).time in
  let (_x_8 : int) = ( :var_2: ).time in
  let (_x_9 : real) = ( :var_3: ).l_down in
  let (_x_10 : real) = ( :var_3: ).nbb in
  let (_x_11 : real) = ( :var_3: ).nbo in
  let (_x_12 : order_type) = ( :var_0: ).order_type in
  let (_x_13 : bool) = _x_12 = PEGGED_CI || _x_12 = LIMIT_CI in
  let (_x_14 : order_type) = ( :var_1: ).order_type in
  let (_x_15 : bool) = _x_14 = PEGGED_CI || _x_14 = LIMIT_CI in
  let (_x_16 : order_type) = ….1.order_type in
  let (_x_17 : bool) = Is_a(LIMIT, _x_16) in
  let (_x_18 : bool) = ….0 = BUY in
  let (_x_19 : real) = if _x_18 then ….nbo else ….nbb in
  let (_x_20 : bool) = Is_a(MARKET, _x_16) in
  let (_x_21 : order_type) = ….1.order_type in
  let (_x_22 : bool) = Is_a(LIMIT, _x_21) in
  let (_x_23 : bool) = ….0 = BUY in
  let (_x_24 : real) = if _x_23 then ….nbo else ….nbb in
  let (_x_25 : bool) = Is_a(MARKET, _x_21) in
  let (_x_26 : int)
      = if (if _x_20 then _x_19 else if _x_17 then … else …) =
           (if _x_25 then _x_24 else if _x_22 then … else …)
        then 0 else -1
  in
  let (_x_27 : bool) = Is_a(PEGGED, _x_16) in
  let (_x_28 : bool) = Is_a(PEGGED, _x_21) in
  let (_x_29 : bool) = ( :var_4: ) = BUY in
  let (_x_30 : int)
      = if _x_29
        then
          if (if _x_20 then _x_19
              else
              if _x_17 then if _x_18 then … else …
              else if _x_27 then … else …)
             &gt;.
             (if _x_25 then _x_24
              else
              if _x_22 then if _x_23 then … else …
              else if _x_28 then … else …)
          then 1 else _x_26
        else
        if (if _x_20 then _x_19
            else
            if _x_17 then if _x_18 then … else …
            else if _x_27 then … else …)
           &lt;.
           (if _x_25 then _x_24
            else
            if _x_22 then if _x_23 then … else …
            else if _x_28 then … else …)
        then 1 else _x_26
  in
  let (_x_31 : order_type) = ( :var_2: ).order_type in
  let (_x_32 : bool) = _x_31 = PEGGED_CI || _x_31 = LIMIT_CI in
  let (_x_33 : order_type) = ….1.order_type in
  let (_x_34 : bool) = Is_a(LIMIT, _x_33) in
  let (_x_35 : bool) = ….0 = BUY in
  let (_x_36 : real) = if _x_35 then ….nbo else ….nbb in
  let (_x_37 : bool) = Is_a(MARKET, _x_33) in
  let (_x_38 : order_type) = ….1.order_type in
  let (_x_39 : bool) = Is_a(LIMIT, _x_38) in
  let (_x_40 : bool) = ….0 = BUY in
  let (_x_41 : real) = if _x_40 then ….nbo else ….nbb in
  let (_x_42 : bool) = Is_a(MARKET, _x_38) in
  let (_x_43 : int)
      = if (if _x_37 then _x_36 else if _x_34 then … else …) =
           (if _x_42 then _x_41 else if _x_39 then … else …)
        then 0 else -1
  in
  let (_x_44 : bool) = Is_a(PEGGED, _x_33) in
  let (_x_45 : bool) = Is_a(PEGGED, _x_38) in
  let (_x_46 : int)
      = if _x_29
        then
          if (if _x_37 then _x_36
              else
              if _x_34 then if _x_35 then … else …
              else if _x_44 then … else …)
             &gt;.
             (if _x_42 then _x_41
              else
              if _x_39 then if _x_40 then … else …
              else if _x_45 then … else …)
          then 1 else _x_43
        else
        if (if _x_37 then _x_36
            else
            if _x_34 then if _x_35 then … else …
            else if _x_44 then … else …)
           &lt;.
           (if _x_42 then _x_41
            else
            if _x_39 then if _x_40 then … else …
            else if _x_45 then … else …)
        then 1 else _x_43
  in
  let (_x_47 : order_type) = ….order_type in
  let (_x_48 : bool) = Is_a(LIMIT, _x_47) in
  let (_x_49 : bool) = ….0 = BUY in
  let (_x_50 : real) = if _x_49 then … else … in
  let (_x_51 : bool) = Is_a(MARKET, _x_47) in
  let (_x_52 : order_type) = ….1.order_type in
  let (_x_53 : bool) = Is_a(LIMIT, _x_52) in
  let (_x_54 : bool) = ….0 = BUY in
  let (_x_55 : real) = if _x_54 then ….nbo else ….nbb in
  let (_x_56 : bool) = Is_a(MARKET, _x_52) in
  let (_x_57 : int)
      = if (if _x_51 then _x_50 else if _x_48 then … else …) =
           (if _x_56 then _x_55 else if _x_53 then … else …)
        then 0 else -1
  in
  let (_x_58 : bool) = Is_a(PEGGED, _x_52) in
  let (_x_59 : order_type) = ….1.order_type in
  let (_x_60 : bool) = ….0 = BUY in
  let (_x_61 : int)
      = if _x_29
        then
          if (if Is_a(MARKET, _x_59) then if _x_60 then ….nbo else ….nbb
              else
              if Is_a(LIMIT, _x_59) then if _x_60 then … else …
              else if Is_a(PEGGED, _x_59) then … else …)
             &gt;.
             (if _x_56 then _x_55
              else
              if _x_53 then if _x_54 then … else …
              else if _x_58 then … else …)
          then 1 else _x_57
        else
        if (if _x_51 then _x_50
            else
            if _x_48 then if _x_49 then … else …
            else if Is_a(PEGGED, _x_47) then … else …)
           &lt;.
           (if _x_56 then _x_55
            else
            if _x_53 then if _x_54 then … else …
            else if _x_58 then … else …)
        then 1 else _x_57
  in
  _x_0 &lt;= _x_1
  &amp;&amp; _x_2 &lt;= _x_3
     &amp;&amp; _x_4 &lt;= _x_5
        &amp;&amp; _x_6 &gt;= 0
           &amp;&amp; _x_7 &gt;= 0
              &amp;&amp; _x_8 &gt;= 0
                 &amp;&amp; ( :var_0: ).price &gt;. 0
                    &amp;&amp; ( :var_1: ).price &gt;. 0
                       &amp;&amp; ( :var_2: ).price &gt;. 0
                          &amp;&amp; _x_1 &gt; 0
                             &amp;&amp; _x_3 &gt; 0
                                &amp;&amp; _x_5 &gt; 0
                                   &amp;&amp; _x_0 &gt;= 0
                                      &amp;&amp; _x_2 &gt;= 0
                                         &amp;&amp; _x_4 &gt;= 0
                                            &amp;&amp; _x_9 &gt;. 0
                                               &amp;&amp; _x_10 &gt;. _x_9
                                                  &amp;&amp; _x_11 &gt;. _x_10
                                                     &amp;&amp; ( :var_3: ).l_up &gt;.
                                                        _x_11
  ==&gt; (if _x_30 = 1 then true
       else
       if _x_30 = -1 then false
       else
       if _x_13 &amp;&amp; _x_15 then _x_0 &gt; _x_2
       else if (if _x_6 &lt; _x_7 then 1 else …) = 1 then true else …)
      &amp;&amp; (if _x_46 = 1 then true
          else
          if _x_46 = -1 then false
          else
          if _x_15 &amp;&amp; _x_32 then _x_2 &gt; _x_4
          else if (if _x_7 &lt; _x_8 then 1 else …) = 1 then true else …)
      ==&gt; (if _x_61 = 1 then true
           else
           if _x_61 = -1 then false
           else
           if _x_13 &amp;&amp; _x_32 then _x_0 &gt; _x_4
           else if (if _x_6 &lt; _x_8 then 1 else …) = 1 then true else …)</pre></li><li><div><h4>simplify</h4><div class="imandra-table" id="table-4b0cd86f-5f45-4a6e-b291-2fd5559716c9"><table><tr><td><b>into</b></td><td><pre>let (_x_0 : order_type) = ( :var_0: ).order_type in
let (_x_1 : bool) = Is_a(LIMIT, _x_0) in
let (_x_2 : bool) = ( :var_4: ) = BUY in
let (_x_3 : real) = if _x_2 then ( :var_3: ).nbo else ( :var_3: ).nbb in
let (_x_4 : bool) = Is_a(MARKET, _x_0) in
let (_x_5 : order_type) = ( :var_2: ).order_type in
let (_x_6 : bool) = Is_a(LIMIT, _x_5) in
let (_x_7 : bool) = Is_a(MARKET, _x_5) in
let (_x_8 : int)
    = if (if _x_4 then _x_3 else if _x_1 then … else …) =
         (if _x_7 then _x_3 else if _x_6 then … else …)
      then 0 else -1
in
let (_x_9 : bool) = Is_a(PEGGED, _x_5) || Is_a(PEGGED_CI, _x_5) in
let (_x_10 : bool) = Is_a(PEGGED, _x_0) || Is_a(PEGGED_CI, _x_0) in
let (_x_11 : int)
    = if _x_2
      then
        if (if _x_4 then _x_3
            else
            if _x_1 then if _x_2 then … else …
            else if _x_10 then … else …)
           &lt;=.
           (if _x_7 then _x_3
            else
            if _x_6 then if _x_2 then … else …
            else if _x_9 then … else …)
        then _x_8 else 1
      else
      if (if _x_7 then _x_3
          else
          if _x_6 then if _x_2 then … else …
          else if _x_9 then … else …)
         &lt;=.
         (if _x_4 then _x_3
          else
          if _x_1 then if _x_2 then … else …
          else if _x_10 then … else …)
      then _x_8 else 1
in
let (_x_12 : int) = ( :var_2: ).time in
let (_x_13 : int) = ( :var_0: ).time in
let (_x_14 : bool) = _x_12 &lt;= _x_13 in
let (_x_15 : bool) = _x_0 = LIMIT_CI || _x_0 = PEGGED_CI in
let (_x_16 : bool) = not _x_15 in
let (_x_17 : bool) = _x_5 = PEGGED_CI || _x_5 = LIMIT_CI in
let (_x_18 : bool) = not _x_17 in
let (_x_19 : int) = ( :var_0: ).leaves_qty in
let (_x_20 : int) = ( :var_2: ).leaves_qty in
let (_x_21 : bool) = not (_x_19 &lt;= _x_20) in
let (_x_22 : order_type) = ( :var_1: ).order_type in
let (_x_23 : bool) = Is_a(LIMIT, _x_22) in
let (_x_24 : bool) = Is_a(MARKET, _x_22) in
let (_x_25 : int)
    = if (if _x_4 then _x_3 else if _x_1 then … else …) =
         (if _x_24 then _x_3 else if _x_23 then … else …)
      then 0 else -1
in
let (_x_26 : bool) = Is_a(PEGGED, _x_22) || Is_a(PEGGED_CI, _x_22) in
let (_x_27 : int)
    = if _x_2
      then
        if (if _x_4 then _x_3
            else
            if _x_1 then if _x_2 then … else …
            else if _x_10 then … else …)
           &lt;=.
           (if _x_24 then _x_3
            else
            if _x_23 then if _x_2 then … else …
            else if _x_26 then … else …)
        then _x_25 else 1
      else
      if (if _x_24 then _x_3
          else
          if _x_23 then if _x_2 then … else …
          else if _x_26 then … else …)
         &lt;=.
         (if _x_4 then _x_3
          else
          if _x_1 then if _x_2 then … else …
          else if _x_10 then … else …)
      then _x_25 else 1
in
let (_x_28 : int) = ( :var_1: ).time in
let (_x_29 : bool) = _x_28 &lt;= _x_13 in
let (_x_30 : bool) = _x_22 = LIMIT_CI || _x_22 = PEGGED_CI in
let (_x_31 : bool) = not _x_30 in
let (_x_32 : int) = ( :var_1: ).leaves_qty in
let (_x_33 : bool) = not (_x_19 &lt;= _x_32) in
let (_x_34 : real) = if _x_2 then … else … in
let (_x_35 : int)
    = if (if _x_24 then _x_34 else if _x_23 then … else …) =
         (if _x_7 then _x_34 else if _x_6 then … else …)
      then 0 else -1
in
let (_x_36 : int)
    = if (if _x_7 then _x_34
          else
          if _x_6 then if _x_2 then … else …
          else if _x_9 then … else …)
         &lt;=.
         (if _x_24 then _x_34
          else
          if _x_23 then if _x_2 then … else …
          else if _x_26 then … else …)
      then _x_35 else 1
in
let (_x_37 : bool) = _x_12 &lt;= _x_28 in
let (_x_38 : bool) = not (_x_32 &lt;= _x_20) in
let (_x_39 : int) = ( :var_0: ).qty in
let (_x_40 : int) = ( :var_1: ).qty in
let (_x_41 : int) = ( :var_2: ).qty in
let (_x_42 : real) = ( :var_3: ).l_down in
((_x_11 = 1
  || not (_x_11 = -1)
     &amp;&amp; (if _x_15 &amp;&amp; _x_17 then _x_21
         else
           (not _x_14
            || not (_x_14 &amp;&amp; not (_x_13 = _x_12))
               &amp;&amp; (_x_16 || not (_x_15 &amp;&amp; _x_18) &amp;&amp; _x_21))))
 || not
    ((_x_27 = 1
      || not (_x_27 = -1)
         &amp;&amp; (if _x_15 &amp;&amp; _x_30 then _x_33
             else
               (not _x_29
                || not (_x_29 &amp;&amp; not (_x_13 = _x_28))
                   &amp;&amp; (_x_16 || not (_x_15 &amp;&amp; _x_31) &amp;&amp; _x_33))))
     &amp;&amp; ((if _x_2
          then
            if (if _x_24 then _x_3
                else
                if _x_23 then if _x_2 then … else …
                else if _x_26 then … else …)
               &lt;=.
               (if _x_7 then _x_3
                else
                if _x_6 then if _x_2 then … else …
                else if _x_9 then … else …)
            then _x_35 else 1
          else _x_36)
         = 1
         || not
            ((if _x_2
              then
                if (if _x_24 then _x_34
                    else
                    if _x_23 then if _x_2 then … else …
                    else if _x_26 then … else …)
                   &lt;=.
                   (if _x_7 then _x_34
                    else
                    if _x_6 then if _x_2 then … else …
                    else if _x_9 then … else …)
                then _x_35 else 1
              else _x_36)
             = -1)
            &amp;&amp; (if _x_30 &amp;&amp; _x_17 then _x_38
                else
                  (not _x_37
                   || not (_x_37 &amp;&amp; not (_x_28 = _x_12))
                      &amp;&amp; (_x_31 || not (_x_30 &amp;&amp; _x_18) &amp;&amp; _x_38))))))
|| not
   ((((((((((((((((((_x_19 &lt;= _x_39 &amp;&amp; _x_32 &lt;= _x_40) &amp;&amp; _x_20 &lt;= _x_41)
                   &amp;&amp; _x_13 &gt;= 0)
                  &amp;&amp; _x_28 &gt;= 0)
                 &amp;&amp; _x_12 &gt;= 0)
                &amp;&amp; not (( :var_0: ).price &lt;=. 0))
               &amp;&amp; not (( :var_1: ).price &lt;=. 0))
              &amp;&amp; not (( :var_2: ).price &lt;=. 0))
             &amp;&amp; not (_x_39 &lt;= 0))
            &amp;&amp; not (_x_40 &lt;= 0))
           &amp;&amp; not (_x_41 &lt;= 0))
          &amp;&amp; _x_19 &gt;= 0)
         &amp;&amp; _x_32 &gt;= 0)
        &amp;&amp; _x_20 &gt;= 0)
       &amp;&amp; not (_x_42 &lt;=. 0))
      &amp;&amp; not (… &lt;=. _x_42))
     &amp;&amp; not (… &lt;=. …))
    &amp;&amp; not (( :var_3: ).l_up &lt;=. …))</pre></td></tr><tr><td><b>expansions</b></td><td><pre>[]</pre></td></tr><tr><td><b>rewrite_steps</b></td><td><ul></ul></td></tr><tr><td><b>forward_chaining</b></td><td><ul></ul></td></tr></table></div></div></li><li>Sat (Some  let (side : order_side) = BUY
 let (o1 : order) =
  {id = 9; peg = NEAR; client_id = 10; order_type = PEGGED; qty = 4033;
   min_qty = 11; leaves_qty = 1596; price = (Real.mk_of_string &quot;275005/4&quot;);
   time = 1; src = 12; order_attr = RESIDENT; capacity = Principal;
   category = C_ONE;
   cross_restrict =
    {cr_self_cross = false; cr_ubs_principal = false;
     cr_round_lot_only = false; cr_no_locked_nbbo = false;
     cr_pegged_mid_point_mode = 8; cr_enable_conditionals = false;
     cr_min_qty = false;
     cr_cat_elig =
      {c_one_elig = false; c_two_elig = false; c_three_elig = false;
       c_four_elig = false}};
   locate_found = false; expiry_time = 13}
 let (o2 : order) =
  {id = 16; peg = NEAR; client_id = 17; order_type = PEGGED_CI; qty = 8856;
   min_qty = 18; leaves_qty = 1595; price = (Real.mk_of_string &quot;275003/4&quot;);
   time = 21240; src = 19; order_attr = RESIDENT; capacity = Principal;
   category = C_ONE;
   cross_restrict =
    {cr_self_cross = false; cr_ubs_principal = false;
     cr_round_lot_only = false; cr_no_locked_nbbo = false;
     cr_pegged_mid_point_mode = 15; cr_enable_conditionals = false;
     cr_min_qty = false;
     cr_cat_elig =
      {c_one_elig = false; c_two_elig = false; c_three_elig = false;
       c_four_elig = false}};
   locate_found = false; expiry_time = 20}
 let (o3 : order) =
  {id = 3; peg = NO_PEG; client_id = 4; order_type = LIMIT_CI; qty = 11798;
   min_qty = 5; leaves_qty = 1594; price = (Real.mk_of_string &quot;275003/4&quot;);
   time = 0; src = 6; order_attr = RESIDENT; capacity = Principal;
   category = C_ONE;
   cross_restrict =
    {cr_self_cross = false; cr_ubs_principal = false;
     cr_round_lot_only = false; cr_no_locked_nbbo = false;
     cr_pegged_mid_point_mode = 2; cr_enable_conditionals = false;
     cr_min_qty = false;
     cr_cat_elig =
      {c_one_elig = false; c_two_elig = false; c_three_elig = false;
       c_four_elig = false}};
   locate_found = false; expiry_time = 7}
 let (mkt : mkt_data) =
  {nbb = (Real.mk_of_string &quot;275003/4&quot;); nbo = 68751.0;
   l_up = (Real.mk_of_string &quot;308465/4&quot;);
   l_down = (Real.mk_of_string &quot;137501/2&quot;)}
)</li></ul></div><script>
require(['nbextensions/nbimandra/fold'], function (fold) {
  var target = '#fold-8befc76d-4fca-40a4-b266-ff46078dd1c9';
  fold.hydrate(target);
});
</script></div></div><div class="tab-pane"><div class="imandra-graphviz" id="graphviz-486f3022-88af-4b4d-a8f8-176a1fbecc05"><textarea style="display: none">digraph &quot;proof&quot; {
p_5 [label=&quot;Start (let (_x_0 : int) = ( :var_0: ).leaves_qty in\l       let (_x_1 : int) = ( :var_0: ).qty in\l       let (_x_2 : int) = ( :var_1: ).leaves_qty in\l       let (_x_3 : int) = ( :var_1: ).qty in\l       let (_x_4 : int) = ( :var_2: ).leaves_qty in\l       let (_x_5 : int) = ( :var_2: ).qty in\l       let (_x_6 : int) = ( :var_0: ).time in\l       let (_x_7 : int) = ( :var_1: ).time in\l       let (_x_8 : int) = ( :var_2: ).time in\l       let (_x_9 : real) = ( :var_3: ).l_down in\l       let (_x_10 : real) = ( :var_3: ).nbb in\l       let (_x_11 : real) = ( :var_3: ).nbo in\l       let (_x_12 : order_type) = ( :var_0: ).order_type in\l       let (_x_13 : bool) = _x_12 = PEGGED_CI \|\| _x_12 = LIMIT_CI in\l       let (_x_14 : order_type) = ( :var_1: ).order_type in\l       let (_x_15 : bool) = _x_14 = PEGGED_CI \|\| _x_14 = LIMIT_CI in\l       let (_x_16 : order_type) = ….1.order_type in\l       let (_x_17 : bool) = Is_a(LIMIT, _x_16) in\l       let (_x_18 : bool) = ….0 = BUY in\l       let (_x_19 : real) = if _x_18 then ….nbo else ….nbb in\l       let (_x_20 : bool) = Is_a(MARKET, _x_16) in\l       let (_x_21 : order_type) = ….1.order_type in\l       let (_x_22 : bool) = Is_a(LIMIT, _x_21) in\l       let (_x_23 : bool) = ….0 = BUY in\l       let (_x_24 : real) = if _x_23 then ….nbo else ….nbb in\l       let (_x_25 : bool) = Is_a(MARKET, _x_21) in\l       let (_x_26 : int)\l           = if (if _x_20 then _x_19 else if _x_17 then … else …) =\l                (if _x_25 then _x_24 else if _x_22 then … else …)\l             then 0 else -1\l       in\l       let (_x_27 : bool) = Is_a(PEGGED, _x_16) in\l       let (_x_28 : bool) = Is_a(PEGGED, _x_21) in\l       let (_x_29 : bool) = ( :var_4: ) = BUY in\l       let (_x_30 : int)\l           = if _x_29\l             then\l               if (if _x_20 then _x_19\l                   else\l                   if _x_17 then if _x_18 then … else …\l                   else if _x_27 then … else …)\l                  \&gt;.\l                  (if _x_25 then _x_24\l                   else\l                   if _x_22 then if _x_23 then … else …\l                   else if _x_28 then … else …)\l               then 1 else _x_26\l             else\l             if (if _x_20 then _x_19\l                 else\l                 if _x_17 then if _x_18 then … else …\l                 else if _x_27 then … else …)\l                \&lt;.\l                (if _x_25 then _x_24\l                 else\l                 if _x_22 then if _x_23 then … else …\l                 else if _x_28 then … else …)\l             then 1 else _x_26\l       in\l       let (_x_31 : order_type) = ( :var_2: ).order_type in\l       let (_x_32 : bool) = _x_31 = PEGGED_CI \|\| _x_31 = LIMIT_CI in\l       let (_x_33 : order_type) = ….1.order_type in\l       let (_x_34 : bool) = Is_a(LIMIT, _x_33) in\l       let (_x_35 : bool) = ….0 = BUY in\l       let (_x_36 : real) = if _x_35 then ….nbo else ….nbb in\l       let (_x_37 : bool) = Is_a(MARKET, _x_33) in\l       let (_x_38 : order_type) = ….1.order_type in\l       let (_x_39 : bool) = Is_a(LIMIT, _x_38) in\l       let (_x_40 : bool) = ….0 = BUY in\l       let (_x_41 : real) = if _x_40 then ….nbo else ….nbb in\l       let (_x_42 : bool) = Is_a(MARKET, _x_38) in\l       let (_x_43 : int)\l           = if (if _x_37 then _x_36 else if _x_34 then … else …) =\l                (if _x_42 then _x_41 else if _x_39 then … else …)\l             then 0 else -1\l       in\l       let (_x_44 : bool) = Is_a(PEGGED, _x_33) in\l       let (_x_45 : bool) = Is_a(PEGGED, _x_38) in\l       let (_x_46 : int)\l           = if _x_29\l             then\l               if (if _x_37 then _x_36\l                   else\l                   if _x_34 then if _x_35 then … else …\l                   else if _x_44 then … else …)\l                  \&gt;.\l                  (if _x_42 then _x_41\l                   else\l                   if _x_39 then if _x_40 then … else …\l                   else if _x_45 then … else …)\l               then 1 else _x_43\l             else\l             if (if _x_37 then _x_36\l                 else\l                 if _x_34 then if _x_35 then … else …\l                 else if _x_44 then … else …)\l                \&lt;.\l                (if _x_42 then _x_41\l                 else\l                 if _x_39 then if _x_40 then … else …\l                 else if _x_45 then … else …)\l             then 1 else _x_43\l       in\l       let (_x_47 : order_type) = ….order_type in\l       let (_x_48 : bool) = Is_a(LIMIT, _x_47) in\l       let (_x_49 : bool) = ….0 = BUY in\l       let (_x_50 : real) = if _x_49 then … else … in\l       let (_x_51 : bool) = Is_a(MARKET, _x_47) in\l       let (_x_52 : order_type) = ….1.order_type in\l       let (_x_53 : bool) = Is_a(LIMIT, _x_52) in\l       let (_x_54 : bool) = ….0 = BUY in\l       let (_x_55 : real) = if _x_54 then ….nbo else ….nbb in\l       let (_x_56 : bool) = Is_a(MARKET, _x_52) in\l       let (_x_57 : int)\l           = if (if _x_51 then _x_50 else if _x_48 then … else …) =\l                (if _x_56 then _x_55 else if _x_53 then … else …)\l             then 0 else -1\l       in\l       let (_x_58 : bool) = Is_a(PEGGED, _x_52) in\l       let (_x_59 : order_type) = ….1.order_type in\l       let (_x_60 : bool) = ….0 = BUY in\l       let (_x_61 : int)\l           = if _x_29\l             then\l               if (if Is_a(MARKET, _x_59)\l                   then if _x_60 then ….nbo else ….nbb\l                   else\l                   if Is_a(LIMIT, _x_59) then if _x_60 then … else …\l                   else if Is_a(PEGGED, _x_59) then … else …)\l                  \&gt;.\l                  (if _x_56 then _x_55\l                   else\l                   if _x_53 then if _x_54 then … else …\l                   else if _x_58 then … else …)\l               then 1 else _x_57\l             else\l             if (if _x_51 then _x_50\l                 else\l                 if _x_48 then if _x_49 then … else …\l                 else if Is_a(PEGGED, _x_47) then … else …)\l                \&lt;.\l                (if _x_56 then _x_55\l                 else\l                 if _x_53 then if _x_54 then … else …\l                 else if _x_58 then … else …)\l             then 1 else _x_57\l       in\l       _x_0 \&lt;= _x_1\l       &amp;&amp; _x_2 \&lt;= _x_3\l          &amp;&amp; _x_4 \&lt;= _x_5\l             &amp;&amp; _x_6 \&gt;= 0\l                &amp;&amp; _x_7 \&gt;= 0\l                   &amp;&amp; _x_8 \&gt;= 0\l                      &amp;&amp; ( :var_0: ).price \&gt;. 0\l                         &amp;&amp; ( :var_1: ).price \&gt;. 0\l                            &amp;&amp; ( :var_2: ).price \&gt;. 0\l                               &amp;&amp; _x_1 \&gt; 0\l                                  &amp;&amp; _x_3 \&gt; 0\l                                     &amp;&amp; _x_5 \&gt; 0\l                                        &amp;&amp; _x_0 \&gt;= 0\l                                           &amp;&amp; _x_2 \&gt;= 0\l                                              &amp;&amp; _x_4 \&gt;= 0\l                                                 &amp;&amp; _x_9 \&gt;. 0\l                                                    &amp;&amp; _x_10 \&gt;. _x_9\l                                                       &amp;&amp; _x_11 \&gt;. _x_10\l                                                          &amp;&amp; ( :var_3: ).l_up\l                                                             \&gt;. _x_11\l       ==\&gt; (if _x_30 = 1 then true\l            else\l            if _x_30 = -1 then false\l            else\l            if _x_13 &amp;&amp; _x_15 then _x_0 \&gt; _x_2\l            else if (if _x_6 \&lt; _x_7 then 1 else …) = 1 then true else …)\l           &amp;&amp; (if _x_46 = 1 then true\l               else\l               if _x_46 = -1 then false\l               else\l               if _x_15 &amp;&amp; _x_32 then _x_2 \&gt; _x_4\l               else\l               if (if _x_7 \&lt; _x_8 then 1 else …) = 1 then true else …)\l           ==\&gt; (if _x_61 = 1 then true\l                else\l                if _x_61 = -1 then false\l                else\l                if _x_13 &amp;&amp; _x_32 then _x_0 \&gt; _x_4\l                else\l                if (if _x_6 \&lt; _x_8 then 1 else …) = 1 then true else …)\l       :time 0.075s)&quot;,shape=box,style=filled,fontname=&quot;courier&quot;,fontsize=14];
p_5 -&gt; p_4 [label=&quot;&quot;];
p_4 [label=&quot;Simplify (let (_x_0 : order_type) = ( :var_0: ).order_type in\l          let (_x_1 : bool) = Is_a(LIMIT, _x_0) in\l          let (_x_2 : bool) = ( :var_4: ) = BUY in\l          let (_x_3 : real)\l              = if _x_2 then ( :var_3: ).nbo else ( :var_3: ).nbb\l          in\l          let (_x_4 : bool) = Is_a(MARKET, _x_0) in\l          let (_x_5 : order_type) = ( :var_2: ).order_type in\l          let (_x_6 : bool) = Is_a(LIMIT, _x_5) in\l          let (_x_7 : bool) = Is_a(MARKET, _x_5) in\l          let (_x_8 : int)\l              = if (if _x_4 then _x_3 else if _x_1 then … else …) =\l                   (if _x_7 then _x_3 else if _x_6 then … else …)\l                then 0 else -1\l          in\l          let (_x_9 : bool) = Is_a(PEGGED, _x_5) \|\| Is_a(PEGGED_CI, _x_5) in\l          let (_x_10 : bool) = Is_a(PEGGED, _x_0) \|\| Is_a(PEGGED_CI, _x_0) in\l          let (_x_11 : int)\l              = if _x_2\l                then\l                  if (if _x_4 then _x_3\l                      else\l                      if _x_1 then if _x_2 then … else …\l                      else if _x_10 then … else …)\l                     \&lt;=.\l                     (if _x_7 then _x_3\l                      else\l                      if _x_6 then if _x_2 then … else …\l                      else if _x_9 then … else …)\l                  then _x_8 else 1\l                else\l                if (if _x_7 then _x_3\l                    else\l                    if _x_6 then if _x_2 then … else …\l                    else if _x_9 then … else …)\l                   \&lt;=.\l                   (if _x_4 then _x_3\l                    else\l                    if _x_1 then if _x_2 then … else …\l                    else if _x_10 then … else …)\l                then _x_8 else 1\l          in\l          let (_x_12 : int) = ( :var_2: ).time in\l          let (_x_13 : int) = ( :var_0: ).time in\l          let (_x_14 : bool) = _x_12 \&lt;= _x_13 in\l          let (_x_15 : bool) = _x_0 = LIMIT_CI \|\| _x_0 = PEGGED_CI in\l          let (_x_16 : bool) = not _x_15 in\l          let (_x_17 : bool) = _x_5 = PEGGED_CI \|\| _x_5 = LIMIT_CI in\l          let (_x_18 : bool) = not _x_17 in\l          let (_x_19 : int) = ( :var_0: ).leaves_qty in\l          let (_x_20 : int) = ( :var_2: ).leaves_qty in\l          let (_x_21 : bool) = not (_x_19 \&lt;= _x_20) in\l          let (_x_22 : order_type) = ( :var_1: ).order_type in\l          let (_x_23 : bool) = Is_a(LIMIT, _x_22) in\l          let (_x_24 : bool) = Is_a(MARKET, _x_22) in\l          let (_x_25 : int)\l              = if (if _x_4 then _x_3 else if _x_1 then … else …) =\l                   (if _x_24 then _x_3 else if _x_23 then … else …)\l                then 0 else -1\l          in\l          let (_x_26 : bool) = Is_a(PEGGED, _x_22) \|\| Is_a(PEGGED_CI, _x_22)\l          in\l          let (_x_27 : int)\l              = if _x_2\l                then\l                  if (if _x_4 then _x_3\l                      else\l                      if _x_1 then if _x_2 then … else …\l                      else if _x_10 then … else …)\l                     \&lt;=.\l                     (if _x_24 then _x_3\l                      else\l                      if _x_23 then if _x_2 then … else …\l                      else if _x_26 then … else …)\l                  then _x_25 else 1\l                else\l                if (if _x_24 then _x_3\l                    else\l                    if _x_23 then if _x_2 then … else …\l                    else if _x_26 then … else …)\l                   \&lt;=.\l                   (if _x_4 then _x_3\l                    else\l                    if _x_1 then if _x_2 then … else …\l                    else if _x_10 then … else …)\l                then _x_25 else 1\l          in\l          let (_x_28 : int) = ( :var_1: ).time in\l          let (_x_29 : bool) = _x_28 \&lt;= _x_13 in\l          let (_x_30 : bool) = _x_22 = LIMIT_CI \|\| _x_22 = PEGGED_CI in\l          let (_x_31 : bool) = not _x_30 in\l          let (_x_32 : int) = ( :var_1: ).leaves_qty in\l          let (_x_33 : bool) = not (_x_19 \&lt;= _x_32) in\l          let (_x_34 : real) = if _x_2 then … else … in\l          let (_x_35 : int)\l              = if (if _x_24 then _x_34 else if _x_23 then … else …) =\l                   (if _x_7 then _x_34 else if _x_6 then … else …)\l                then 0 else -1\l          in\l          let (_x_36 : int)\l              = if (if _x_7 then _x_34\l                    else\l                    if _x_6 then if _x_2 then … else …\l                    else if _x_9 then … else …)\l                   \&lt;=.\l                   (if _x_24 then _x_34\l                    else\l                    if _x_23 then if _x_2 then … else …\l                    else if _x_26 then … else …)\l                then _x_35 else 1\l          in\l          let (_x_37 : bool) = _x_12 \&lt;= _x_28 in\l          let (_x_38 : bool) = not (_x_32 \&lt;= _x_20) in\l          let (_x_39 : int) = ( :var_0: ).qty in\l          let (_x_40 : int) = ( :var_1: ).qty in\l          let (_x_41 : int) = ( :var_2: ).qty in\l          let (_x_42 : real) = ( :var_3: ).l_down in\l          ((_x_11 = 1\l            \|\| not (_x_11 = -1)\l               &amp;&amp; (if _x_15 &amp;&amp; _x_17 then _x_21\l                   else\l                     (not _x_14\l                      \|\| not (_x_14 &amp;&amp; not (_x_13 = _x_12))\l                         &amp;&amp; (_x_16 \|\| not (_x_15 &amp;&amp; _x_18) &amp;&amp; _x_21))))\l           \|\| not\l              ((_x_27 = 1\l                \|\| not (_x_27 = -1)\l                   &amp;&amp; (if _x_15 &amp;&amp; _x_30 then _x_33\l                       else\l                         (not _x_29\l                          \|\| not (_x_29 &amp;&amp; not (_x_13 = _x_28))\l                             &amp;&amp; (_x_16 \|\| not (_x_15 &amp;&amp; _x_31) &amp;&amp; _x_33))))\l               &amp;&amp; ((if _x_2\l                    then\l                      if (if _x_24 then _x_3\l                          else\l                          if _x_23 then if _x_2 then … else …\l                          else if _x_26 then … else …)\l                         \&lt;=.\l                         (if _x_7 then _x_3\l                          else\l                          if _x_6 then if _x_2 then … else …\l                          else if _x_9 then … else …)\l                      then _x_35 else 1\l                    else _x_36)\l                   = 1\l                   \|\| not\l                      ((if _x_2\l                        then\l                          if (if _x_24 then _x_34\l                              else\l                              if _x_23 then if _x_2 then … else …\l                              else if _x_26 then … else …)\l                             \&lt;=.\l                             (if _x_7 then _x_34\l                              else\l                              if _x_6 then if _x_2 then … else …\l                              else if _x_9 then … else …)\l                          then _x_35 else 1\l                        else _x_36)\l                       = -1)\l                      &amp;&amp; (if _x_30 &amp;&amp; _x_17 then _x_38\l                          else\l                            (not _x_37\l                             \|\| not (_x_37 &amp;&amp; not (_x_28 = _x_12))\l                                &amp;&amp; (_x_31 \|\| not (_x_30 &amp;&amp; _x_18) &amp;&amp; _x_38))))))\l          \|\| not\l             ((((((((((((((((((_x_19 \&lt;= _x_39 &amp;&amp; _x_32 \&lt;= _x_40)\l                              &amp;&amp; _x_20 \&lt;= _x_41)\l                             &amp;&amp; _x_13 \&gt;= 0)\l                            &amp;&amp; _x_28 \&gt;= 0)\l                           &amp;&amp; _x_12 \&gt;= 0)\l                          &amp;&amp; not (( :var_0: ).price \&lt;=. 0))\l                         &amp;&amp; not (( :var_1: ).price \&lt;=. 0))\l                        &amp;&amp; not (( :var_2: ).price \&lt;=. 0))\l                       &amp;&amp; not (_x_39 \&lt;= 0))\l                      &amp;&amp; not (_x_40 \&lt;= 0))\l                     &amp;&amp; not (_x_41 \&lt;= 0))\l                    &amp;&amp; _x_19 \&gt;= 0)\l                   &amp;&amp; _x_32 \&gt;= 0)\l                  &amp;&amp; _x_20 \&gt;= 0)\l                 &amp;&amp; not (_x_42 \&lt;=. 0))\l                &amp;&amp; not (… \&lt;=. _x_42))\l               &amp;&amp; not (… \&lt;=. …))\l              &amp;&amp; not (( :var_3: ).l_up \&lt;=. …))\l          :expansions [] :rw [] :fc [])&quot;,shape=box,style=filled,fontname=&quot;courier&quot;,fontsize=14];
p_4 -&gt; p_3 [label=&quot;&quot;];
p_3 [label=&quot;Sat (Some  let (side : order_side) = BUY\l let (o1 : order) =\l  \{id = 9; peg = NEAR; client_id = 10; order_type = PEGGED; qty = 4033;\l   min_qty = 11; leaves_qty = 1596; price = (Real.mk_of_string \&quot;275005/4\&quot;);\l   time = 1; src = 12; order_attr = RESIDENT; capacity = Principal;\l   category = C_ONE;\l   cross_restrict =\l    \{cr_self_cross = false; cr_ubs_principal = false;\l     cr_round_lot_only = false; cr_no_locked_nbbo = false;\l     cr_pegged_mid_point_mode = 8; cr_enable_conditionals = false;\l     cr_min_qty = false;\l     cr_cat_elig =\l      \{c_one_elig = false; c_two_elig = false; c_three_elig = false;\l       c_four_elig = false\}\};\l   locate_found = false; expiry_time = 13\}\l let (o2 : order) =\l  \{id = 16; peg = NEAR; client_id = 17; order_type = PEGGED_CI; qty = 8856;\l   min_qty = 18; leaves_qty = 1595; price = (Real.mk_of_string \&quot;275003/4\&quot;);\l   time = 21240; src = 19; order_attr = RESIDENT; capacity = Principal;\l   category = C_ONE;\l   cross_restrict =\l    \{cr_self_cross = false; cr_ubs_principal = false;\l     cr_round_lot_only = false; cr_no_locked_nbbo = false;\l     cr_pegged_mid_point_mode = 15; cr_enable_conditionals = false;\l     cr_min_qty = false;\l     cr_cat_elig =\l      \{c_one_elig = false; c_two_elig = false; c_three_elig = false;\l       c_four_elig = false\}\};\l   locate_found = false; expiry_time = 20\}\l let (o3 : order) =\l  \{id = 3; peg = NO_PEG; client_id = 4; order_type = LIMIT_CI; qty = 11798;\l   min_qty = 5; leaves_qty = 1594; price = (Real.mk_of_string \&quot;275003/4\&quot;);\l   time = 0; src = 6; order_attr = RESIDENT; capacity = Principal;\l   category = C_ONE;\l   cross_restrict =\l    \{cr_self_cross = false; cr_ubs_principal = false;\l     cr_round_lot_only = false; cr_no_locked_nbbo = false;\l     cr_pegged_mid_point_mode = 2; cr_enable_conditionals = false;\l     cr_min_qty = false;\l     cr_cat_elig =\l      \{c_one_elig = false; c_two_elig = false; c_three_elig = false;\l       c_four_elig = false\}\};\l   locate_found = false; expiry_time = 7\}\l let (mkt : mkt_data) =\l  \{nbb = (Real.mk_of_string \&quot;275003/4\&quot;); nbo = 68751.0;\l   l_up = (Real.mk_of_string \&quot;308465/4\&quot;);\l   l_down = (Real.mk_of_string \&quot;137501/2\&quot;)\}\l)&quot;,shape=box,style=filled,fontname=&quot;courier&quot;,fontsize=14];
}
</textarea><button class="btn btn-primary">Load graph</button><div class="imandra-graphviz-loading display-none">Loading..</div><div class="imandra-graphviz-target"></div><script>
require(['nbextensions/nbimandra/graphviz'], function (graphviz) {
  var target = '#graphviz-486f3022-88af-4b4d-a8f8-176a1fbecc05';
  graphviz.hydrate(target);
});
</script></div></div></div><script>
require(['nbextensions/nbimandra/alternatives'], function (alternatives) {
  var target = '#alt-88acf5f6-974b-4cc8-8ab8-f5057134ba30';
  alternatives.hydrate(target);
});
</script></div></div></div><script>
require(['nbextensions/nbimandra/fold'], function (fold) {
  var target = '#fold-a69cad80-c6d8-4e2b-917f-ec6175928496';
  fold.hydrate(target);
});
</script></div></div></div></div><script>
require(['nbextensions/nbimandra/alternatives'], function (alternatives) {
  var target = '#alt-c75b4418-0a69-4a99-bdf1-5bb85c82b4cf';
  alternatives.hydrate(target);
});
</script></div></div></div>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><h1 id="Extending-the-model-with-Document-printers">Extending the model with Document printers<a class="anchor-link" href="#Extending-the-model-with-Document-printers">&#182;</a></h1><p>Let's define a few more custom document printers to make these (complex!) counterexamples easier to understand.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="try-this-container">
  <a href="https://try.imandra.ai/launch/?next=/h/user-redirect/notebooks/Analysing%20the%20UBS%20ATS%20Dark%20Pool.ipynb%23try-cell-48" target="_blank" rel="nofollow">
    <div class="try-this">Try this!</div>
  </a>
</div>
<div class="input">
<div class="prompt input_prompt">In&nbsp;[26]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ocaml"><pre><span></span><span class="c">(* We can generate string printers for our types automatically using the pp plugin *)</span>
<span class="nn">Imandra</span><span class="p">.</span><span class="n">add_plugin_pp</span> <span class="bp">()</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">doc_of_order_type</span> <span class="n">o</span> <span class="o">=</span>
  <span class="nn">Document</span><span class="p">.</span><span class="n">s</span> <span class="o">@@</span> <span class="nn">CCFormat</span><span class="p">.</span><span class="n">to_string</span> <span class="n">pp_order_type</span> <span class="n">o</span>
<span class="o">[@@</span><span class="n">program</span><span class="o">];;</span>

<span class="o">#</span><span class="n">install_doc</span> <span class="n">doc_of_order_type</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">doc_of_order</span> <span class="n">o</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">module</span> <span class="nc">D</span> <span class="o">=</span> <span class="nc">Document</span> <span class="k">in</span>
  <span class="nn">D</span><span class="p">.</span><span class="n">indent</span> <span class="s2">&quot;order&quot;</span> <span class="o">@@</span> <span class="nn">D</span><span class="p">.</span><span class="n">record</span> <span class="o">[</span>
      <span class="s2">&quot;id&quot;</span><span class="o">,</span> <span class="nn">D</span><span class="p">.</span><span class="n">bigint</span> <span class="n">o</span><span class="o">.</span><span class="n">id</span><span class="o">;</span>
      <span class="s2">&quot;peg&quot;</span><span class="o">,</span> <span class="nn">D</span><span class="p">.</span><span class="n">s</span> <span class="o">@@</span> <span class="nn">CCFormat</span><span class="p">.</span><span class="n">to_string</span> <span class="n">pp_order_peg</span> <span class="n">o</span><span class="o">.</span><span class="n">peg</span><span class="o">;</span>
      <span class="s2">&quot;client_id&quot;</span><span class="o">,</span> <span class="nn">D</span><span class="p">.</span><span class="n">bigint</span> <span class="n">o</span><span class="o">.</span><span class="n">client_id</span><span class="o">;</span>
      <span class="s2">&quot;order_type&quot;</span><span class="o">,</span> <span class="nn">D</span><span class="p">.</span><span class="n">s</span> <span class="o">@@</span> <span class="nn">CCFormat</span><span class="p">.</span><span class="n">to_string</span> <span class="n">pp_order_type</span> <span class="n">o</span><span class="o">.</span><span class="n">order_type</span><span class="o">;</span>
      <span class="s2">&quot;qty&quot;</span><span class="o">,</span> <span class="nn">D</span><span class="p">.</span><span class="n">bigint</span> <span class="n">o</span><span class="o">.</span><span class="n">qty</span><span class="o">;</span>
      <span class="s2">&quot;min_qty&quot;</span><span class="o">,</span> <span class="nn">D</span><span class="p">.</span><span class="n">bigint</span> <span class="n">o</span><span class="o">.</span><span class="n">min_qty</span><span class="o">;</span>
      <span class="s2">&quot;leaves_qty&quot;</span><span class="o">,</span> <span class="nn">D</span><span class="p">.</span><span class="n">bigint</span> <span class="n">o</span><span class="o">.</span><span class="n">leaves_qty</span><span class="o">;</span>
      <span class="s2">&quot;price&quot;</span><span class="o">,</span> <span class="nn">D</span><span class="p">.</span><span class="n">s</span> <span class="o">@@</span> <span class="nn">Real</span><span class="p">.</span><span class="n">to_string_approx</span> <span class="n">o</span><span class="o">.</span><span class="n">price</span><span class="o">;</span>
      <span class="s2">&quot;time&quot;</span><span class="o">,</span> <span class="nn">D</span><span class="p">.</span><span class="n">s</span> <span class="o">@@</span> <span class="nn">CCFormat</span><span class="p">.</span><span class="n">to_string</span> <span class="n">pp_time</span> <span class="n">o</span><span class="o">.</span><span class="n">time</span><span class="o">;</span>
      <span class="s2">&quot;src&quot;</span><span class="o">,</span> <span class="nn">D</span><span class="p">.</span><span class="n">s</span> <span class="o">@@</span> <span class="nn">CCFormat</span><span class="p">.</span><span class="n">to_string</span> <span class="n">pp_order_source</span> <span class="n">o</span><span class="o">.</span><span class="n">src</span><span class="o">;</span>
      <span class="s2">&quot;order_attr&quot;</span><span class="o">,</span> <span class="nn">D</span><span class="p">.</span><span class="n">s</span> <span class="o">@@</span> <span class="nn">CCFormat</span><span class="p">.</span><span class="n">to_string</span> <span class="n">pp_order_attr</span> <span class="n">o</span><span class="o">.</span><span class="n">order_attr</span><span class="o">;</span>
      <span class="s2">&quot;capacity&quot;</span><span class="o">,</span> <span class="nn">D</span><span class="p">.</span><span class="n">s</span> <span class="o">@@</span> <span class="nn">CCFormat</span><span class="p">.</span><span class="n">to_string</span> <span class="n">pp_capacity</span> <span class="n">o</span><span class="o">.</span><span class="n">capacity</span><span class="o">;</span>
      <span class="s2">&quot;category&quot;</span><span class="o">,</span> <span class="nn">D</span><span class="p">.</span><span class="n">s</span> <span class="o">@@</span> <span class="nn">CCFormat</span><span class="p">.</span><span class="n">to_string</span> <span class="n">pp_category</span> <span class="n">o</span><span class="o">.</span><span class="n">category</span><span class="o">;</span>
      <span class="c">(* &quot;cross_restrict&quot;, D.s @@ CCFormat.to_string pp_cross_restrict o.cross_restrict; *)</span>
      <span class="s2">&quot;locate_found&quot;</span><span class="o">,</span> <span class="nn">D</span><span class="p">.</span><span class="n">s_f</span> <span class="s2">&quot;%B&quot;</span> <span class="n">o</span><span class="o">.</span><span class="n">locate_found</span><span class="o">;</span>
      <span class="s2">&quot;expiry_time&quot;</span><span class="o">,</span> <span class="nn">D</span><span class="p">.</span><span class="n">bigint</span> <span class="n">o</span><span class="o">.</span><span class="n">expiry_time</span><span class="o">;</span>
  <span class="o">]</span>
<span class="o">[@@</span><span class="n">program</span><span class="o">];;</span>

<span class="o">#</span><span class="n">install_doc</span> <span class="n">doc_of_order</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">doc_of_side</span> <span class="n">side</span> <span class="o">=</span> <span class="nn">Document</span><span class="p">.</span><span class="n">s</span> <span class="o">@@</span> <span class="nn">CCFormat</span><span class="p">.</span><span class="n">to_string</span> <span class="n">pp_order_side</span> <span class="n">side</span>
<span class="o">[@@</span><span class="n">program</span><span class="o">];;</span>

<span class="o">#</span><span class="n">install_doc</span> <span class="n">doc_of_side</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">doc_of_mkt</span> <span class="n">mkt</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">module</span> <span class="nc">D</span> <span class="o">=</span> <span class="nc">Document</span> <span class="k">in</span>
  <span class="nn">D</span><span class="p">.</span><span class="n">indent</span> <span class="s2">&quot;mkt&quot;</span> <span class="o">@@</span> <span class="nn">D</span><span class="p">.</span><span class="n">record</span> <span class="o">[</span>
      <span class="s2">&quot;nbb&quot;</span><span class="o">,</span> <span class="nn">D</span><span class="p">.</span><span class="n">s</span> <span class="o">@@</span> <span class="nn">Real</span><span class="p">.</span><span class="n">to_string_approx</span> <span class="n">mkt</span><span class="o">.</span><span class="n">nbb</span><span class="o">;</span>
      <span class="s2">&quot;nbo&quot;</span><span class="o">,</span> <span class="nn">D</span><span class="p">.</span><span class="n">s</span> <span class="o">@@</span> <span class="nn">Real</span><span class="p">.</span><span class="n">to_string_approx</span> <span class="n">mkt</span><span class="o">.</span><span class="n">nbo</span><span class="o">;</span>
      <span class="s2">&quot;l_up&quot;</span><span class="o">,</span> <span class="nn">D</span><span class="p">.</span><span class="n">s</span> <span class="o">@@</span> <span class="nn">Real</span><span class="p">.</span><span class="n">to_string_approx</span> <span class="n">mkt</span><span class="o">.</span><span class="n">l_up</span><span class="o">;</span>
      <span class="s2">&quot;l_down&quot;</span><span class="o">,</span> <span class="nn">D</span><span class="p">.</span><span class="n">s</span> <span class="o">@@</span> <span class="nn">Real</span><span class="p">.</span><span class="n">to_string_approx</span> <span class="n">mkt</span><span class="o">.</span><span class="n">l_down</span><span class="o">;</span>
  <span class="o">]</span>
<span class="o">[@@</span><span class="n">program</span><span class="o">];;</span>

<span class="k">let</span> <span class="n">pp_rank</span> <span class="o">(</span><span class="n">side</span><span class="o">,</span> <span class="n">o1</span><span class="o">,</span> <span class="n">o2</span><span class="o">,</span> <span class="n">o3</span><span class="o">,</span> <span class="n">mkt</span><span class="o">)</span> <span class="o">=</span>
  <span class="nn">Document</span><span class="p">.</span><span class="o">(</span><span class="n">tbl</span> <span class="o">~</span><span class="n">headers</span><span class="o">:[</span><span class="s2">&quot;side&quot;</span><span class="o">;</span><span class="s2">&quot;order1&quot;</span><span class="o">;</span><span class="s2">&quot;order2&quot;</span><span class="o">;</span><span class="s2">&quot;order3&quot;</span><span class="o">;</span><span class="s2">&quot;mkt&quot;</span><span class="o">]</span>
    <span class="o">@@</span> <span class="o">[[</span><span class="n">doc_of_side</span> <span class="n">side</span><span class="o">;</span> <span class="n">doc_of_order</span> <span class="n">o1</span><span class="o">;</span> <span class="n">doc_of_order</span> <span class="n">o2</span><span class="o">;</span> <span class="n">doc_of_order</span> <span class="n">o3</span><span class="o">;</span> <span class="n">doc_of_mkt</span> <span class="n">mkt</span><span class="o">]])</span>
 <span class="o">[@@</span><span class="n">program</span><span class="o">];;</span>

<span class="o">#</span><span class="n">install_doc</span> <span class="n">pp_rank</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[26]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>- : unit = ()
val doc_of_order_type : order_type -&gt; Document.t = &lt;fun&gt;
val doc_of_order : order -&gt; Document.t = &lt;fun&gt;
val doc_of_side : order_side -&gt; Document.t = &lt;fun&gt;
val doc_of_mkt : mkt_data -&gt; Document.t = &lt;fun&gt;
val pp_rank : order_side * order * order * order * mkt_data -&gt; Document.t =
  &lt;fun&gt;
</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html"><p>Now, let's view our latest counterexample again:</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="try-this-container">
  <a href="https://try.imandra.ai/launch/?next=/h/user-redirect/notebooks/Analysing%20the%20UBS%20ATS%20Dark%20Pool.ipynb%23try-cell-50" target="_blank" rel="nofollow">
    <div class="try-this">Try this!</div>
  </a>
</div>
<div class="input">
<div class="prompt input_prompt">In&nbsp;[27]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ocaml"><pre><span></span><span class="nn">CX</span><span class="p">.</span><span class="o">(</span><span class="n">side</span><span class="o">,</span> <span class="n">o1</span><span class="o">,</span> <span class="n">o2</span><span class="o">,</span> <span class="n">o3</span><span class="o">,</span> <span class="n">mkt</span><span class="o">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area">

<div class="prompt output_prompt">Out[27]:</div>




<div class="output_text output_subarea output_execute_result">
<pre>- : order_side * order * order * order * mkt_data = &lt;document&gt;
</pre>
</div>

</div>

<div class="output_area">

<div class="prompt"></div>



<div class="output_html rendered_html output_subarea ">
<div><div class="imandra-table" id="table-37da16ab-f22d-464a-a99d-df852b8aa44e"><table><thead><tr><th>side</th><th>order1</th><th>order2</th><th>order3</th><th>mkt</th></tr></thead><tr><td>BUY</td><td><div><h5>order</h5><div class="imandra-table" id="table-1bfbeb81-75d7-4b0a-930f-cd26c138efbd"><table><tr><td><b>id</b></td><td>9</td></tr><tr><td><b>peg</b></td><td>NEAR</td></tr><tr><td><b>client_id</b></td><td>10</td></tr><tr><td><b>order_type</b></td><td>PEGGED</td></tr><tr><td><b>qty</b></td><td>4033</td></tr><tr><td><b>min_qty</b></td><td>11</td></tr><tr><td><b>leaves_qty</b></td><td>1596</td></tr><tr><td><b>price</b></td><td>68751.25</td></tr><tr><td><b>time</b></td><td>1</td></tr><tr><td><b>src</b></td><td>12</td></tr><tr><td><b>order_attr</b></td><td>RESIDENT</td></tr><tr><td><b>capacity</b></td><td>Principal</td></tr><tr><td><b>category</b></td><td>C_ONE</td></tr><tr><td><b>locate_found</b></td><td>false</td></tr><tr><td><b>expiry_time</b></td><td>13</td></tr></table></div></div></td><td><div><h5>order</h5><div class="imandra-table" id="table-540ed3af-b4c4-495c-88d1-7141827fc92b"><table><tr><td><b>id</b></td><td>16</td></tr><tr><td><b>peg</b></td><td>NEAR</td></tr><tr><td><b>client_id</b></td><td>17</td></tr><tr><td><b>order_type</b></td><td>PEGGED_CI</td></tr><tr><td><b>qty</b></td><td>8856</td></tr><tr><td><b>min_qty</b></td><td>18</td></tr><tr><td><b>leaves_qty</b></td><td>1595</td></tr><tr><td><b>price</b></td><td>68750.75</td></tr><tr><td><b>time</b></td><td>21240</td></tr><tr><td><b>src</b></td><td>19</td></tr><tr><td><b>order_attr</b></td><td>RESIDENT</td></tr><tr><td><b>capacity</b></td><td>Principal</td></tr><tr><td><b>category</b></td><td>C_ONE</td></tr><tr><td><b>locate_found</b></td><td>false</td></tr><tr><td><b>expiry_time</b></td><td>20</td></tr></table></div></div></td><td><div><h5>order</h5><div class="imandra-table" id="table-69e25918-4ec5-4dd0-b19d-1f2c7174e2a5"><table><tr><td><b>id</b></td><td>3</td></tr><tr><td><b>peg</b></td><td>NO_PEG</td></tr><tr><td><b>client_id</b></td><td>4</td></tr><tr><td><b>order_type</b></td><td>LIMIT_CI</td></tr><tr><td><b>qty</b></td><td>11798</td></tr><tr><td><b>min_qty</b></td><td>5</td></tr><tr><td><b>leaves_qty</b></td><td>1594</td></tr><tr><td><b>price</b></td><td>68750.75</td></tr><tr><td><b>time</b></td><td>0</td></tr><tr><td><b>src</b></td><td>6</td></tr><tr><td><b>order_attr</b></td><td>RESIDENT</td></tr><tr><td><b>capacity</b></td><td>Principal</td></tr><tr><td><b>category</b></td><td>C_ONE</td></tr><tr><td><b>locate_found</b></td><td>false</td></tr><tr><td><b>expiry_time</b></td><td>7</td></tr></table></div></div></td><td><div><h5>mkt</h5><div class="imandra-table" id="table-3099ac81-1732-4dab-ad69-36a8a08ba617"><table><tr><td><b>nbb</b></td><td>68750.75</td></tr><tr><td><b>nbo</b></td><td>68751.</td></tr><tr><td><b>l_up</b></td><td>77116.25</td></tr><tr><td><b>l_down</b></td><td>68750.5</td></tr></table></div></div></td></tr></table></div></div>

</div>

</div>

</div>
</div>

</div>
                    </div>
                </article>
            </main>
            <footer class="footer">
                <a class="copyrights"href="http://imandra.ai">&#9400; 2018 - 2021 Imandra Inc. All rights reserved.</a>
            </footer>
        </div>
    



    <script>
    (function () {
            var lastId;
            var sideMenu = $("#side-nav-menu");
            var topMenu = $("#top-menu");
            var topMenuHeight = topMenu.outerHeight() + 15;

            // All list items
            var menuItems = sideMenu.find('a.side__nav-link--within-page');

            // Anchors corresponding to menu items
            var scrollItems = menuItems.map(function () {
              var item = $(this).attr("href");
              var thisItem = item.substring(item.lastIndexOf("#") + 1, item.length);
              var linkedItem = $('#' + CSS.escape(thisItem));
              if (linkedItem.length) { return linkedItem; }
            });

            // Bind to scroll
            $(window).scroll(function () {
                // Get container scroll position
                var fromTop = $(this).scrollTop() + topMenuHeight;;
                // Get id of current scroll item
                var cur = scrollItems.map(function () {
                    if ($(this).offset().top < fromTop)
                        return this;
                });
                cur = cur[cur.length - 1];
                // Get the id of the current element
                var id = cur && cur.length ? cur[0].id : "";
                if (id && lastId !== id) {
                    lastId = id;
                    // Set/remove active class
                    menuItems.each(function (idx, item) {
                    var $item = $(item);
                    $item.removeClass("side__nav-link--within-page--active");

                    if (item.href.endsWith('#' + lastId)) {
                        $item.addClass("side__nav-link--within-page--active");
                    };
                    });
                }
            });
        })()
    </script>
    <script type="text/javascript"> docsearch({
      apiKey: 'ff3a61a82b58783e62ebfbf51e50b0bc',
      indexName: 'imandra',
      inputSelector: '#search',
      debug: false // Set debug to true if you want to inspect the dropdown
    });
    </script>

    </body>
</html>
